{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/middlewares/oauth.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/middlewares/oauth.ts"],"sourcesContent":["import { defineRequestState } from \"@better-auth/core/context\";\n\ntype OAuthState = {\n\tcallbackURL: string;\n\tcodeVerifier: string;\n\terrorURL?: string;\n\tnewUserURL?: string;\n\tlink?: {\n\t\temail: string;\n\t\tuserId: string;\n\t};\n\texpiresAt: number;\n\trequestSignUp?: boolean;\n\t[key: string]: any;\n};\n\nconst {\n\tget: getOAuthState,\n\t/**\n\t * @internal This is unsafe to be used directly. Use setOAuthState instead.\n\t */\n\tset: setOAuthState,\n} = defineRequestState<OAuthState | null>(() => null);\n\nexport { getOAuthState, setOAuthState };\n"],"names":[],"mappings":";;;;;;;;;;AAgBA,MAAM,EACL,KAAK,aAAA,EAIL,KAAK,aAAA,EAAA,OACF,wMAAA,EAAA,IAA4C,KAAK"}},
    {"offset": {"line": 21, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/middlewares/origin-check.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/middlewares/origin-check.ts"],"sourcesContent":["import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { createAuthMiddleware } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { deprecate, normalizePathname } from \"@better-auth/core/utils\";\nimport { APIError } from \"better-call\";\nimport { matchesOriginPattern } from \"../../auth/trusted-origins\";\n\n/**\n * Checks if CSRF should be skipped for backward compatibility.\n * Previously, disableOriginCheck also disabled CSRF checks.\n * This maintains that behavior when disableCSRFCheck isn't explicitly set.\n * Only triggers for skipOriginCheck === true, not for path arrays.\n */\nfunction shouldSkipCSRFForBackwardCompat(ctx: GenericEndpointContext): boolean {\n\treturn (\n\t\tctx.context.skipOriginCheck === true &&\n\t\tctx.context.options.advanced?.disableCSRFCheck === undefined\n\t);\n}\n\n/**\n * Logs deprecation warning for users relying on coupled behavior.\n * Only logs if user explicitly set disableOriginCheck (not test environment default).\n */\nconst logBackwardCompatWarning = deprecate(\n\tfunction logBackwardCompatWarning() {},\n\t\"disableOriginCheck: true currently also disables CSRF checks. \" +\n\t\t\"In a future version, disableOriginCheck will ONLY disable URL validation. \" +\n\t\t\"To keep CSRF disabled, add disableCSRFCheck: true to your config.\",\n);\n\n/**\n * A middleware to validate callbackURL and origin against trustedOrigins.\n * Also handles CSRF protection using Fetch Metadata for first-login scenarios.\n */\nexport const originCheckMiddleware = createAuthMiddleware(async (ctx) => {\n\t// Skip origin check for GET, OPTIONS, HEAD requests - we don't mutate state here.\n\tif (\n\t\tctx.request?.method === \"GET\" ||\n\t\tctx.request?.method === \"OPTIONS\" ||\n\t\tctx.request?.method === \"HEAD\" ||\n\t\t!ctx.request\n\t) {\n\t\treturn;\n\t}\n\tawait validateOrigin(ctx);\n\n\tif (ctx.context.skipOriginCheck) {\n\t\treturn;\n\t}\n\n\tconst { body, query } = ctx;\n\tconst callbackURL = body?.callbackURL || query?.callbackURL;\n\tconst redirectURL = body?.redirectTo;\n\tconst errorCallbackURL = body?.errorCallbackURL;\n\tconst newUserCallbackURL = body?.newUserCallbackURL;\n\n\tconst validateURL = (url: string | undefined, label: string) => {\n\t\tif (!url) {\n\t\t\treturn;\n\t\t}\n\t\tconst isTrustedOrigin = ctx.context.isTrustedOrigin(url, {\n\t\t\tallowRelativePaths: label !== \"origin\",\n\t\t});\n\n\t\tif (!isTrustedOrigin) {\n\t\t\tctx.context.logger.error(`Invalid ${label}: ${url}`);\n\t\t\tctx.context.logger.info(\n\t\t\t\t`If it's a valid URL, please add ${url} to trustedOrigins in your auth config\\n`,\n\t\t\t\t`Current list of trustedOrigins: ${ctx.context.trustedOrigins}`,\n\t\t\t);\n\t\t\tthrow new APIError(\"FORBIDDEN\", { message: `Invalid ${label}` });\n\t\t}\n\t};\n\n\tcallbackURL && validateURL(callbackURL, \"callbackURL\");\n\tredirectURL && validateURL(redirectURL, \"redirectURL\");\n\terrorCallbackURL && validateURL(errorCallbackURL, \"errorCallbackURL\");\n\tnewUserCallbackURL && validateURL(newUserCallbackURL, \"newUserCallbackURL\");\n});\n\nexport const originCheck = (\n\tgetValue: (ctx: GenericEndpointContext) => string | string[],\n) =>\n\tcreateAuthMiddleware(async (ctx) => {\n\t\tif (!ctx.request) {\n\t\t\treturn;\n\t\t}\n\t\tif (ctx.context.skipOriginCheck) {\n\t\t\treturn;\n\t\t}\n\t\tconst callbackURL = getValue(ctx);\n\t\tconst validateURL = (url: string | undefined, label: string) => {\n\t\t\tif (!url) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst isTrustedOrigin = ctx.context.isTrustedOrigin(url, {\n\t\t\t\tallowRelativePaths: label !== \"origin\",\n\t\t\t});\n\n\t\t\tif (!isTrustedOrigin) {\n\t\t\t\tctx.context.logger.error(`Invalid ${label}: ${url}`);\n\t\t\t\tctx.context.logger.info(\n\t\t\t\t\t`If it's a valid URL, please add ${url} to trustedOrigins in your auth config\\n`,\n\t\t\t\t\t`Current list of trustedOrigins: ${ctx.context.trustedOrigins}`,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", { message: `Invalid ${label}` });\n\t\t\t}\n\t\t};\n\t\tconst callbacks = Array.isArray(callbackURL) ? callbackURL : [callbackURL];\n\t\tfor (const url of callbacks) {\n\t\t\tvalidateURL(url, \"callbackURL\");\n\t\t}\n\t});\n\n/**\n * Validates origin header against trusted origins.\n * @param ctx - The endpoint context\n * @param forceValidate - If true, always validate origin regardless of cookies/skip flags\n */\nasync function validateOrigin(\n\tctx: GenericEndpointContext,\n\tforceValidate = false,\n): Promise<void> {\n\tconst headers = ctx.request?.headers;\n\tif (!headers || !ctx.request) {\n\t\treturn;\n\t}\n\tconst originHeader = headers.get(\"origin\") || headers.get(\"referer\") || \"\";\n\tconst useCookies = headers.has(\"cookie\");\n\n\tif (ctx.context.skipCSRFCheck) {\n\t\treturn;\n\t}\n\n\tif (shouldSkipCSRFForBackwardCompat(ctx)) {\n\t\tctx.context.options.advanced?.disableOriginCheck === true &&\n\t\t\tlogBackwardCompatWarning();\n\t\treturn;\n\t}\n\n\tconst skipOriginCheck = ctx.context.skipOriginCheck;\n\tif (Array.isArray(skipOriginCheck)) {\n\t\ttry {\n\t\t\tconst basePath = new URL(ctx.context.baseURL).pathname;\n\t\t\tconst currentPath = normalizePathname(ctx.request.url, basePath);\n\t\t\tconst shouldSkipPath = skipOriginCheck.some((skipPath) =>\n\t\t\t\tcurrentPath.startsWith(skipPath),\n\t\t\t);\n\t\t\tif (shouldSkipPath) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t} catch {\n\t\t\t// If parsing fails, don't skip - continue with validation\n\t\t}\n\t}\n\n\tconst shouldValidate = forceValidate || useCookies;\n\n\tif (!shouldValidate) {\n\t\treturn;\n\t}\n\n\tif (!originHeader || originHeader === \"null\") {\n\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\tmessage: BASE_ERROR_CODES.MISSING_OR_NULL_ORIGIN,\n\t\t});\n\t}\n\n\tconst trustedOrigins: string[] = Array.isArray(\n\t\tctx.context.options.trustedOrigins,\n\t)\n\t\t? ctx.context.trustedOrigins\n\t\t: [\n\t\t\t\t...ctx.context.trustedOrigins,\n\t\t\t\t...((await ctx.context.options.trustedOrigins?.(ctx.request))?.filter(\n\t\t\t\t\t(v): v is string => Boolean(v),\n\t\t\t\t) || []),\n\t\t\t];\n\n\tconst isTrustedOrigin = trustedOrigins.some((origin) =>\n\t\tmatchesOriginPattern(originHeader, origin),\n\t);\n\tif (!isTrustedOrigin) {\n\t\tctx.context.logger.error(`Invalid origin: ${originHeader}`);\n\t\tctx.context.logger.info(\n\t\t\t`If it's a valid URL, please add ${originHeader} to trustedOrigins in your auth config\\n`,\n\t\t\t`Current list of trustedOrigins: ${trustedOrigins}`,\n\t\t);\n\t\tthrow new APIError(\"FORBIDDEN\", { message: \"Invalid origin\" });\n\t}\n}\n\n/**\n * Middleware for CSRF protection using Fetch Metadata headers.\n * This prevents cross-site navigation login attacks while supporting progressive enhancement.\n */\nexport const formCsrfMiddleware = createAuthMiddleware(async (ctx) => {\n\tconst request = ctx.request;\n\tif (!request) {\n\t\treturn;\n\t}\n\n\tawait validateFormCsrf(ctx);\n});\n\n/**\n * Validates CSRF protection for first-login scenarios using Fetch Metadata headers.\n * This prevents cross-site form submission attacks while supporting progressive enhancement.\n */\nasync function validateFormCsrf(ctx: GenericEndpointContext): Promise<void> {\n\tconst req = ctx.request;\n\tif (!req) {\n\t\treturn;\n\t}\n\n\tif (ctx.context.skipCSRFCheck) {\n\t\treturn;\n\t}\n\n\tif (shouldSkipCSRFForBackwardCompat(ctx)) {\n\t\treturn;\n\t}\n\n\tconst headers = req.headers;\n\tconst hasAnyCookies = headers.has(\"cookie\");\n\n\tif (hasAnyCookies) {\n\t\treturn await validateOrigin(ctx);\n\t}\n\n\tconst site = headers.get(\"Sec-Fetch-Site\");\n\tconst mode = headers.get(\"Sec-Fetch-Mode\");\n\tconst dest = headers.get(\"Sec-Fetch-Dest\");\n\n\tconst hasMetadata = Boolean(\n\t\t(site && site.trim()) || (mode && mode.trim()) || (dest && dest.trim()),\n\t);\n\n\tif (hasMetadata) {\n\t\t// Block cross-site navigation requests (classic CSRF attack pattern)\n\t\tif (site === \"cross-site\" && mode === \"navigate\") {\n\t\t\tctx.context.logger.error(\n\t\t\t\t\"Blocked cross-site navigation login attempt (CSRF protection)\",\n\t\t\t\t{\n\t\t\t\t\tsecFetchSite: site,\n\t\t\t\t\tsecFetchMode: mode,\n\t\t\t\t\tsecFetchDest: dest,\n\t\t\t\t},\n\t\t\t);\n\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.CROSS_SITE_NAVIGATION_LOGIN_BLOCKED,\n\t\t\t});\n\t\t}\n\n\t\treturn await validateOrigin(ctx, true);\n\t}\n\n\t// No cookies, no Fetch Metadata â†’ fallback to old behavior (no validation)\n\treturn;\n}\n"],"names":["logBackwardCompatWarning","trustedOrigins: string[]"],"mappings":"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"}},
    {"offset": {"line": 182, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/dist/api/middlewares/index.mjs"],"sourcesContent":["import { getOAuthState } from \"./oauth.mjs\";\nimport { formCsrfMiddleware, originCheck, originCheckMiddleware } from \"./origin-check.mjs\";\n\nexport {  };"],"names":[],"mappings":";AAAA;AACA","ignoreList":[0]}},
    {"offset": {"line": 192, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/rate-limiter/index.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/rate-limiter/index.ts"],"sourcesContent":["import type {\n\tAuthContext,\n\tBetterAuthRateLimitStorage,\n} from \"@better-auth/core\";\nimport {\n\tcreateRateLimitKey,\n\tnormalizePathname,\n\tsafeJSONParse,\n} from \"@better-auth/core/utils\";\nimport type { RateLimit } from \"../../types\";\nimport { getIp } from \"../../utils/get-request-ip\";\nimport { wildcardMatch } from \"../../utils/wildcard\";\n\ninterface MemoryRateLimitEntry {\n\tdata: RateLimit;\n\texpiresAt: number;\n}\n\nconst memory = new Map<string, MemoryRateLimitEntry>();\n\nfunction shouldRateLimit(\n\tmax: number,\n\twindow: number,\n\trateLimitData: RateLimit,\n) {\n\tconst now = Date.now();\n\tconst windowInMs = window * 1000;\n\tconst timeSinceLastRequest = now - rateLimitData.lastRequest;\n\treturn timeSinceLastRequest < windowInMs && rateLimitData.count >= max;\n}\n\nfunction rateLimitResponse(retryAfter: number) {\n\treturn new Response(\n\t\tJSON.stringify({\n\t\t\tmessage: \"Too many requests. Please try again later.\",\n\t\t}),\n\t\t{\n\t\t\tstatus: 429,\n\t\t\tstatusText: \"Too Many Requests\",\n\t\t\theaders: {\n\t\t\t\t\"X-Retry-After\": retryAfter.toString(),\n\t\t\t},\n\t\t},\n\t);\n}\n\nfunction getRetryAfter(lastRequest: number, window: number) {\n\tconst now = Date.now();\n\tconst windowInMs = window * 1000;\n\treturn Math.ceil((lastRequest + windowInMs - now) / 1000);\n}\n\nfunction createDatabaseStorageWrapper(\n\tctx: AuthContext,\n): BetterAuthRateLimitStorage {\n\tconst model = \"rateLimit\";\n\tconst db = ctx.adapter;\n\treturn {\n\t\tget: async (key: string) => {\n\t\t\tconst res = await db.findMany<RateLimit>({\n\t\t\t\tmodel,\n\t\t\t\twhere: [{ field: \"key\", value: key }],\n\t\t\t});\n\t\t\tconst data = res[0];\n\n\t\t\tif (typeof data?.lastRequest === \"bigint\") {\n\t\t\t\tdata.lastRequest = Number(data.lastRequest);\n\t\t\t}\n\n\t\t\treturn data;\n\t\t},\n\t\tset: async (\n\t\t\tkey: string,\n\t\t\tvalue: RateLimit,\n\t\t\t_update?: boolean | undefined,\n\t\t) => {\n\t\t\ttry {\n\t\t\t\tif (_update) {\n\t\t\t\t\tawait db.updateMany({\n\t\t\t\t\t\tmodel,\n\t\t\t\t\t\twhere: [{ field: \"key\", value: key }],\n\t\t\t\t\t\tupdate: {\n\t\t\t\t\t\t\tcount: value.count,\n\t\t\t\t\t\t\tlastRequest: value.lastRequest,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tawait db.create({\n\t\t\t\t\t\tmodel,\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\tcount: value.count,\n\t\t\t\t\t\t\tlastRequest: value.lastRequest,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tctx.logger.error(\"Error setting rate limit\", e);\n\t\t\t}\n\t\t},\n\t};\n}\n\nfunction getRateLimitStorage(\n\tctx: AuthContext,\n\trateLimitSettings: {\n\t\twindow: number;\n\t},\n): BetterAuthRateLimitStorage {\n\tif (ctx.options.rateLimit?.customStorage) {\n\t\treturn ctx.options.rateLimit.customStorage;\n\t}\n\tconst storage = ctx.rateLimit.storage;\n\tif (storage === \"secondary-storage\") {\n\t\treturn {\n\t\t\tget: async (key: string) => {\n\t\t\t\tconst data = await ctx.options.secondaryStorage?.get(key);\n\t\t\t\treturn data ? safeJSONParse<RateLimit>(data) : null;\n\t\t\t},\n\t\t\tset: async (\n\t\t\t\tkey: string,\n\t\t\t\tvalue: RateLimit,\n\t\t\t\t_update?: boolean | undefined,\n\t\t\t) => {\n\t\t\t\tconst ttl =\n\t\t\t\t\trateLimitSettings?.window ?? ctx.options.rateLimit?.window ?? 10;\n\t\t\t\tawait ctx.options.secondaryStorage?.set?.(\n\t\t\t\t\tkey,\n\t\t\t\t\tJSON.stringify(value),\n\t\t\t\t\tttl,\n\t\t\t\t);\n\t\t\t},\n\t\t};\n\t} else if (storage === \"memory\") {\n\t\treturn {\n\t\t\tasync get(key: string) {\n\t\t\t\tconst entry = memory.get(key);\n\t\t\t\tif (!entry) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\t// Check if entry has expired\n\t\t\t\tif (Date.now() >= entry.expiresAt) {\n\t\t\t\t\tmemory.delete(key);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\treturn entry.data;\n\t\t\t},\n\t\t\tasync set(key: string, value: RateLimit, _update?: boolean | undefined) {\n\t\t\t\tconst ttl =\n\t\t\t\t\trateLimitSettings?.window ?? ctx.options.rateLimit?.window ?? 10;\n\t\t\t\tconst expiresAt = Date.now() + ttl * 1000;\n\t\t\t\tmemory.set(key, {\n\t\t\t\t\tdata: value,\n\t\t\t\t\texpiresAt,\n\t\t\t\t});\n\t\t\t},\n\t\t};\n\t}\n\treturn createDatabaseStorageWrapper(ctx);\n}\n\nexport async function onRequestRateLimit(req: Request, ctx: AuthContext) {\n\tif (!ctx.rateLimit.enabled) {\n\t\treturn;\n\t}\n\tconst basePath = new URL(ctx.baseURL).pathname;\n\tconst path = normalizePathname(req.url, basePath);\n\tlet currentWindow = ctx.rateLimit.window;\n\tlet currentMax = ctx.rateLimit.max;\n\tconst ip = getIp(req, ctx.options);\n\tif (!ip) {\n\t\treturn;\n\t}\n\tconst key = createRateLimitKey(ip, path);\n\tconst specialRules = getDefaultSpecialRules();\n\tconst specialRule = specialRules.find((rule) => rule.pathMatcher(path));\n\n\tif (specialRule) {\n\t\tcurrentWindow = specialRule.window;\n\t\tcurrentMax = specialRule.max;\n\t}\n\n\tfor (const plugin of ctx.options.plugins || []) {\n\t\tif (plugin.rateLimit) {\n\t\t\tconst matchedRule = plugin.rateLimit.find((rule) =>\n\t\t\t\trule.pathMatcher(path),\n\t\t\t);\n\t\t\tif (matchedRule) {\n\t\t\t\tcurrentWindow = matchedRule.window;\n\t\t\t\tcurrentMax = matchedRule.max;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (ctx.rateLimit.customRules) {\n\t\tconst _path = Object.keys(ctx.rateLimit.customRules).find((p) => {\n\t\t\tif (p.includes(\"*\")) {\n\t\t\t\tconst isMatch = wildcardMatch(p)(path);\n\t\t\t\treturn isMatch;\n\t\t\t}\n\t\t\treturn p === path;\n\t\t});\n\t\tif (_path) {\n\t\t\tconst customRule = ctx.rateLimit.customRules[_path];\n\t\t\tconst resolved =\n\t\t\t\ttypeof customRule === \"function\"\n\t\t\t\t\t? await customRule(req, {\n\t\t\t\t\t\t\twindow: currentWindow,\n\t\t\t\t\t\t\tmax: currentMax,\n\t\t\t\t\t\t})\n\t\t\t\t\t: customRule;\n\t\t\tif (resolved) {\n\t\t\t\tcurrentWindow = resolved.window;\n\t\t\t\tcurrentMax = resolved.max;\n\t\t\t}\n\n\t\t\tif (resolved === false) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tconst storage = getRateLimitStorage(ctx, {\n\t\twindow: currentWindow,\n\t});\n\tconst data = await storage.get(key);\n\tconst now = Date.now();\n\n\tif (!data) {\n\t\tawait storage.set(key, {\n\t\t\tkey,\n\t\t\tcount: 1,\n\t\t\tlastRequest: now,\n\t\t});\n\t} else {\n\t\tconst timeSinceLastRequest = now - data.lastRequest;\n\n\t\tif (shouldRateLimit(currentMax, currentWindow, data)) {\n\t\t\tconst retryAfter = getRetryAfter(data.lastRequest, currentWindow);\n\t\t\treturn rateLimitResponse(retryAfter);\n\t\t} else if (timeSinceLastRequest > currentWindow * 1000) {\n\t\t\t// Reset the count if the window has passed since the last request\n\t\t\tawait storage.set(\n\t\t\t\tkey,\n\t\t\t\t{\n\t\t\t\t\t...data,\n\t\t\t\t\tcount: 1,\n\t\t\t\t\tlastRequest: now,\n\t\t\t\t},\n\t\t\t\ttrue,\n\t\t\t);\n\t\t} else {\n\t\t\tawait storage.set(\n\t\t\t\tkey,\n\t\t\t\t{\n\t\t\t\t\t...data,\n\t\t\t\t\tcount: data.count + 1,\n\t\t\t\t\tlastRequest: now,\n\t\t\t\t},\n\t\t\t\ttrue,\n\t\t\t);\n\t\t}\n\t}\n}\n\nfunction getDefaultSpecialRules() {\n\tconst specialRules = [\n\t\t{\n\t\t\tpathMatcher(path: string) {\n\t\t\t\treturn (\n\t\t\t\t\tpath.startsWith(\"/sign-in\") ||\n\t\t\t\t\tpath.startsWith(\"/sign-up\") ||\n\t\t\t\t\tpath.startsWith(\"/change-password\") ||\n\t\t\t\t\tpath.startsWith(\"/change-email\")\n\t\t\t\t);\n\t\t\t},\n\t\t\twindow: 10,\n\t\t\tmax: 3,\n\t\t},\n\t];\n\treturn specialRules;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAkBA,MAAM,SAAA,aAAA,GAAS,IAAI,KAAmC;AAEtD,SAAS,gBACR,GAAA,EACA,MAAA,EACA,aAAA,EACC;IACD,MAAM,MAAM,KAAK,GAAA,EAAK;IACtB,MAAM,aAAa,SAAS;IAE5B,OAD6B,MAAM,cAAc,WAAA,GACnB,cAAc,cAAc,KAAA,IAAS;;AAGpE,SAAS,kBAAkB,UAAA,EAAoB;IAC9C,OAAO,IAAI,SACV,KAAK,SAAA,CAAU;QACd,SAAS;IAAA,CACT,CAAC,EACF;QACC,QAAQ;QACR,YAAY;QACZ,SAAS;YACR,iBAAiB,WAAW,QAAA,EAAU;QAAA,CACtC;KACD,CACD;;AAGF,SAAS,cAAc,WAAA,EAAqB,MAAA,EAAgB;IAC3D,MAAM,MAAM,KAAK,GAAA,EAAK;IACtB,MAAM,aAAa,SAAS;IAC5B,OAAO,KAAK,IAAA,CAAA,CAAM,cAAc,aAAa,GAAA,IAAO,IAAK;;AAG1D,SAAS,6BACR,GAAA,EAC6B;IAC7B,MAAM,QAAQ;IACd,MAAM,KAAK,IAAI,OAAA;IACf,OAAO;QACN,KAAK,OAAO,QAAgB;YAK3B,MAAM,OAAA,CAJM,MAAM,GAAG,QAAA,CAAoB;gBACxC;gBACA,OAAO;oBAAC;wBAAE,OAAO;wBAAO,OAAO;qBAAK;iBAAC;aACrC,CAAC,CAAA,CACe,EAAA;YAEjB,IAAI,OAAO,MAAM,gBAAgB,SAChC,CAAA,KAAK,WAAA,GAAc,OAAO,KAAK,WAAA,CAAY;YAG5C,OAAO;;QAER,KAAK,OACJ,KACA,OACA,YACI;YACJ,IAAI;gBACH,IAAI,QACH,CAAA,MAAM,GAAG,UAAA,CAAW;oBACnB;oBACA,OAAO;wBAAC;4BAAE,OAAO;4BAAO,OAAO;yBAAK;qBAAC;oBACrC,QAAQ;wBACP,OAAO,MAAM,KAAA;wBACb,aAAa,MAAM,WAAA;qBACnB;iBACD,CAAC;qBAEF,MAAM,GAAG,MAAA,CAAO;oBACf;oBACA,MAAM;wBACL;wBACA,OAAO,MAAM,KAAA;wBACb,aAAa,MAAM,WAAA;qBACnB;iBACD,CAAC;qBAEK,GAAG;gBACX,IAAI,MAAA,CAAO,KAAA,CAAM,4BAA4B,EAAE;;;KAGjD;;AAGF,SAAS,oBACR,GAAA,EACA,iBAAA,EAG6B;IAC7B,IAAI,IAAI,OAAA,CAAQ,SAAA,EAAW,cAC1B,CAAA,OAAO,IAAI,OAAA,CAAQ,SAAA,CAAU,aAAA;IAE9B,MAAM,UAAU,IAAI,SAAA,CAAU,OAAA;IAC9B,IAAI,YAAY,oBACf,CAAA,OAAO;QACN,KAAK,OAAO,QAAgB;YAC3B,MAAM,OAAO,MAAM,IAAI,OAAA,CAAQ,gBAAA,EAAkB,IAAI,IAAI;YACzD,OAAO,WAAO,qLAAA,EAAyB,KAAK,GAAG;;QAEhD,KAAK,OACJ,KACA,OACA,YACI;YACJ,MAAM,MACL,mBAAmB,UAAU,IAAI,OAAA,CAAQ,SAAA,EAAW,UAAU;YAC/D,MAAM,IAAI,OAAA,CAAQ,gBAAA,EAAkB,MACnC,KACA,KAAK,SAAA,CAAU,MAAM,EACrB,IACA;;KAEF;aACS,YAAY,SACtB,CAAA,OAAO;QACN,MAAM,KAAI,GAAA,EAAa;YACtB,MAAM,QAAQ,OAAO,GAAA,CAAI,IAAI;YAC7B,IAAI,CAAC,MACJ,CAAA,OAAO;YAGR,IAAI,KAAK,GAAA,EAAK,IAAI,MAAM,SAAA,EAAW;gBAClC,OAAO,MAAA,CAAO,IAAI;gBAClB,OAAO;;YAER,OAAO,MAAM,IAAA;;QAEd,MAAM,KAAI,GAAA,EAAa,KAAA,EAAkB,OAAA,EAA+B;YACvE,MAAM,MACL,mBAAmB,UAAU,IAAI,OAAA,CAAQ,SAAA,EAAW,UAAU;YAC/D,MAAM,YAAY,KAAK,GAAA,EAAK,GAAG,MAAM;YACrC,OAAO,GAAA,CAAI,KAAK;gBACf,MAAM;gBACN;aACA,CAAC;;KAEH;IAEF,OAAO,6BAA6B,IAAI;;AAGzC,eAAsB,mBAAmB,GAAA,EAAc,GAAA,EAAkB;IACxE,IAAI,CAAC,IAAI,SAAA,CAAU,OAAA,CAClB,CAAA;IAED,MAAM,WAAW,IAAI,IAAI,IAAI,OAAA,CAAQ,CAAC,QAAA;IACtC,MAAM,WAAO,wLAAA,EAAkB,IAAI,GAAA,EAAK,SAAS;IACjD,IAAI,gBAAgB,IAAI,SAAA,CAAU,MAAA;IAClC,IAAI,aAAa,IAAI,SAAA,CAAU,GAAA;IAC/B,MAAM,SAAK,mLAAA,EAAM,KAAK,IAAI,OAAA,CAAQ;IAClC,IAAI,CAAC,GACJ,CAAA;IAED,MAAM,UAAM,wLAAA,EAAmB,IAAI,KAAK;IAExC,MAAM,cADe,wBAAwB,CACZ,IAAA,CAAA,CAAM,OAAS,KAAK,WAAA,CAAY,KAAK,CAAC;IAEvE,IAAI,aAAa;QAChB,gBAAgB,YAAY,MAAA;QAC5B,aAAa,YAAY,GAAA;;IAG1B,KAAK,MAAM,UAAU,IAAI,OAAA,CAAQ,OAAA,IAAW,EAAE,CAC7C,IAAI,OAAO,SAAA,EAAW;QACrB,MAAM,cAAc,OAAO,SAAA,CAAU,IAAA,CAAA,CAAM,OAC1C,KAAK,WAAA,CAAY,KAAK,CACtB;QACD,IAAI,aAAa;YAChB,gBAAgB,YAAY,MAAA;YAC5B,aAAa,YAAY,GAAA;YACzB;;;IAKH,IAAI,IAAI,SAAA,CAAU,WAAA,EAAa;QAC9B,MAAM,QAAQ,OAAO,IAAA,CAAK,IAAI,SAAA,CAAU,WAAA,CAAY,CAAC,IAAA,CAAA,CAAM,MAAM;YAChE,IAAI,EAAE,QAAA,CAAS,IAAI,CAElB,CAAA,WADgB,+KAAA,EAAc,EAAE,CAAC,KAAK;YAGvC,OAAO,MAAM;UACZ;QACF,IAAI,OAAO;YACV,MAAM,aAAa,IAAI,SAAA,CAAU,WAAA,CAAY,MAAA;YAC7C,MAAM,WACL,OAAO,eAAe,aACnB,MAAM,WAAW,KAAK;gBACtB,QAAQ;gBACR,KAAK;aACL,CAAC,GACD;YACJ,IAAI,UAAU;gBACb,gBAAgB,SAAS,MAAA;gBACzB,aAAa,SAAS,GAAA;;YAGvB,IAAI,aAAa,MAChB,CAAA;;;IAKH,MAAM,UAAU,oBAAoB,KAAK;QACxC,QAAQ;IAAA,CACR,CAAC;IACF,MAAM,OAAO,MAAM,QAAQ,GAAA,CAAI,IAAI;IACnC,MAAM,MAAM,KAAK,GAAA,EAAK;IAEtB,IAAI,CAAC,KACJ,CAAA,MAAM,QAAQ,GAAA,CAAI,KAAK;QACtB;QACA,OAAO;QACP,aAAa;KACb,CAAC;SACI;QACN,MAAM,uBAAuB,MAAM,KAAK,WAAA;QAExC,IAAI,gBAAgB,YAAY,eAAe,KAAK,CAEnD,CAAA,OAAO,kBADY,cAAc,KAAK,WAAA,EAAa,cAAc,CAC7B;iBAC1B,uBAAuB,gBAAgB,IAEjD,CAAA,MAAM,QAAQ,GAAA,CACb,KACA;YACC,GAAG,IAAA;YACH,OAAO;YACP,aAAa;SACb,EACD,KACA;aAED,MAAM,QAAQ,GAAA,CACb,KACA;YACC,GAAG,IAAA;YACH,OAAO,KAAK,KAAA,GAAQ;YACpB,aAAa;SACb,EACD,KACA;;;AAKJ,SAAS,yBAAyB;IAejC,OAdqB;QACpB;YACC,aAAY,IAAA,EAAc;gBACzB,OACC,KAAK,UAAA,CAAW,WAAW,IAC3B,KAAK,UAAA,CAAW,WAAW,IAC3B,KAAK,UAAA,CAAW,mBAAmB,IACnC,KAAK,UAAA,CAAW,gBAAgB;;YAGlC,QAAQ;YACR,KAAK;SACL;KACD"}},
    {"offset": {"line": 390, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/session.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/session.ts"],"sourcesContent":["import type {\n\tBetterAuthOptions,\n\tGenericEndpointContext,\n} from \"@better-auth/core\";\nimport {\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n} from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport { base64Url } from \"@better-auth/utils/base64\";\nimport { binary } from \"@better-auth/utils/binary\";\nimport { createHMAC } from \"@better-auth/utils/hmac\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport {\n\tdeleteSessionCookie,\n\texpireCookie,\n\tgetChunkedCookie,\n\tsetCookieCache,\n\tsetSessionCookie,\n} from \"../../cookies\";\nimport { getSessionQuerySchema } from \"../../cookies/session-store\";\nimport { symmetricDecodeJWT, verifyJWT } from \"../../crypto\";\nimport { parseSessionOutput, parseUserOutput } from \"../../db\";\nimport type { InferSession, InferUser, Session, User } from \"../../types\";\nimport type { Prettify } from \"../../types/helper\";\nimport { getDate } from \"../../utils/date\";\n\nexport const getSession = <Option extends BetterAuthOptions>() =>\n\tcreateAuthEndpoint(\n\t\t\"/get-session\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\toperationId: \"getSession\",\n\t\t\tquery: getSessionQuerySchema,\n\t\t\trequireHeaders: true,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"getSession\",\n\t\t\t\t\tdescription: \"Get the current session\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"session\", \"user\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (\n\t\t\tctx,\n\t\t): Promise<{\n\t\t\tsession: InferSession<Option>;\n\t\t\tuser: InferUser<Option>;\n\t\t} | null> => {\n\t\t\ttry {\n\t\t\t\tconst sessionCookieToken = await ctx.getSignedCookie(\n\t\t\t\t\tctx.context.authCookies.sessionToken.name,\n\t\t\t\t\tctx.context.secret,\n\t\t\t\t);\n\n\t\t\t\tif (!sessionCookieToken) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst sessionDataCookie = getChunkedCookie(\n\t\t\t\t\tctx,\n\t\t\t\t\tctx.context.authCookies.sessionData.name,\n\t\t\t\t);\n\n\t\t\t\tlet sessionDataPayload: {\n\t\t\t\t\tsession: {\n\t\t\t\t\t\tsession: Session;\n\t\t\t\t\t\tuser: User;\n\t\t\t\t\t\tupdatedAt: number;\n\t\t\t\t\t\tversion?: string;\n\t\t\t\t\t};\n\t\t\t\t\texpiresAt: number;\n\t\t\t\t} | null = null;\n\n\t\t\t\tif (sessionDataCookie) {\n\t\t\t\t\tconst strategy =\n\t\t\t\t\t\tctx.context.options.session?.cookieCache?.strategy || \"compact\";\n\n\t\t\t\t\tif (strategy === \"jwe\") {\n\t\t\t\t\t\t// Decode JWE (encrypted)\n\t\t\t\t\t\tconst payload = await symmetricDecodeJWT<{\n\t\t\t\t\t\t\tsession: Session;\n\t\t\t\t\t\t\tuser: User;\n\t\t\t\t\t\t\tupdatedAt: number;\n\t\t\t\t\t\t\tversion?: string;\n\t\t\t\t\t\t\texp?: number;\n\t\t\t\t\t\t}>(sessionDataCookie, ctx.context.secret, \"better-auth-session\");\n\n\t\t\t\t\t\tif (payload && payload.session && payload.user) {\n\t\t\t\t\t\t\tsessionDataPayload = {\n\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\tsession: payload.session,\n\t\t\t\t\t\t\t\t\tuser: payload.user,\n\t\t\t\t\t\t\t\t\tupdatedAt: payload.updatedAt,\n\t\t\t\t\t\t\t\t\tversion: payload.version,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\texpiresAt: payload.exp ? payload.exp * 1000 : Date.now(),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\texpireCookie(ctx, ctx.context.authCookies.sessionData);\n\t\t\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (strategy === \"jwt\") {\n\t\t\t\t\t\t// Decode JWT (signed with HMAC, not encrypted)\n\t\t\t\t\t\tconst payload = await verifyJWT<{\n\t\t\t\t\t\t\tsession: Session;\n\t\t\t\t\t\t\tuser: User;\n\t\t\t\t\t\t\tupdatedAt: number;\n\t\t\t\t\t\t\tversion?: string;\n\t\t\t\t\t\t\texp?: number;\n\t\t\t\t\t\t}>(sessionDataCookie, ctx.context.secret);\n\n\t\t\t\t\t\tif (payload && payload.session && payload.user) {\n\t\t\t\t\t\t\tsessionDataPayload = {\n\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\tsession: payload.session,\n\t\t\t\t\t\t\t\t\tuser: payload.user,\n\t\t\t\t\t\t\t\t\tupdatedAt: payload.updatedAt,\n\t\t\t\t\t\t\t\t\tversion: payload.version,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\texpiresAt: payload.exp ? payload.exp * 1000 : Date.now(),\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\texpireCookie(ctx, ctx.context.authCookies.sessionData);\n\t\t\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Decode compact format (or legacy base64-hmac)\n\t\t\t\t\t\tconst parsed = safeJSONParse<{\n\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\tsession: Session;\n\t\t\t\t\t\t\t\tuser: User;\n\t\t\t\t\t\t\t\tupdatedAt: number;\n\t\t\t\t\t\t\t\tversion?: string;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tsignature: string;\n\t\t\t\t\t\t\texpiresAt: number;\n\t\t\t\t\t\t}>(binary.decode(base64Url.decode(sessionDataCookie)));\n\n\t\t\t\t\t\tif (parsed) {\n\t\t\t\t\t\t\tconst isValid = await createHMAC(\n\t\t\t\t\t\t\t\t\"SHA-256\",\n\t\t\t\t\t\t\t\t\"base64urlnopad\",\n\t\t\t\t\t\t\t).verify(\n\t\t\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\t\t\t...parsed.session,\n\t\t\t\t\t\t\t\t\texpiresAt: parsed.expiresAt,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tparsed.signature,\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tif (isValid) {\n\t\t\t\t\t\t\t\tsessionDataPayload = parsed;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\texpireCookie(ctx, ctx.context.authCookies.sessionData);\n\t\t\t\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst dontRememberMe = await ctx.getSignedCookie(\n\t\t\t\t\tctx.context.authCookies.dontRememberToken.name,\n\t\t\t\t\tctx.context.secret,\n\t\t\t\t);\n\n\t\t\t\t/**\n\t\t\t\t * If session data is present in the cookie, check if it should be used or refreshed\n\t\t\t\t */\n\t\t\t\tif (\n\t\t\t\t\tsessionDataPayload?.session &&\n\t\t\t\t\tctx.context.options.session?.cookieCache?.enabled &&\n\t\t\t\t\t!ctx.query?.disableCookieCache\n\t\t\t\t) {\n\t\t\t\t\tconst session = sessionDataPayload.session;\n\n\t\t\t\t\tconst versionConfig =\n\t\t\t\t\t\tctx.context.options.session?.cookieCache?.version;\n\t\t\t\t\tlet expectedVersion = \"1\";\n\t\t\t\t\tif (versionConfig) {\n\t\t\t\t\t\tif (typeof versionConfig === \"string\") {\n\t\t\t\t\t\t\texpectedVersion = versionConfig;\n\t\t\t\t\t\t} else if (typeof versionConfig === \"function\") {\n\t\t\t\t\t\t\tconst result = versionConfig(session.session, session.user);\n\t\t\t\t\t\t\texpectedVersion =\n\t\t\t\t\t\t\t\tresult instanceof Promise ? await result : result;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst cookieVersion = session.version || \"1\";\n\t\t\t\t\tif (cookieVersion !== expectedVersion) {\n\t\t\t\t\t\t// Version mismatch - invalidate the cookie cache\n\t\t\t\t\t\texpireCookie(ctx, ctx.context.authCookies.sessionData);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst cachedSessionExpiresAt = new Date(\n\t\t\t\t\t\t\tsession.session.expiresAt as unknown as string | number | Date,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst hasExpired =\n\t\t\t\t\t\t\tsessionDataPayload.expiresAt < Date.now() ||\n\t\t\t\t\t\t\tcachedSessionExpiresAt < new Date();\n\n\t\t\t\t\t\tif (hasExpired) {\n\t\t\t\t\t\t\t// When the session data cookie has expired, delete it;\n\t\t\t\t\t\t\t//  then we try to fetch from DB\n\t\t\t\t\t\t\texpireCookie(ctx, ctx.context.authCookies.sessionData);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Check if the cookie cache needs to be refreshed based on refreshCache\n\t\t\t\t\t\t\tconst cookieRefreshCache =\n\t\t\t\t\t\t\t\tctx.context.sessionConfig.cookieRefreshCache;\n\n\t\t\t\t\t\t\tif (cookieRefreshCache === false) {\n\t\t\t\t\t\t\t\t// If refreshCache is disabled, return the session from cookie as-is\n\t\t\t\t\t\t\t\tctx.context.session = session;\n\t\t\t\t\t\t\t\t// Parse session and user to ensure additionalFields are included\n\t\t\t\t\t\t\t\t// Rehydrate date fields from JSON strings before parsing\n\t\t\t\t\t\t\t\tconst parsedSession = parseSessionOutput(ctx.context.options, {\n\t\t\t\t\t\t\t\t\t...session.session,\n\t\t\t\t\t\t\t\t\texpiresAt: new Date(session.session.expiresAt),\n\t\t\t\t\t\t\t\t\tcreatedAt: new Date(session.session.createdAt),\n\t\t\t\t\t\t\t\t\tupdatedAt: new Date(session.session.updatedAt),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tconst parsedUser = parseUserOutput(ctx.context.options, {\n\t\t\t\t\t\t\t\t\t...session.user,\n\t\t\t\t\t\t\t\t\tcreatedAt: new Date(session.user.createdAt),\n\t\t\t\t\t\t\t\t\tupdatedAt: new Date(session.user.updatedAt),\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\t\t\tsession: parsedSession,\n\t\t\t\t\t\t\t\t\tuser: parsedUser,\n\t\t\t\t\t\t\t\t} as {\n\t\t\t\t\t\t\t\t\tsession: InferSession<Option>;\n\t\t\t\t\t\t\t\t\tuser: InferUser<Option>;\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst timeUntilExpiry = sessionDataPayload.expiresAt - Date.now();\n\t\t\t\t\t\t\tconst updateAge = cookieRefreshCache.updateAge * 1000; // Convert to milliseconds\n\n\t\t\t\t\t\t\tif (timeUntilExpiry < updateAge) {\n\t\t\t\t\t\t\t\tconst cookieMaxAge =\n\t\t\t\t\t\t\t\t\tctx.context.options.session?.cookieCache?.maxAge || 60 * 5;\n\t\t\t\t\t\t\t\tconst newExpiresAt = getDate(cookieMaxAge, \"sec\");\n\t\t\t\t\t\t\t\tconst refreshedSession = {\n\t\t\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\t\t\t...session.session,\n\t\t\t\t\t\t\t\t\t\texpiresAt: newExpiresAt,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\t\t\t\tupdatedAt: Date.now(),\n\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t// Set the refreshed cookie cache\n\t\t\t\t\t\t\t\tawait setCookieCache(ctx, refreshedSession, false);\n\n\t\t\t\t\t\t\t\t// Parse session and user to ensure additionalFields are included\n\t\t\t\t\t\t\t\t// Rehydrate date fields from JSON strings before parsing\n\t\t\t\t\t\t\t\tconst parsedRefreshedSession = parseSessionOutput(\n\t\t\t\t\t\t\t\t\tctx.context.options,\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t...refreshedSession.session,\n\t\t\t\t\t\t\t\t\t\texpiresAt: new Date(refreshedSession.session.expiresAt),\n\t\t\t\t\t\t\t\t\t\tcreatedAt: new Date(refreshedSession.session.createdAt),\n\t\t\t\t\t\t\t\t\t\tupdatedAt: new Date(refreshedSession.session.updatedAt),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tconst parsedRefreshedUser = parseUserOutput(\n\t\t\t\t\t\t\t\t\tctx.context.options,\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t...refreshedSession.user,\n\t\t\t\t\t\t\t\t\t\tcreatedAt: new Date(refreshedSession.user.createdAt),\n\t\t\t\t\t\t\t\t\t\tupdatedAt: new Date(refreshedSession.user.updatedAt),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tctx.context.session = {\n\t\t\t\t\t\t\t\t\tsession: parsedRefreshedSession,\n\t\t\t\t\t\t\t\t\tuser: parsedRefreshedUser,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\t\t\tsession: parsedRefreshedSession,\n\t\t\t\t\t\t\t\t\tuser: parsedRefreshedUser,\n\t\t\t\t\t\t\t\t} as {\n\t\t\t\t\t\t\t\t\tsession: InferSession<Option>;\n\t\t\t\t\t\t\t\t\tuser: InferUser<Option>;\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Parse session and user to ensure additionalFields are included\n\t\t\t\t\t\t\tconst parsedSession = parseSessionOutput(ctx.context.options, {\n\t\t\t\t\t\t\t\t...session.session,\n\t\t\t\t\t\t\t\texpiresAt: new Date(session.session.expiresAt),\n\t\t\t\t\t\t\t\tcreatedAt: new Date(session.session.createdAt),\n\t\t\t\t\t\t\t\tupdatedAt: new Date(session.session.updatedAt),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tconst parsedUser = parseUserOutput(ctx.context.options, {\n\t\t\t\t\t\t\t\t...session.user,\n\t\t\t\t\t\t\t\tcreatedAt: new Date(session.user.createdAt),\n\t\t\t\t\t\t\t\tupdatedAt: new Date(session.user.updatedAt),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tctx.context.session = {\n\t\t\t\t\t\t\t\tsession: parsedSession,\n\t\t\t\t\t\t\t\tuser: parsedUser,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\t\t\tsession: parsedSession,\n\t\t\t\t\t\t\t\tuser: parsedUser,\n\t\t\t\t\t\t\t} as {\n\t\t\t\t\t\t\t\tsession: InferSession<Option>;\n\t\t\t\t\t\t\t\tuser: InferUser<Option>;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst session =\n\t\t\t\t\tawait ctx.context.internalAdapter.findSession(sessionCookieToken);\n\t\t\t\tctx.context.session = session;\n\t\t\t\tif (!session || session.session.expiresAt < new Date()) {\n\t\t\t\t\tdeleteSessionCookie(ctx);\n\t\t\t\t\tif (session) {\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * if session expired clean up the session\n\t\t\t\t\t\t */\n\t\t\t\t\t\tawait ctx.context.internalAdapter.deleteSession(\n\t\t\t\t\t\t\tsession.session.token,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json(null);\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * We don't need to update the session if the user doesn't want to be remembered\n\t\t\t\t * or if the session refresh is disabled\n\t\t\t\t */\n\t\t\t\tif (dontRememberMe || ctx.query?.disableRefresh) {\n\t\t\t\t\t// Parse session and user to ensure additionalFields are included\n\t\t\t\t\tconst parsedSession = parseSessionOutput(\n\t\t\t\t\t\tctx.context.options,\n\t\t\t\t\t\tsession.session,\n\t\t\t\t\t);\n\t\t\t\t\tconst parsedUser = parseUserOutput(ctx.context.options, session.user);\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tsession: parsedSession,\n\t\t\t\t\t\tuser: parsedUser,\n\t\t\t\t\t} as {\n\t\t\t\t\t\tsession: InferSession<Option>;\n\t\t\t\t\t\tuser: InferUser<Option>;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst expiresIn = ctx.context.sessionConfig.expiresIn;\n\t\t\t\tconst updateAge = ctx.context.sessionConfig.updateAge;\n\t\t\t\t/**\n\t\t\t\t * Calculate last updated date to throttle write updates to database\n\t\t\t\t * Formula: ({expiry date} - sessionMaxAge) + sessionUpdateAge\n\t\t\t\t *\n\t\t\t\t * e.g. ({expiry date} - 30 days) + 1 hour\n\t\t\t\t *\n\t\t\t\t * inspired by: https://github.com/nextauthjs/next-auth/blob/main/packages/core/src/lib/actions/session.ts\n\t\t\t\t */\n\t\t\t\tconst sessionIsDueToBeUpdatedDate =\n\t\t\t\t\tsession.session.expiresAt.valueOf() -\n\t\t\t\t\texpiresIn * 1000 +\n\t\t\t\t\tupdateAge * 1000;\n\t\t\t\tconst shouldBeUpdated = sessionIsDueToBeUpdatedDate <= Date.now();\n\n\t\t\t\tif (\n\t\t\t\t\tshouldBeUpdated &&\n\t\t\t\t\t(!ctx.query?.disableRefresh ||\n\t\t\t\t\t\t!ctx.context.options.session?.disableSessionRefresh)\n\t\t\t\t) {\n\t\t\t\t\tconst updatedSession =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.updateSession(\n\t\t\t\t\t\t\tsession.session.token,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\texpiresAt: getDate(ctx.context.sessionConfig.expiresIn, \"sec\"),\n\t\t\t\t\t\t\t\tupdatedAt: new Date(),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t);\n\t\t\t\t\tif (!updatedSession) {\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Handle case where session update fails (e.g., concurrent deletion)\n\t\t\t\t\t\t */\n\t\t\t\t\t\tdeleteSessionCookie(ctx);\n\t\t\t\t\t\treturn ctx.json(null, { status: 401 });\n\t\t\t\t\t}\n\t\t\t\t\tconst maxAge =\n\t\t\t\t\t\t(updatedSession.expiresAt.valueOf() - Date.now()) / 1000;\n\t\t\t\t\tawait setSessionCookie(\n\t\t\t\t\t\tctx,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsession: updatedSession,\n\t\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmaxAge,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\n\t\t\t\t\t// Parse session and user to ensure additionalFields are included\n\t\t\t\t\tconst parsedUpdatedSession = parseSessionOutput(\n\t\t\t\t\t\tctx.context.options,\n\t\t\t\t\t\tupdatedSession,\n\t\t\t\t\t);\n\t\t\t\t\tconst parsedUser = parseUserOutput(ctx.context.options, session.user);\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tsession: parsedUpdatedSession,\n\t\t\t\t\t\tuser: parsedUser,\n\t\t\t\t\t} as unknown as {\n\t\t\t\t\t\tsession: InferSession<Option>;\n\t\t\t\t\t\tuser: InferUser<Option>;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tawait setCookieCache(ctx, session, !!dontRememberMe);\n\t\t\t\t// Parse session and user to ensure additionalFields are included\n\t\t\t\tconst parsedSession = parseSessionOutput(\n\t\t\t\t\tctx.context.options,\n\t\t\t\t\tsession.session,\n\t\t\t\t);\n\t\t\t\tconst parsedUser = parseUserOutput(ctx.context.options, session.user);\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tsession: parsedSession,\n\t\t\t\t\tuser: parsedUser,\n\t\t\t\t} as {\n\t\t\t\t\tsession: InferSession<Option>;\n\t\t\t\t\tuser: InferUser<Option>;\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tctx.context.logger.error(\"INTERNAL_SERVER_ERROR\", error);\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_GET_SESSION,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t);\n\nexport const getSessionFromCtx = async <\n\tU extends Record<string, any> = Record<string, any>,\n\tS extends Record<string, any> = Record<string, any>,\n>(\n\tctx: GenericEndpointContext,\n\tconfig?:\n\t\t| {\n\t\t\t\tdisableCookieCache?: boolean;\n\t\t\t\tdisableRefresh?: boolean;\n\t\t  }\n\t\t| undefined,\n) => {\n\tif (ctx.context.session) {\n\t\treturn ctx.context.session as {\n\t\t\tsession: S & Session;\n\t\t\tuser: U & User;\n\t\t};\n\t}\n\n\tconst session = await getSession()({\n\t\t...ctx,\n\t\tasResponse: false,\n\t\theaders: ctx.headers!,\n\t\treturnHeaders: false,\n\t\treturnStatus: false,\n\t\tquery: {\n\t\t\t...config,\n\t\t\t...ctx.query,\n\t\t},\n\t}).catch((e) => {\n\t\treturn null;\n\t});\n\tctx.context.session = session;\n\treturn session as {\n\t\tsession: S & Session;\n\t\tuser: U & User;\n\t} | null;\n};\n\n/**\n * The middleware forces the endpoint to require a valid session.\n */\nexport const sessionMiddleware = createAuthMiddleware(async (ctx) => {\n\tconst session = await getSessionFromCtx(ctx);\n\tif (!session?.session) {\n\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t}\n\treturn {\n\t\tsession,\n\t};\n});\n\n/**\n * This middleware forces the endpoint to require a valid session and ignores cookie cache.\n * This should be used for sensitive operations like password changes, account deletion, etc.\n * to ensure that revoked sessions cannot be used even if they're still cached in cookies.\n */\nexport const sensitiveSessionMiddleware = createAuthMiddleware(async (ctx) => {\n\tconst session = await getSessionFromCtx(ctx, { disableCookieCache: true });\n\tif (!session?.session) {\n\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t}\n\treturn {\n\t\tsession,\n\t};\n});\n\n/**\n * This middleware allows you to call the endpoint on the client if session is valid.\n * However, if called on the server, no session is required.\n */\nexport const requestOnlySessionMiddleware = createAuthMiddleware(\n\tasync (ctx) => {\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (!session?.session && (ctx.request || ctx.headers)) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t}\n\t\treturn { session };\n\t},\n);\n\n/**\n * This middleware forces the endpoint to require a valid session,\n * as well as making sure the session is fresh before proceeding.\n *\n * Session freshness check will be skipped if the session config's freshAge\n * is set to 0\n */\nexport const freshSessionMiddleware = createAuthMiddleware(async (ctx) => {\n\tconst session = await getSessionFromCtx(ctx);\n\tif (!session?.session) {\n\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t}\n\tif (ctx.context.sessionConfig.freshAge === 0) {\n\t\treturn {\n\t\t\tsession,\n\t\t};\n\t}\n\tconst freshAge = ctx.context.sessionConfig.freshAge;\n\tconst lastUpdated = new Date(\n\t\tsession.session.updatedAt || session.session.createdAt,\n\t).getTime();\n\tconst now = Date.now();\n\tconst isFresh = now - lastUpdated < freshAge * 1000;\n\tif (!isFresh) {\n\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\tmessage: \"Session is not fresh\",\n\t\t});\n\t}\n\treturn {\n\t\tsession,\n\t};\n});\n/**\n * user active sessions list\n */\nexport const listSessions = <Option extends BetterAuthOptions>() =>\n\tcreateAuthEndpoint(\n\t\t\"/list-sessions\",\n\t\t{\n\t\t\tmethod: \"GET\",\n\t\t\toperationId: \"listUserSessions\",\n\t\t\tuse: [sessionMiddleware],\n\t\t\trequireHeaders: true,\n\t\t\tmetadata: {\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"listUserSessions\",\n\t\t\t\t\tdescription: \"List all active sessions for the user\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/Session\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\ttry {\n\t\t\t\tconst sessions = await ctx.context.internalAdapter.listSessions(\n\t\t\t\t\tctx.context.session.user.id,\n\t\t\t\t);\n\t\t\t\tconst activeSessions = sessions.filter((session) => {\n\t\t\t\t\treturn session.expiresAt > new Date();\n\t\t\t\t});\n\t\t\t\treturn ctx.json(\n\t\t\t\t\tactiveSessions.map((session) =>\n\t\t\t\t\t\tparseSessionOutput(ctx.context.options, session),\n\t\t\t\t\t) as unknown as Prettify<InferSession<Option>>[],\n\t\t\t\t);\n\t\t\t} catch (e: any) {\n\t\t\t\tctx.context.logger.error(e);\n\t\t\t\tthrow ctx.error(\"INTERNAL_SERVER_ERROR\");\n\t\t\t}\n\t\t},\n\t);\n\n/**\n * revoke a single session\n */\nexport const revokeSession = createAuthEndpoint(\n\t\"/revoke-session\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\ttoken: z.string().meta({\n\t\t\t\tdescription: \"The token to revoke\",\n\t\t\t}),\n\t\t}),\n\t\tuse: [sensitiveSessionMiddleware],\n\t\trequireHeaders: true,\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Revoke a single session\",\n\t\t\t\trequestBody: {\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The token to revoke\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\trequired: [\"token\"],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the session was revoked successfully\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst token = ctx.body.token;\n\t\tconst session = await ctx.context.internalAdapter.findSession(token);\n\n\t\tif (session?.session.userId === ctx.context.session.user.id) {\n\t\t\ttry {\n\t\t\t\tawait ctx.context.internalAdapter.deleteSession(token);\n\t\t\t} catch (error) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\terror && typeof error === \"object\" && \"name\" in error\n\t\t\t\t\t\t? (error.name as string)\n\t\t\t\t\t\t: \"\",\n\t\t\t\t\terror,\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\");\n\t\t\t}\n\t\t}\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n/**\n * revoke all user sessions\n */\nexport const revokeSessions = createAuthEndpoint(\n\t\"/revoke-sessions\",\n\t{\n\t\tmethod: \"POST\",\n\t\tuse: [sensitiveSessionMiddleware],\n\t\trequireHeaders: true,\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Revoke all sessions for the user\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if all sessions were revoked successfully\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\ttry {\n\t\t\tawait ctx.context.internalAdapter.deleteSessions(\n\t\t\t\tctx.context.session.user.id,\n\t\t\t);\n\t\t} catch (error) {\n\t\t\tctx.context.logger.error(\n\t\t\t\terror && typeof error === \"object\" && \"name\" in error\n\t\t\t\t\t? (error.name as string)\n\t\t\t\t\t: \"\",\n\t\t\t\terror,\n\t\t\t);\n\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\");\n\t\t}\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n\nexport const revokeOtherSessions = createAuthEndpoint(\n\t\"/revoke-other-sessions\",\n\t{\n\t\tmethod: \"POST\",\n\t\trequireHeaders: true,\n\t\tuse: [sensitiveSessionMiddleware],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription:\n\t\t\t\t\t\"Revoke all other sessions for the user except the current one\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if all other sessions were revoked successfully\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst session = ctx.context.session;\n\t\tif (!session.user) {\n\t\t\tthrow new APIError(\"UNAUTHORIZED\");\n\t\t}\n\t\tconst sessions = await ctx.context.internalAdapter.listSessions(\n\t\t\tsession.user.id,\n\t\t);\n\t\tconst activeSessions = sessions.filter((session) => {\n\t\t\treturn session.expiresAt > new Date();\n\t\t});\n\t\tconst otherSessions = activeSessions.filter(\n\t\t\t(session) => session.token !== ctx.context.session.session.token,\n\t\t);\n\t\tawait Promise.all(\n\t\t\totherSessions.map((session) =>\n\t\t\t\tctx.context.internalAdapter.deleteSession(session.token),\n\t\t\t),\n\t\t);\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n"],"names":["sessionDataPayload: {\n\t\t\t\t\tsession: {\n\t\t\t\t\t\tsession: Session;\n\t\t\t\t\t\tuser: User;\n\t\t\t\t\t\tupdatedAt: number;\n\t\t\t\t\t\tversion?: string;\n\t\t\t\t\t};\n\t\t\t\t\texpiresAt: number;\n\t\t\t\t} | null","session","parsedSession","parsedUser","e: any"],"mappings":"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"}},
    {"offset": {"line": 961, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/account.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/account.ts"],"sourcesContent":["import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport type { Account } from \"@better-auth/core/db\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport type { OAuth2Tokens } from \"@better-auth/core/oauth2\";\nimport { SocialProviderListEnum } from \"@better-auth/core/social-providers\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport {\n\tgetAccountCookie,\n\tsetAccountCookie,\n} from \"../../cookies/session-store\";\nimport { parseAccountOutput } from \"../../db/schema\";\nimport { generateState } from \"../../oauth2/state\";\nimport { decryptOAuthToken, setTokenUtil } from \"../../oauth2/utils\";\nimport {\n\tfreshSessionMiddleware,\n\tgetSessionFromCtx,\n\tsessionMiddleware,\n} from \"./session\";\n\nexport const listUserAccounts = createAuthEndpoint(\n\t\"/list-accounts\",\n\t{\n\t\tmethod: \"GET\",\n\t\tuse: [sessionMiddleware],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"listUserAccounts\",\n\t\t\t\tdescription: \"List all accounts linked to the user\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tproviderId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\taccountId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuserId: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tscopes: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"array\",\n\t\t\t\t\t\t\t\t\t\t\t\titems: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\"providerId\",\n\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\"accountId\",\n\t\t\t\t\t\t\t\t\t\t\t\"userId\",\n\t\t\t\t\t\t\t\t\t\t\t\"scopes\",\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (c) => {\n\t\tconst session = c.context.session;\n\t\tconst accounts = await c.context.internalAdapter.findAccounts(\n\t\t\tsession.user.id,\n\t\t);\n\t\treturn c.json(\n\t\t\taccounts.map((a) => {\n\t\t\t\tconst { scope, ...parsed } = parseAccountOutput(c.context.options, a);\n\t\t\t\treturn {\n\t\t\t\t\t...parsed,\n\t\t\t\t\tscopes: scope?.split(\",\") || [],\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t},\n);\n\nexport const linkSocialAccount = createAuthEndpoint(\n\t\"/link-social\",\n\t{\n\t\tmethod: \"POST\",\n\t\trequireHeaders: true,\n\t\tbody: z.object({\n\t\t\t/**\n\t\t\t * Callback URL to redirect to after the user has signed in.\n\t\t\t */\n\t\t\tcallbackURL: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The URL to redirect to after the user has signed in\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * OAuth2 provider to use\n\t\t\t */\n\t\t\tprovider: SocialProviderListEnum,\n\t\t\t/**\n\t\t\t * ID Token for direct authentication without redirect\n\t\t\t */\n\t\t\tidToken: z\n\t\t\t\t.object({\n\t\t\t\t\ttoken: z.string(),\n\t\t\t\t\tnonce: z.string().optional(),\n\t\t\t\t\taccessToken: z.string().optional(),\n\t\t\t\t\trefreshToken: z.string().optional(),\n\t\t\t\t\tscopes: z.array(z.string()).optional(),\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * Whether to allow sign up for new users\n\t\t\t */\n\t\t\trequestSignUp: z.boolean().optional(),\n\t\t\t/**\n\t\t\t * Additional scopes to request when linking the account.\n\t\t\t * This is useful for requesting additional permissions when\n\t\t\t * linking a social account compared to the initial authentication.\n\t\t\t */\n\t\t\tscopes: z\n\t\t\t\t.array(z.string())\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"Additional scopes to request from the provider\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * The URL to redirect to if there is an error during the link process.\n\t\t\t */\n\t\t\terrorCallbackURL: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"The URL to redirect to if there is an error during the link process\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * Disable automatic redirection to the provider\n\t\t\t *\n\t\t\t * This is useful if you want to handle the redirection\n\t\t\t * yourself like in a popup or a different tab.\n\t\t\t */\n\t\t\tdisableRedirect: z\n\t\t\t\t.boolean()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Disable automatic redirection to the provider. Useful for handling the redirection yourself\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * Any additional data to pass through the oauth flow.\n\t\t\t */\n\t\t\tadditionalData: z.record(z.string(), z.any()).optional(),\n\t\t}),\n\t\tuse: [sessionMiddleware],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Link a social account to the user\",\n\t\t\t\toperationId: \"linkSocialAccount\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\turl: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"The authorization URL to redirect the user to\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tredirect: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the user should be redirected to the authorization URL\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"redirect\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (c) => {\n\t\tconst session = c.context.session;\n\n\t\tconst provider = c.context.socialProviders.find(\n\t\t\t(p) => p.id === c.body.provider,\n\t\t);\n\n\t\tif (!provider) {\n\t\t\tc.context.logger.error(\n\t\t\t\t\"Provider not found. Make sure to add the provider in your auth config\",\n\t\t\t\t{\n\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t},\n\t\t\t);\n\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.PROVIDER_NOT_FOUND,\n\t\t\t});\n\t\t}\n\n\t\t// Handle ID Token flow if provided\n\t\tif (c.body.idToken) {\n\t\t\tif (!provider.verifyIdToken) {\n\t\t\t\tc.context.logger.error(\n\t\t\t\t\t\"Provider does not support id token verification\",\n\t\t\t\t\t{\n\t\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.ID_TOKEN_NOT_SUPPORTED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst { token, nonce } = c.body.idToken;\n\t\t\tconst valid = await provider.verifyIdToken(token, nonce);\n\t\t\tif (!valid) {\n\t\t\t\tc.context.logger.error(\"Invalid id token\", {\n\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t});\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_TOKEN,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst linkingUserInfo = await provider.getUserInfo({\n\t\t\t\tidToken: token,\n\t\t\t\taccessToken: c.body.idToken.accessToken,\n\t\t\t\trefreshToken: c.body.idToken.refreshToken,\n\t\t\t});\n\n\t\t\tif (!linkingUserInfo || !linkingUserInfo?.user) {\n\t\t\t\tc.context.logger.error(\"Failed to get user info\", {\n\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t});\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_GET_USER_INFO,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst linkingUserId = String(linkingUserInfo.user.id);\n\n\t\t\tif (!linkingUserInfo.user.email) {\n\t\t\t\tc.context.logger.error(\"User email not found\", {\n\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t});\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_EMAIL_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst existingAccounts = await c.context.internalAdapter.findAccounts(\n\t\t\t\tsession.user.id,\n\t\t\t);\n\n\t\t\tconst hasBeenLinked = existingAccounts.find(\n\t\t\t\t(a) => a.providerId === provider.id && a.accountId === linkingUserId,\n\t\t\t);\n\n\t\t\tif (hasBeenLinked) {\n\t\t\t\treturn c.json({\n\t\t\t\t\turl: \"\", // this is for type inference\n\t\t\t\t\tstatus: true,\n\t\t\t\t\tredirect: false,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst trustedProviders =\n\t\t\t\tc.context.options.account?.accountLinking?.trustedProviders;\n\n\t\t\tconst isTrustedProvider = trustedProviders?.includes(provider.id);\n\t\t\tif (\n\t\t\t\t(!isTrustedProvider && !linkingUserInfo.user.emailVerified) ||\n\t\t\t\tc.context.options.account?.accountLinking?.enabled === false\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: \"Account not linked - linking not allowed\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tlinkingUserInfo.user.email !== session.user.email &&\n\t\t\t\tc.context.options.account?.accountLinking?.allowDifferentEmails !== true\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: \"Account not linked - different emails not allowed\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tawait c.context.internalAdapter.createAccount({\n\t\t\t\t\tuserId: session.user.id,\n\t\t\t\t\tproviderId: provider.id,\n\t\t\t\t\taccountId: linkingUserId,\n\t\t\t\t\taccessToken: c.body.idToken.accessToken,\n\t\t\t\t\tidToken: token,\n\t\t\t\t\trefreshToken: c.body.idToken.refreshToken,\n\t\t\t\t\tscope: c.body.idToken.scopes?.join(\",\"),\n\t\t\t\t});\n\t\t\t} catch {\n\t\t\t\tthrow new APIError(\"EXPECTATION_FAILED\", {\n\t\t\t\t\tmessage: \"Account not linked - unable to create account\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tc.context.options.account?.accountLinking?.updateUserInfoOnLink === true\n\t\t\t) {\n\t\t\t\ttry {\n\t\t\t\t\tawait c.context.internalAdapter.updateUser(session.user.id, {\n\t\t\t\t\t\tname: linkingUserInfo.user?.name,\n\t\t\t\t\t\timage: linkingUserInfo.user?.image,\n\t\t\t\t\t});\n\t\t\t\t} catch (e: any) {\n\t\t\t\t\tconsole.warn(\"Could not update user - \" + e.toString());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn c.json({\n\t\t\t\turl: \"\", // this is for type inference\n\t\t\t\tstatus: true,\n\t\t\t\tredirect: false,\n\t\t\t});\n\t\t}\n\n\t\t// Handle OAuth flow\n\t\tconst state = await generateState(\n\t\t\tc,\n\t\t\t{\n\t\t\t\tuserId: session.user.id,\n\t\t\t\temail: session.user.email,\n\t\t\t},\n\t\t\tc.body.additionalData,\n\t\t);\n\n\t\tconst url = await provider.createAuthorizationURL({\n\t\t\tstate: state.state,\n\t\t\tcodeVerifier: state.codeVerifier,\n\t\t\tredirectURI: `${c.context.baseURL}/callback/${provider.id}`,\n\t\t\tscopes: c.body.scopes,\n\t\t});\n\n\t\tif (!c.body.disableRedirect) {\n\t\t\tc.setHeader(\"Location\", url.toString());\n\t\t}\n\n\t\treturn c.json({\n\t\t\turl: url.toString(),\n\t\t\tredirect: !c.body.disableRedirect,\n\t\t});\n\t},\n);\nexport const unlinkAccount = createAuthEndpoint(\n\t\"/unlink-account\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\tproviderId: z.string(),\n\t\t\taccountId: z.string().optional(),\n\t\t}),\n\t\tuse: [freshSessionMiddleware],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Unlink an account\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst { providerId, accountId } = ctx.body;\n\t\tconst accounts = await ctx.context.internalAdapter.findAccounts(\n\t\t\tctx.context.session.user.id,\n\t\t);\n\t\tif (\n\t\t\taccounts.length === 1 &&\n\t\t\t!ctx.context.options.account?.accountLinking?.allowUnlinkingAll\n\t\t) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_UNLINK_LAST_ACCOUNT,\n\t\t\t});\n\t\t}\n\t\tconst accountExist = accounts.find((account) =>\n\t\t\taccountId\n\t\t\t\t? account.accountId === accountId && account.providerId === providerId\n\t\t\t\t: account.providerId === providerId,\n\t\t);\n\t\tif (!accountExist) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.ACCOUNT_NOT_FOUND,\n\t\t\t});\n\t\t}\n\t\tawait ctx.context.internalAdapter.deleteAccount(accountExist.id);\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n\nexport const getAccessToken = createAuthEndpoint(\n\t\"/get-access-token\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\tproviderId: z.string().meta({\n\t\t\t\tdescription: \"The provider ID for the OAuth provider\",\n\t\t\t}),\n\t\t\taccountId: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The account ID associated with the refresh token\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\tuserId: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The user ID associated with the account\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Get a valid access token, doing a refresh if needed\",\n\t\t\t\tresponses: {\n\t\t\t\t\t200: {\n\t\t\t\t\t\tdescription: \"A Valid access token\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\ttokenType: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tidToken: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\taccessToken: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\taccessTokenExpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t400: {\n\t\t\t\t\t\tdescription: \"Invalid refresh token or provider configuration\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst { providerId, accountId, userId } = ctx.body || {};\n\t\tconst req = ctx.request;\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (req && !session) {\n\t\t\tthrow ctx.error(\"UNAUTHORIZED\");\n\t\t}\n\t\tconst resolvedUserId = session?.user?.id || userId;\n\t\tif (!resolvedUserId) {\n\t\t\tthrow ctx.error(\"UNAUTHORIZED\");\n\t\t}\n\t\tif (!ctx.context.socialProviders.find((p) => p.id === providerId)) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: `Provider ${providerId} is not supported.`,\n\t\t\t});\n\t\t}\n\t\tconst accountData = await getAccountCookie(ctx);\n\t\tlet account: Account | undefined = undefined;\n\t\tif (\n\t\t\taccountData &&\n\t\t\tproviderId === accountData.providerId &&\n\t\t\t(!accountId || accountData.id === accountId)\n\t\t) {\n\t\t\taccount = accountData;\n\t\t} else {\n\t\t\tconst accounts =\n\t\t\t\tawait ctx.context.internalAdapter.findAccounts(resolvedUserId);\n\t\t\taccount = accounts.find((acc) =>\n\t\t\t\taccountId\n\t\t\t\t\t? acc.id === accountId && acc.providerId === providerId\n\t\t\t\t\t: acc.providerId === providerId,\n\t\t\t);\n\t\t}\n\n\t\tif (!account) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Account not found\",\n\t\t\t});\n\t\t}\n\t\tconst provider = ctx.context.socialProviders.find(\n\t\t\t(p) => p.id === providerId,\n\t\t);\n\t\tif (!provider) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: `Provider ${providerId} not found.`,\n\t\t\t});\n\t\t}\n\n\t\ttry {\n\t\t\tlet newTokens: OAuth2Tokens | null = null;\n\t\t\tconst accessTokenExpired =\n\t\t\t\taccount.accessTokenExpiresAt &&\n\t\t\t\tnew Date(account.accessTokenExpiresAt).getTime() - Date.now() < 5_000;\n\t\t\tif (\n\t\t\t\taccount.refreshToken &&\n\t\t\t\taccessTokenExpired &&\n\t\t\t\tprovider.refreshAccessToken\n\t\t\t) {\n\t\t\t\tconst refreshToken = await decryptOAuthToken(\n\t\t\t\t\taccount.refreshToken,\n\t\t\t\t\tctx.context,\n\t\t\t\t);\n\t\t\t\tnewTokens = await provider.refreshAccessToken(refreshToken);\n\t\t\t\tconst updatedData = {\n\t\t\t\t\taccessToken: await setTokenUtil(newTokens.accessToken, ctx.context),\n\t\t\t\t\taccessTokenExpiresAt: newTokens.accessTokenExpiresAt,\n\t\t\t\t\trefreshToken: await setTokenUtil(newTokens.refreshToken, ctx.context),\n\t\t\t\t\trefreshTokenExpiresAt: newTokens.refreshTokenExpiresAt,\n\t\t\t\t};\n\t\t\t\tlet updatedAccount: Record<string, any> | null = null;\n\t\t\t\tif (account.id) {\n\t\t\t\t\tupdatedAccount = await ctx.context.internalAdapter.updateAccount(\n\t\t\t\t\t\taccount.id,\n\t\t\t\t\t\tupdatedData,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif (ctx.context.options.account?.storeAccountCookie) {\n\t\t\t\t\tawait setAccountCookie(ctx, {\n\t\t\t\t\t\t...account,\n\t\t\t\t\t\t...(updatedAccount ?? updatedData),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst accessTokenExpiresAt = (() => {\n\t\t\t\tif (newTokens?.accessTokenExpiresAt) {\n\t\t\t\t\tif (typeof newTokens.accessTokenExpiresAt === \"string\") {\n\t\t\t\t\t\treturn new Date(newTokens.accessTokenExpiresAt);\n\t\t\t\t\t}\n\t\t\t\t\treturn newTokens.accessTokenExpiresAt;\n\t\t\t\t}\n\t\t\t\tif (account.accessTokenExpiresAt) {\n\t\t\t\t\tif (typeof account.accessTokenExpiresAt === \"string\") {\n\t\t\t\t\t\treturn new Date(account.accessTokenExpiresAt);\n\t\t\t\t\t}\n\t\t\t\t\treturn account.accessTokenExpiresAt;\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t})();\n\n\t\t\tconst tokens = {\n\t\t\t\taccessToken:\n\t\t\t\t\tnewTokens?.accessToken ??\n\t\t\t\t\t(await decryptOAuthToken(account.accessToken ?? \"\", ctx.context)),\n\t\t\t\taccessTokenExpiresAt,\n\t\t\t\tscopes: account.scope?.split(\",\") ?? [],\n\t\t\t\tidToken: newTokens?.idToken ?? account.idToken ?? undefined,\n\t\t\t};\n\t\t\treturn ctx.json(tokens);\n\t\t} catch (error) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Failed to get a valid access token\",\n\t\t\t\tcause: error,\n\t\t\t});\n\t\t}\n\t},\n);\n\nexport const refreshToken = createAuthEndpoint(\n\t\"/refresh-token\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\tproviderId: z.string().meta({\n\t\t\t\tdescription: \"The provider ID for the OAuth provider\",\n\t\t\t}),\n\t\t\taccountId: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The account ID associated with the refresh token\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\tuserId: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The user ID associated with the account\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Refresh the access token using a refresh token\",\n\t\t\t\tresponses: {\n\t\t\t\t\t200: {\n\t\t\t\t\t\tdescription: \"Access token refreshed successfully\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\ttokenType: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tidToken: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\taccessToken: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trefreshToken: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\taccessTokenExpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trefreshTokenExpiresAt: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t400: {\n\t\t\t\t\t\tdescription: \"Invalid refresh token or provider configuration\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst { providerId, accountId, userId } = ctx.body;\n\t\tconst req = ctx.request;\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (req && !session) {\n\t\t\tthrow ctx.error(\"UNAUTHORIZED\");\n\t\t}\n\t\tconst resolvedUserId = session?.user?.id || userId;\n\t\tif (!resolvedUserId) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: `Either userId or session is required`,\n\t\t\t});\n\t\t}\n\t\tconst provider = ctx.context.socialProviders.find(\n\t\t\t(p) => p.id === providerId,\n\t\t);\n\t\tif (!provider) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: `Provider ${providerId} not found.`,\n\t\t\t});\n\t\t}\n\t\tif (!provider.refreshAccessToken) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: `Provider ${providerId} does not support token refreshing.`,\n\t\t\t});\n\t\t}\n\n\t\t// Try to read refresh token from cookie first\n\t\tlet account: Account | undefined = undefined;\n\t\tconst accountData = await getAccountCookie(ctx);\n\t\tif (\n\t\t\taccountData &&\n\t\t\t(!providerId || providerId === accountData?.providerId)\n\t\t) {\n\t\t\taccount = accountData;\n\t\t} else {\n\t\t\tconst accounts =\n\t\t\t\tawait ctx.context.internalAdapter.findAccounts(resolvedUserId);\n\t\t\taccount = accounts.find((acc) =>\n\t\t\t\taccountId\n\t\t\t\t\t? acc.id === accountId && acc.providerId === providerId\n\t\t\t\t\t: acc.providerId === providerId,\n\t\t\t);\n\t\t}\n\n\t\tif (!account) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Account not found\",\n\t\t\t});\n\t\t}\n\n\t\tlet refreshToken: string | null | undefined = undefined;\n\t\tif (accountData && providerId === accountData.providerId) {\n\t\t\trefreshToken = accountData.refreshToken ?? undefined;\n\t\t} else {\n\t\t\trefreshToken = account.refreshToken ?? undefined;\n\t\t}\n\n\t\tif (!refreshToken) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Refresh token not found\",\n\t\t\t});\n\t\t}\n\n\t\ttry {\n\t\t\tconst decryptedRefreshToken = await decryptOAuthToken(\n\t\t\t\trefreshToken,\n\t\t\t\tctx.context,\n\t\t\t);\n\t\t\tconst tokens: OAuth2Tokens = await provider.refreshAccessToken(\n\t\t\t\tdecryptedRefreshToken,\n\t\t\t);\n\n\t\t\tif (account.id) {\n\t\t\t\tconst updateData = {\n\t\t\t\t\t...(account || {}),\n\t\t\t\t\taccessToken: await setTokenUtil(tokens.accessToken, ctx.context),\n\t\t\t\t\trefreshToken: await setTokenUtil(tokens.refreshToken, ctx.context),\n\t\t\t\t\taccessTokenExpiresAt: tokens.accessTokenExpiresAt,\n\t\t\t\t\trefreshTokenExpiresAt: tokens.refreshTokenExpiresAt,\n\t\t\t\t\tscope: tokens.scopes?.join(\",\") || account.scope,\n\t\t\t\t\tidToken: tokens.idToken || account.idToken,\n\t\t\t\t};\n\t\t\t\tawait ctx.context.internalAdapter.updateAccount(account.id, updateData);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\taccountData &&\n\t\t\t\tproviderId === accountData.providerId &&\n\t\t\t\tctx.context.options.account?.storeAccountCookie\n\t\t\t) {\n\t\t\t\tconst updateData = {\n\t\t\t\t\t...accountData,\n\t\t\t\t\taccessToken: await setTokenUtil(tokens.accessToken, ctx.context),\n\t\t\t\t\trefreshToken: await setTokenUtil(tokens.refreshToken, ctx.context),\n\t\t\t\t\taccessTokenExpiresAt: tokens.accessTokenExpiresAt,\n\t\t\t\t\trefreshTokenExpiresAt: tokens.refreshTokenExpiresAt,\n\t\t\t\t\tscope: tokens.scopes?.join(\",\") || accountData.scope,\n\t\t\t\t\tidToken: tokens.idToken || accountData.idToken,\n\t\t\t\t};\n\t\t\t\tawait setAccountCookie(ctx, updateData);\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\taccessToken: tokens.accessToken,\n\t\t\t\trefreshToken: tokens.refreshToken,\n\t\t\t\taccessTokenExpiresAt: tokens.accessTokenExpiresAt,\n\t\t\t\trefreshTokenExpiresAt: tokens.refreshTokenExpiresAt,\n\t\t\t\tscope: tokens.scopes?.join(\",\") || account.scope,\n\t\t\t\tidToken: tokens.idToken || account.idToken,\n\t\t\t\tproviderId: account.providerId,\n\t\t\t\taccountId: account.accountId,\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Failed to refresh access token\",\n\t\t\t\tcause: error,\n\t\t\t});\n\t\t}\n\t},\n);\n\nconst accountInfoQuerySchema = z.optional(\n\tz.object({\n\t\taccountId: z\n\t\t\t.string()\n\t\t\t.meta({\n\t\t\t\tdescription:\n\t\t\t\t\t\"The provider given account id for which to get the account info\",\n\t\t\t})\n\t\t\t.optional(),\n\t}),\n);\n\nexport const accountInfo = createAuthEndpoint(\n\t\"/account-info\",\n\t{\n\t\tmethod: \"GET\",\n\t\tuse: [sessionMiddleware],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Get the account info provided by the provider\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\temailVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequired: [\"id\", \"emailVerified\"],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {},\n\t\t\t\t\t\t\t\t\t\t\tadditionalProperties: true,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"user\", \"data\"],\n\t\t\t\t\t\t\t\t\tadditionalProperties: false,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tquery: accountInfoQuerySchema,\n\t},\n\tasync (ctx) => {\n\t\tconst providedAccountId = ctx.query?.accountId;\n\t\tlet account: Account | undefined = undefined;\n\t\tif (!providedAccountId) {\n\t\t\tif (ctx.context.options.account?.storeAccountCookie) {\n\t\t\t\tconst accountData = await getAccountCookie(ctx);\n\t\t\t\tif (accountData) {\n\t\t\t\t\taccount = accountData;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tconst accountData =\n\t\t\t\tawait ctx.context.internalAdapter.findAccount(providedAccountId);\n\t\t\tif (accountData) {\n\t\t\t\taccount = accountData;\n\t\t\t}\n\t\t}\n\n\t\tif (!account || account.userId !== ctx.context.session.user.id) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Account not found\",\n\t\t\t});\n\t\t}\n\n\t\tconst provider = ctx.context.socialProviders.find(\n\t\t\t(p) => p.id === account.providerId,\n\t\t);\n\n\t\tif (!provider) {\n\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\tmessage: `Provider account provider is ${account.providerId} but it is not configured`,\n\t\t\t});\n\t\t}\n\t\tconst tokens = await getAccessToken({\n\t\t\t...ctx,\n\t\t\tmethod: \"POST\",\n\t\t\tbody: {\n\t\t\t\taccountId: account.id,\n\t\t\t\tproviderId: account.providerId,\n\t\t\t},\n\t\t\treturnHeaders: false,\n\t\t\treturnStatus: false,\n\t\t});\n\t\tif (!tokens.accessToken) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Access token not found\",\n\t\t\t});\n\t\t}\n\t\tconst info = await provider.getUserInfo({\n\t\t\t...tokens,\n\t\t\taccessToken: tokens.accessToken as string,\n\t\t});\n\t\treturn ctx.json(info);\n\t},\n);\n"],"names":["e: any","account: Account | undefined","newTokens: OAuth2Tokens | null","refreshToken","updatedAccount: Record<string, any> | null","refreshToken: string | null | undefined","tokens: OAuth2Tokens"],"mappings":"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"}},
    {"offset": {"line": 1634, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/email-verification.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/email-verification.ts"],"sourcesContent":["import type { GenericEndpointContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport type { JWTPayload, JWTVerifyResult } from \"jose\";\nimport { jwtVerify } from \"jose\";\nimport { JWTExpired } from \"jose/errors\";\nimport * as z from \"zod\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { signJWT } from \"../../crypto/jwt\";\nimport { parseUserOutput } from \"../../db/schema\";\nimport type { User } from \"../../types\";\nimport { originCheck } from \"../middlewares\";\nimport { getSessionFromCtx } from \"./session\";\n\nexport async function createEmailVerificationToken(\n\tsecret: string,\n\temail: string,\n\t/**\n\t * The email to update from\n\t */\n\tupdateTo?: string | undefined,\n\t/**\n\t * The time in seconds for the token to expire\n\t */\n\texpiresIn: number = 3600,\n\t/**\n\t * Extra payload to include in the token\n\t */\n\textraPayload?: Record<string, any>,\n) {\n\tconst token = await signJWT(\n\t\t{\n\t\t\temail: email.toLowerCase(),\n\t\t\tupdateTo,\n\t\t\t...extraPayload,\n\t\t},\n\t\tsecret,\n\t\texpiresIn,\n\t);\n\treturn token;\n}\n\n/**\n * A function to send a verification email to the user\n */\nexport async function sendVerificationEmailFn(\n\tctx: GenericEndpointContext,\n\tuser: User,\n) {\n\tif (!ctx.context.options.emailVerification?.sendVerificationEmail) {\n\t\tctx.context.logger.error(\"Verification email isn't enabled.\");\n\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\tmessage: \"Verification email isn't enabled\",\n\t\t});\n\t}\n\tconst token = await createEmailVerificationToken(\n\t\tctx.context.secret,\n\t\tuser.email,\n\t\tundefined,\n\t\tctx.context.options.emailVerification?.expiresIn,\n\t);\n\tconst callbackURL = ctx.body.callbackURL\n\t\t? encodeURIComponent(ctx.body.callbackURL)\n\t\t: encodeURIComponent(\"/\");\n\tconst url = `${ctx.context.baseURL}/verify-email?token=${token}&callbackURL=${callbackURL}`;\n\tawait ctx.context.runInBackgroundOrAwait(\n\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t{\n\t\t\t\tuser: user,\n\t\t\t\turl,\n\t\t\t\ttoken,\n\t\t\t},\n\t\t\tctx.request,\n\t\t),\n\t);\n}\nexport const sendVerificationEmail = createAuthEndpoint(\n\t\"/send-verification-email\",\n\t{\n\t\tmethod: \"POST\",\n\t\toperationId: \"sendVerificationEmail\",\n\t\tbody: z.object({\n\t\t\temail: z.email().meta({\n\t\t\t\tdescription: \"The email to send the verification email to\",\n\t\t\t}),\n\t\t\tcallbackURL: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The URL to use for email verification callback\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"sendVerificationEmail\",\n\t\t\t\tdescription: \"Send a verification email to the user\",\n\t\t\t\trequestBody: {\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The email to send the verification email to\",\n\t\t\t\t\t\t\t\t\t\texample: \"user@example.com\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tcallbackURL: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\"The URL to use for email verification callback\",\n\t\t\t\t\t\t\t\t\t\texample: \"https://example.com/callback\",\n\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\trequired: [\"email\"],\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the email was sent successfully\",\n\t\t\t\t\t\t\t\t\t\t\texample: true,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t\"400\": {\n\t\t\t\t\t\tdescription: \"Bad Request\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Error message\",\n\t\t\t\t\t\t\t\t\t\t\texample: \"Verification email isn't enabled\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tif (!ctx.context.options.emailVerification?.sendVerificationEmail) {\n\t\t\tctx.context.logger.error(\"Verification email isn't enabled.\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Verification email isn't enabled\",\n\t\t\t});\n\t\t}\n\t\tconst { email } = ctx.body;\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (!session) {\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\tif (!user) {\n\t\t\t\tawait createEmailVerificationToken(\n\t\t\t\t\tctx.context.secret,\n\t\t\t\t\temail,\n\t\t\t\t\tundefined,\n\t\t\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t\t);\n\t\t\t\t//we're returning true to avoid leaking information about the user\n\t\t\t\treturn ctx.json({\n\t\t\t\t\tstatus: true,\n\t\t\t\t});\n\t\t\t}\n\t\t\tawait sendVerificationEmailFn(ctx, user.user);\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t}\n\t\tif (session?.user.email !== email) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.EMAIL_MISMATCH,\n\t\t\t});\n\t\t}\n\t\tif (session?.user.emailVerified) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.EMAIL_ALREADY_VERIFIED,\n\t\t\t});\n\t\t}\n\t\tawait sendVerificationEmailFn(ctx, session.user);\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n\nexport const verifyEmail = createAuthEndpoint(\n\t\"/verify-email\",\n\t{\n\t\tmethod: \"GET\",\n\t\toperationId: \"verifyEmail\",\n\t\tquery: z.object({\n\t\t\ttoken: z.string().meta({\n\t\t\t\tdescription: \"The token to verify the email\",\n\t\t\t}),\n\t\t\tcallbackURL: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The URL to redirect to after email verification\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tuse: [originCheck((ctx) => ctx.query.callbackURL)],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Verify the email of the user\",\n\t\t\t\tparameters: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"token\",\n\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\tdescription: \"The token to verify the email\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"callbackURL\",\n\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\tdescription: \"The URL to redirect to after email verification\",\n\t\t\t\t\t\trequired: false,\n\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"Indicates if the email was verified successfully\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"user\", \"status\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tfunction redirectOnError(error: string) {\n\t\t\tif (ctx.query.callbackURL) {\n\t\t\t\tif (ctx.query.callbackURL.includes(\"?\")) {\n\t\t\t\t\tthrow ctx.redirect(`${ctx.query.callbackURL}&error=${error}`);\n\t\t\t\t}\n\t\t\t\tthrow ctx.redirect(`${ctx.query.callbackURL}?error=${error}`);\n\t\t\t}\n\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\tmessage: error,\n\t\t\t});\n\t\t}\n\t\tconst { token } = ctx.query;\n\t\tlet jwt: JWTVerifyResult<JWTPayload>;\n\t\ttry {\n\t\t\tjwt = await jwtVerify(\n\t\t\t\ttoken,\n\t\t\t\tnew TextEncoder().encode(ctx.context.secret),\n\t\t\t\t{\n\t\t\t\t\talgorithms: [\"HS256\"],\n\t\t\t\t},\n\t\t\t);\n\t\t} catch (e) {\n\t\t\tif (e instanceof JWTExpired) {\n\t\t\t\treturn redirectOnError(\"token_expired\");\n\t\t\t}\n\t\t\treturn redirectOnError(\"invalid_token\");\n\t\t}\n\t\tconst schema = z.object({\n\t\t\temail: z.email(),\n\t\t\tupdateTo: z.string().optional(),\n\t\t\trequestType: z.string().optional(),\n\t\t});\n\t\tconst parsed = schema.parse(jwt.payload);\n\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(\n\t\t\tparsed.email,\n\t\t);\n\t\tif (!user) {\n\t\t\treturn redirectOnError(\"user_not_found\");\n\t\t}\n\t\tif (parsed.updateTo) {\n\t\t\tconst session = await getSessionFromCtx(ctx);\n\t\t\tif (session && session.user.email !== parsed.email) {\n\t\t\t\treturn redirectOnError(\"unauthorized\");\n\t\t\t}\n\t\t\tswitch (parsed.requestType) {\n\t\t\t\t/**\n\t\t\t\t * User clicks confirmation -> sends verification to new email\n\t\t\t\t */\n\t\t\t\tcase \"change-email-confirmation\": {\n\t\t\t\t\tconst newToken = await createEmailVerificationToken(\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\tparsed.email,\n\t\t\t\t\t\tparsed.updateTo,\n\t\t\t\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t\t\t\t{ requestType: \"change-email-verification\" },\n\t\t\t\t\t);\n\t\t\t\t\tconst updateCallbackURL = ctx.query.callbackURL\n\t\t\t\t\t\t? encodeURIComponent(ctx.query.callbackURL)\n\t\t\t\t\t\t: encodeURIComponent(\"/\");\n\t\t\t\t\tconst url = `${ctx.context.baseURL}/verify-email?token=${newToken}&callbackURL=${updateCallbackURL}`;\n\t\t\t\t\tif (ctx.context.options.emailVerification?.sendVerificationEmail) {\n\t\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tuser: { ...user.user, email: parsed.updateTo },\n\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t\ttoken: newToken,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif (ctx.query.callbackURL) {\n\t\t\t\t\t\tthrow ctx.redirect(ctx.query.callbackURL);\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({ status: true });\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * User clicks verification -> updates email\n\t\t\t\t */\n\t\t\t\tcase \"change-email-verification\": {\n\t\t\t\t\tlet activeSession = session;\n\t\t\t\t\tif (!activeSession) {\n\t\t\t\t\t\tconst newSession = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\t\tuser.user.id,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (!newSession) {\n\t\t\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tactiveSession = {\n\t\t\t\t\t\t\tsession: newSession,\n\t\t\t\t\t\t\tuser: user.user,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\tif (ctx.context.options.emailVerification?.onEmailVerification) {\n\t\t\t\t\t\tawait ctx.context.options.emailVerification.onEmailVerification(\n\t\t\t\t\t\t\tuser.user,\n\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tconst updatedUser =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.updateUserByEmail(parsed.email, {\n\t\t\t\t\t\t\temail: parsed.updateTo,\n\t\t\t\t\t\t\temailVerified: true,\n\t\t\t\t\t\t});\n\t\t\t\t\tif (ctx.context.options.emailVerification?.afterEmailVerification) {\n\t\t\t\t\t\tawait ctx.context.options.emailVerification.afterEmailVerification(\n\t\t\t\t\t\t\tupdatedUser,\n\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tsession: activeSession.session,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t...activeSession.user,\n\t\t\t\t\t\t\temail: parsed.updateTo,\n\t\t\t\t\t\t\temailVerified: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tif (ctx.query.callbackURL) {\n\t\t\t\t\t\tthrow ctx.redirect(ctx.query.callbackURL);\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tstatus: true,\n\t\t\t\t\t\tuser: parseUserOutput(ctx.context.options, updatedUser),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * Legacy flow\n\t\t\t\t *\n\t\t\t\t * - skips two-step verification\n\t\t\t\t * - updates email immediately\n\t\t\t\t */\n\t\t\t\tdefault: {\n\t\t\t\t\tlet activeSession = session;\n\t\t\t\t\tif (!activeSession) {\n\t\t\t\t\t\tconst newSession = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\t\t\tuser.user.id,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (!newSession) {\n\t\t\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tactiveSession = {\n\t\t\t\t\t\t\tsession: newSession,\n\t\t\t\t\t\t\tuser: user.user,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\tconst updatedUser =\n\t\t\t\t\t\tawait ctx.context.internalAdapter.updateUserByEmail(parsed.email, {\n\t\t\t\t\t\t\temail: parsed.updateTo,\n\t\t\t\t\t\t\temailVerified: false,\n\t\t\t\t\t\t});\n\t\t\t\t\tconst newToken = await createEmailVerificationToken(\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\tparsed.updateTo,\n\t\t\t\t\t);\n\t\t\t\t\tconst updateCallbackURL = ctx.query.callbackURL\n\t\t\t\t\t\t? encodeURIComponent(ctx.query.callbackURL)\n\t\t\t\t\t\t: encodeURIComponent(\"/\");\n\t\t\t\t\tif (ctx.context.options.emailVerification?.sendVerificationEmail) {\n\t\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tuser: updatedUser,\n\t\t\t\t\t\t\t\t\turl: `${ctx.context.baseURL}/verify-email?token=${newToken}&callbackURL=${updateCallbackURL}`,\n\t\t\t\t\t\t\t\t\ttoken: newToken,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\t\tsession: activeSession.session,\n\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t...activeSession.user,\n\t\t\t\t\t\t\temail: parsed.updateTo,\n\t\t\t\t\t\t\temailVerified: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\tif (ctx.query.callbackURL) {\n\t\t\t\t\t\tthrow ctx.redirect(ctx.query.callbackURL);\n\t\t\t\t\t}\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\tstatus: true,\n\t\t\t\t\t\tuser: parseUserOutput(ctx.context.options, updatedUser),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (user.user.emailVerified) {\n\t\t\tif (ctx.query.callbackURL) {\n\t\t\t\tthrow ctx.redirect(ctx.query.callbackURL);\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t\tuser: null,\n\t\t\t});\n\t\t}\n\t\tif (ctx.context.options.emailVerification?.beforeEmailVerification) {\n\t\t\tawait ctx.context.options.emailVerification.beforeEmailVerification(\n\t\t\t\tuser.user,\n\t\t\t\tctx.request,\n\t\t\t);\n\t\t}\n\t\tif (ctx.context.options.emailVerification?.onEmailVerification) {\n\t\t\tawait ctx.context.options.emailVerification.onEmailVerification(\n\t\t\t\tuser.user,\n\t\t\t\tctx.request,\n\t\t\t);\n\t\t}\n\t\tconst updatedUser = await ctx.context.internalAdapter.updateUserByEmail(\n\t\t\tparsed.email,\n\t\t\t{\n\t\t\t\temailVerified: true,\n\t\t\t},\n\t\t);\n\t\tif (ctx.context.options.emailVerification?.afterEmailVerification) {\n\t\t\tawait ctx.context.options.emailVerification.afterEmailVerification(\n\t\t\t\tupdatedUser,\n\t\t\t\tctx.request,\n\t\t\t);\n\t\t}\n\t\tif (ctx.context.options.emailVerification?.autoSignInAfterVerification) {\n\t\t\tconst currentSession = await getSessionFromCtx(ctx);\n\t\t\tif (!currentSession || currentSession.user.email !== parsed.email) {\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tuser.user.id,\n\t\t\t\t);\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\t\tmessage: \"Failed to create session\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\t...user.user,\n\t\t\t\t\t\temailVerified: true,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\t\tsession: currentSession.session,\n\t\t\t\t\tuser: {\n\t\t\t\t\t\t...currentSession.user,\n\t\t\t\t\t\temailVerified: true,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (ctx.query.callbackURL) {\n\t\t\tthrow ctx.redirect(ctx.query.callbackURL);\n\t\t}\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t\tuser: null,\n\t\t});\n\t},\n);\n"],"names":["jwt: JWTVerifyResult<JWTPayload>","updatedUser"],"mappings":"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"}},
    {"offset": {"line": 2045, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/callback.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/callback.ts"],"sourcesContent":["import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport type { OAuth2Tokens } from \"@better-auth/core/oauth2\";\nimport { safeJSONParse } from \"@better-auth/core/utils\";\nimport * as z from \"zod\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { handleOAuthUserInfo } from \"../../oauth2/link-account\";\nimport { parseState } from \"../../oauth2/state\";\nimport { setTokenUtil } from \"../../oauth2/utils\";\nimport { HIDE_METADATA } from \"../../utils/hide-metadata\";\n\nconst schema = z.object({\n\tcode: z.string().optional(),\n\terror: z.string().optional(),\n\tdevice_id: z.string().optional(),\n\terror_description: z.string().optional(),\n\tstate: z.string().optional(),\n\tuser: z.string().optional(),\n});\n\nexport const callbackOAuth = createAuthEndpoint(\n\t\"/callback/:id\",\n\t{\n\t\tmethod: [\"GET\", \"POST\"],\n\t\toperationId: \"handleOAuthCallback\",\n\t\tbody: schema.optional(),\n\t\tquery: schema.optional(),\n\t\tmetadata: {\n\t\t\t...HIDE_METADATA,\n\t\t\tallowedMediaTypes: [\n\t\t\t\t\"application/x-www-form-urlencoded\",\n\t\t\t\t\"application/json\",\n\t\t\t],\n\t\t},\n\t},\n\tasync (c) => {\n\t\tlet queryOrBody: z.infer<typeof schema>;\n\t\tconst defaultErrorURL =\n\t\t\tc.context.options.onAPIError?.errorURL || `${c.context.baseURL}/error`;\n\n\t\t// Handle POST requests by redirecting to GET to ensure cookies are sent\n\t\tif (c.method === \"POST\") {\n\t\t\tconst postData = c.body ? schema.parse(c.body) : {};\n\t\t\tconst queryData = c.query ? schema.parse(c.query) : {};\n\n\t\t\tconst mergedData = schema.parse({ ...postData, ...queryData });\n\t\t\tconst params = new URLSearchParams();\n\n\t\t\tfor (const [key, value] of Object.entries(mergedData)) {\n\t\t\t\tif (value !== undefined && value !== null) {\n\t\t\t\t\tparams.set(key, String(value));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst redirectURL = `${c.context.baseURL}/callback/${c.params.id}?${params.toString()}`;\n\t\t\tthrow c.redirect(redirectURL);\n\t\t}\n\n\t\ttry {\n\t\t\tif (c.method === \"GET\") {\n\t\t\t\tqueryOrBody = schema.parse(c.query);\n\t\t\t} else if (c.method === \"POST\") {\n\t\t\t\tqueryOrBody = schema.parse(c.body);\n\t\t\t} else {\n\t\t\t\tthrow new Error(\"Unsupported method\");\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tc.context.logger.error(\"INVALID_CALLBACK_REQUEST\", e);\n\t\t\tthrow c.redirect(`${defaultErrorURL}?error=invalid_callback_request`);\n\t\t}\n\n\t\tconst {\n\t\t\tcode,\n\t\t\terror,\n\t\t\tstate,\n\t\t\terror_description,\n\t\t\tdevice_id,\n\t\t\tuser: userData,\n\t\t} = queryOrBody;\n\n\t\tif (!state) {\n\t\t\tc.context.logger.error(\"State not found\", error);\n\t\t\tconst sep = defaultErrorURL.includes(\"?\") ? \"&\" : \"?\";\n\t\t\tconst url = `${defaultErrorURL}${sep}state=state_not_found`;\n\t\t\tthrow c.redirect(url);\n\t\t}\n\n\t\tconst {\n\t\t\tcodeVerifier,\n\t\t\tcallbackURL,\n\t\t\tlink,\n\t\t\terrorURL,\n\t\t\tnewUserURL,\n\t\t\trequestSignUp,\n\t\t} = await parseState(c);\n\n\t\tfunction redirectOnError(error: string, description?: string | undefined) {\n\t\t\tconst baseURL = errorURL ?? defaultErrorURL;\n\n\t\t\tconst params = new URLSearchParams({ error });\n\t\t\tif (description) params.set(\"error_description\", description);\n\n\t\t\tconst sep = baseURL.includes(\"?\") ? \"&\" : \"?\";\n\t\t\tconst url = `${baseURL}${sep}${params.toString()}`;\n\n\t\t\tthrow c.redirect(url);\n\t\t}\n\n\t\tif (error) {\n\t\t\tredirectOnError(error, error_description);\n\t\t}\n\n\t\tif (!code) {\n\t\t\tc.context.logger.error(\"Code not found\");\n\t\t\tthrow redirectOnError(\"no_code\");\n\t\t}\n\t\tconst provider = c.context.socialProviders.find(\n\t\t\t(p) => p.id === c.params.id,\n\t\t);\n\n\t\tif (!provider) {\n\t\t\tc.context.logger.error(\n\t\t\t\t\"Oauth provider with id\",\n\t\t\t\tc.params.id,\n\t\t\t\t\"not found\",\n\t\t\t);\n\t\t\tthrow redirectOnError(\"oauth_provider_not_found\");\n\t\t}\n\n\t\tlet tokens: OAuth2Tokens | null;\n\t\ttry {\n\t\t\ttokens = await provider.validateAuthorizationCode({\n\t\t\t\tcode: code,\n\t\t\t\tcodeVerifier,\n\t\t\t\tdeviceId: device_id,\n\t\t\t\tredirectURI: `${c.context.baseURL}/callback/${provider.id}`,\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tc.context.logger.error(\"\", e);\n\t\t\tthrow redirectOnError(\"invalid_code\");\n\t\t}\n\t\tif (!tokens) {\n\t\t\tthrow redirectOnError(\"invalid_code\");\n\t\t}\n\t\tconst parsedUserData = userData\n\t\t\t? safeJSONParse<{\n\t\t\t\t\tname?: {\n\t\t\t\t\t\tfirstName?: string;\n\t\t\t\t\t\tlastName?: string;\n\t\t\t\t\t};\n\t\t\t\t\temail?: string;\n\t\t\t\t}>(userData)\n\t\t\t: null;\n\n\t\tconst userInfo = await provider\n\t\t\t.getUserInfo({\n\t\t\t\t...tokens,\n\t\t\t\t/**\n\t\t\t\t * The user object from the provider\n\t\t\t\t * This is only available for some providers like Apple\n\t\t\t\t */\n\t\t\t\tuser: parsedUserData ?? undefined,\n\t\t\t})\n\t\t\t.then((res) => res?.user);\n\n\t\tif (!userInfo) {\n\t\t\tc.context.logger.error(\"Unable to get user info\");\n\t\t\treturn redirectOnError(\"unable_to_get_user_info\");\n\t\t}\n\n\t\tif (!callbackURL) {\n\t\t\tc.context.logger.error(\"No callback URL found\");\n\t\t\tthrow redirectOnError(\"no_callback_url\");\n\t\t}\n\n\t\tif (link) {\n\t\t\tconst trustedProviders =\n\t\t\t\tc.context.options.account?.accountLinking?.trustedProviders;\n\t\t\tconst isTrustedProvider = trustedProviders?.includes(provider.id);\n\t\t\tif (\n\t\t\t\t(!isTrustedProvider && !userInfo.emailVerified) ||\n\t\t\t\tc.context.options.account?.accountLinking?.enabled === false\n\t\t\t) {\n\t\t\t\tc.context.logger.error(\"Unable to link account - untrusted provider\");\n\t\t\t\treturn redirectOnError(\"unable_to_link_account\");\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tuserInfo.email !== link.email &&\n\t\t\t\tc.context.options.account?.accountLinking?.allowDifferentEmails !== true\n\t\t\t) {\n\t\t\t\treturn redirectOnError(\"email_doesn't_match\");\n\t\t\t}\n\n\t\t\tconst existingAccount = await c.context.internalAdapter.findAccount(\n\t\t\t\tString(userInfo.id),\n\t\t\t);\n\n\t\t\tif (existingAccount) {\n\t\t\t\tif (existingAccount.userId.toString() !== link.userId.toString()) {\n\t\t\t\t\treturn redirectOnError(\"account_already_linked_to_different_user\");\n\t\t\t\t}\n\t\t\t\tconst updateData = Object.fromEntries(\n\t\t\t\t\tObject.entries({\n\t\t\t\t\t\taccessToken: await setTokenUtil(tokens.accessToken, c.context),\n\t\t\t\t\t\trefreshToken: await setTokenUtil(tokens.refreshToken, c.context),\n\t\t\t\t\t\tidToken: tokens.idToken,\n\t\t\t\t\t\taccessTokenExpiresAt: tokens.accessTokenExpiresAt,\n\t\t\t\t\t\trefreshTokenExpiresAt: tokens.refreshTokenExpiresAt,\n\t\t\t\t\t\tscope: tokens.scopes?.join(\",\"),\n\t\t\t\t\t}).filter(([_, value]) => value !== undefined),\n\t\t\t\t);\n\t\t\t\tawait c.context.internalAdapter.updateAccount(\n\t\t\t\t\texistingAccount.id,\n\t\t\t\t\tupdateData,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tconst newAccount = await c.context.internalAdapter.createAccount({\n\t\t\t\t\tuserId: link.userId,\n\t\t\t\t\tproviderId: provider.id,\n\t\t\t\t\taccountId: String(userInfo.id),\n\t\t\t\t\t...tokens,\n\t\t\t\t\taccessToken: await setTokenUtil(tokens.accessToken, c.context),\n\t\t\t\t\trefreshToken: await setTokenUtil(tokens.refreshToken, c.context),\n\t\t\t\t\tscope: tokens.scopes?.join(\",\"),\n\t\t\t\t});\n\t\t\t\tif (!newAccount) {\n\t\t\t\t\treturn redirectOnError(\"unable_to_link_account\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tlet toRedirectTo: string;\n\t\t\ttry {\n\t\t\t\tconst url = callbackURL;\n\t\t\t\ttoRedirectTo = url.toString();\n\t\t\t} catch {\n\t\t\t\ttoRedirectTo = callbackURL;\n\t\t\t}\n\t\t\tthrow c.redirect(toRedirectTo);\n\t\t}\n\n\t\tif (!userInfo.email) {\n\t\t\tc.context.logger.error(\n\t\t\t\t\"Provider did not return email. This could be due to misconfiguration in the provider settings.\",\n\t\t\t);\n\t\t\treturn redirectOnError(\"email_not_found\");\n\t\t}\n\t\tconst accountData = {\n\t\t\tproviderId: provider.id,\n\t\t\taccountId: String(userInfo.id),\n\t\t\t...tokens,\n\t\t\tscope: tokens.scopes?.join(\",\"),\n\t\t};\n\t\tconst result = await handleOAuthUserInfo(c, {\n\t\t\tuserInfo: {\n\t\t\t\t...userInfo,\n\t\t\t\tid: String(userInfo.id),\n\t\t\t\temail: userInfo.email,\n\t\t\t\tname: userInfo.name || userInfo.email,\n\t\t\t},\n\t\t\taccount: accountData,\n\t\t\tcallbackURL,\n\t\t\tdisableSignUp:\n\t\t\t\t(provider.disableImplicitSignUp && !requestSignUp) ||\n\t\t\t\tprovider.options?.disableSignUp,\n\t\t\toverrideUserInfo: provider.options?.overrideUserInfoOnSignIn,\n\t\t});\n\t\tif (result.error) {\n\t\t\tc.context.logger.error(result.error.split(\" \").join(\"_\"));\n\t\t\treturn redirectOnError(result.error.split(\" \").join(\"_\"));\n\t\t}\n\t\tconst { session, user } = result.data!;\n\t\tawait setSessionCookie(c, {\n\t\t\tsession,\n\t\t\tuser,\n\t\t});\n\n\t\tlet toRedirectTo: string;\n\t\ttry {\n\t\t\tconst url = result.isRegister ? newUserURL || callbackURL : callbackURL;\n\t\t\ttoRedirectTo = url.toString();\n\t\t} catch {\n\t\t\ttoRedirectTo = result.isRegister\n\t\t\t\t? newUserURL || callbackURL\n\t\t\t\t: callbackURL;\n\t\t}\n\t\tthrow c.redirect(toRedirectTo);\n\t},\n);\n"],"names":["queryOrBody: z.infer<typeof schema>","tokens: OAuth2Tokens | null","toRedirectTo: string","toRedirectTo"],"mappings":"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"}},
    {"offset": {"line": 2245, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/error.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/error.ts"],"sourcesContent":["import type { BetterAuthOptions } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { isProduction } from \"@better-auth/core/env\";\nimport { HIDE_METADATA } from \"../../utils/hide-metadata\";\n\nfunction sanitize(input: string): string {\n\t// Replace & last to avoid double-encoding existing HTML entities\n\t// Match & only when it's not already part of an HTML entity\n\treturn input\n\t\t.replace(/</g, \"&lt;\")\n\t\t.replace(/>/g, \"&gt;\")\n\t\t.replace(/\"/g, \"&quot;\")\n\t\t.replace(/'/g, \"&#39;\")\n\t\t.replace(/&(?!amp;|lt;|gt;|quot;|#39;|#x[0-9a-fA-F]+;|#[0-9]+;)/g, \"&amp;\");\n}\n\nconst html = (\n\toptions: BetterAuthOptions,\n\tcode: string = \"Unknown\",\n\tdescription: string | null = null,\n) => {\n\tconst custom = options.onAPIError?.customizeDefaultErrorPage;\n\treturn `<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>Error</title>\n    <style>\n      * {\n        box-sizing: border-box;\n      }\n      body {\n        font-family: ${custom?.font?.defaultFamily || \"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif\"};\n        background: ${custom?.colors?.background || \"var(--background)\"};\n        color: var(--foreground);\n        margin: 0;\n      }\n      :root,\n      :host {\n        --spacing: 0.25rem;\n        --container-md: 28rem;\n        --text-sm: ${custom?.size?.textSm || \"0.875rem\"};\n        --text-sm--line-height: calc(1.25 / 0.875);\n        --text-2xl: ${custom?.size?.text2xl || \"1.5rem\"};\n        --text-2xl--line-height: calc(2 / 1.5);\n        --text-4xl: ${custom?.size?.text4xl || \"2.25rem\"};\n        --text-4xl--line-height: calc(2.5 / 2.25);\n        --text-6xl: ${custom?.size?.text6xl || \"3rem\"};\n        --text-6xl--line-height: 1;\n        --font-weight-medium: 500;\n        --font-weight-semibold: 600;\n        --font-weight-bold: 700;\n        --default-transition-duration: 150ms;\n        --default-transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n        --radius: ${custom?.size?.radiusSm || \"0.625rem\"};\n        --default-mono-font-family: ${custom?.font?.monoFamily || \"var(--font-geist-mono)\"};\n        --primary: ${custom?.colors?.primary || \"black\"};\n        --primary-foreground: ${custom?.colors?.primaryForeground || \"white\"};\n        --background: ${custom?.colors?.background || \"white\"};\n        --foreground: ${custom?.colors?.foreground || \"oklch(0.271 0 0)\"};\n        --border: ${custom?.colors?.border || \"oklch(0.89 0 0)\"};\n        --destructive: ${custom?.colors?.destructive || \"oklch(0.55 0.15 25.723)\"};\n        --muted-foreground: ${custom?.colors?.mutedForeground || \"oklch(0.545 0 0)\"};\n        --corner-border: ${custom?.colors?.cornerBorder || \"#404040\"};\n      }\n\n      button, .btn {\n        cursor: pointer;\n        background: none;\n        border: none;\n        color: inherit;\n        font: inherit;\n        transition: all var(--default-transition-duration)\n          var(--default-transition-timing-function);\n      }\n      button:hover, .btn:hover {\n        opacity: 0.8;\n      }\n\n      @media (prefers-color-scheme: dark) {\n        :root,\n        :host {\n          --primary: ${custom?.colors?.primary || \"white\"};\n          --primary-foreground: ${custom?.colors?.primaryForeground || \"black\"};\n          --background: ${custom?.colors?.background || \"oklch(0.15 0 0)\"};\n          --foreground: ${custom?.colors?.foreground || \"oklch(0.98 0 0)\"};\n          --border: ${custom?.colors?.border || \"oklch(0.27 0 0)\"};\n          --destructive: ${custom?.colors?.destructive || \"oklch(0.65 0.15 25.723)\"};\n          --muted-foreground: ${custom?.colors?.mutedForeground || \"oklch(0.65 0 0)\"};\n          --corner-border: ${custom?.colors?.cornerBorder || \"#a0a0a0\"};\n        }\n      }\n      @media (max-width: 640px) {\n        :root, :host {\n          --text-6xl: 2.5rem;\n          --text-2xl: 1.25rem;\n          --text-sm: 0.8125rem;\n        }\n      }\n      @media (max-width: 480px) {\n        :root, :host {\n          --text-6xl: 2rem;\n          --text-2xl: 1.125rem;\n        }\n      }\n    </style>\n  </head>\n  <body style=\"width: 100vw; min-height: 100vh; overflow-x: hidden; overflow-y: auto;\">\n    <div\n        style=\"\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            gap: 1.5rem;\n            position: relative;\n            width: 100%;\n            min-height: 100vh;\n            padding: 1rem;\n        \"\n        >\n${\n\tcustom?.disableBackgroundGrid\n\t\t? \"\"\n\t\t: `\n      <div\n        style=\"\n          position: absolute;\n          inset: 0;\n          background-image: linear-gradient(to right, ${custom?.colors?.gridColor || \"var(--border)\"} 1px, transparent 1px),\n            linear-gradient(to bottom, ${custom?.colors?.gridColor || \"var(--border)\"} 1px, transparent 1px);\n          background-size: 40px 40px;\n          opacity: 0.6;\n          pointer-events: none;\n          width: 100vw;\n          height: 100vh;\n        \"\n      ></div>\n      <div\n        style=\"\n          position: absolute;\n          inset: 0;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          background: ${custom?.colors?.background || \"var(--background)\"};\n          mask-image: radial-gradient(ellipse at center, transparent 20%, black);\n          -webkit-mask-image: radial-gradient(ellipse at center, transparent 20%, black);\n          pointer-events: none;\n        \"\n      ></div>\n`\n}\n\n<div\n  style=\"\n    position: relative;\n    z-index: 10;\n    border: 2px solid var(--border);\n    background: ${custom?.colors?.cardBackground || \"var(--background)\"};\n    padding: 1.5rem;\n    max-width: 42rem;\n    width: 100%;\n  \"\n>\n    ${\n\t\t\tcustom?.disableCornerDecorations\n\t\t\t\t? \"\"\n\t\t\t\t: `\n        <!-- Corner decorations -->\n        <div\n          style=\"\n            position: absolute;\n            top: -2px;\n            left: -2px;\n            width: 2rem;\n            height: 2rem;\n            border-top: 4px solid var(--corner-border);\n            border-left: 4px solid var(--corner-border);\n          \"\n        ></div>\n        <div\n          style=\"\n            position: absolute;\n            top: -2px;\n            right: -2px;\n            width: 2rem;\n            height: 2rem;\n            border-top: 4px solid var(--corner-border);\n            border-right: 4px solid var(--corner-border);\n          \"\n        ></div>\n  \n        <div\n          style=\"\n            position: absolute;\n            bottom: -2px;\n            left: -2px;\n            width: 2rem;\n            height: 2rem;\n            border-bottom: 4px solid var(--corner-border);\n            border-left: 4px solid var(--corner-border);\n          \"\n        ></div>\n        <div\n          style=\"\n            position: absolute;\n            bottom: -2px;\n            right: -2px;\n            width: 2rem;\n            height: 2rem;\n            border-bottom: 4px solid var(--corner-border);\n            border-right: 4px solid var(--corner-border);\n          \"\n        ></div>`\n\t\t}\n\n        <div style=\"text-align: center; margin-bottom: 1.5rem;\">\n          <div style=\"margin-bottom: 1.5rem;\">\n            <div\n              style=\"\n                display: inline-block;\n                border: 2px solid ${custom?.disableTitleBorder ? \"transparent\" : custom?.colors?.titleBorder || \"var(--destructive)\"};\n                padding: 0.375rem 1rem;\n              \"\n            >\n              <h1\n                style=\"\n                  font-size: var(--text-6xl);\n                  font-weight: var(--font-weight-semibold);\n                  color: ${custom?.colors?.titleColor || \"var(--foreground)\"};\n                  letter-spacing: -0.02em;\n                  margin: 0;\n                \"\n              >\n                ERROR\n              </h1>\n            </div>\n            <div\n              style=\"\n                height: 2px;\n                background-color: var(--border);\n                width: calc(100% + 3rem);\n                margin-left: -1.5rem;\n                margin-top: 1.5rem;\n              \"\n            ></div>\n          </div>\n\n          <h2\n            style=\"\n              font-size: var(--text-2xl);\n              font-weight: var(--font-weight-semibold);\n              color: var(--foreground);\n              margin: 0 0 1rem;\n            \"\n          >\n            Something went wrong\n          </h2>\n\n          <div\n            style=\"\n                display: inline-flex;\n                align-items: center;\n                gap: 0.5rem;\n                border: 2px solid var(--border);\n                background-color: var(--muted);\n                padding: 0.375rem 0.75rem;\n                margin: 0 0 1rem;\n                flex-wrap: wrap;\n                justify-content: center;\n            \"\n            >\n            <span\n                style=\"\n                font-size: 0.75rem;\n                color: var(--muted-foreground);\n                font-weight: var(--font-weight-semibold);\n                \"\n            >\n                CODE:\n            </span>\n            <span\n                style=\"\n                font-size: var(--text-sm);\n                font-family: var(--default-mono-font-family, monospace);\n                color: var(--foreground);\n                word-break: break-all;\n                \"\n            >\n                ${sanitize(code)}\n            </span>\n            </div>\n\n          <p\n            style=\"\n              color: var(--muted-foreground);\n              max-width: 28rem;\n              margin: 0 auto;\n              font-size: var(--text-sm);\n              line-height: 1.5;\n              text-wrap: pretty;\n            \"\n          >\n            ${\n\t\t\t\t\t\t\t!description\n\t\t\t\t\t\t\t\t? \"We encountered an unexpected error. Please try again or return to the home page. If you're a developer, you can find more information about the error \" +\n\t\t\t\t\t\t\t\t\t`<a href='https://better-auth.com/docs/reference/errors/${encodeURIComponent(code)}' target='_blank' rel=\"noopener noreferrer\" style='color: var(--foreground); text-decoration: underline;'>here</a>.`\n\t\t\t\t\t\t\t\t: description\n\t\t\t\t\t\t}\n          </p>\n        </div>\n\n        <div\n          style=\"\n            display: flex;\n            gap: 0.75rem;\n            margin-top: 1.5rem;\n            justify-content: center;\n            flex-wrap: wrap;\n          \"\n        >\n          <a\n            href=\"/\"\n            style=\"\n              text-decoration: none;\n            \"\n          >\n            <div\n              style=\"\n                border: 2px solid var(--border);\n                background: var(--primary);\n                color: var(--primary-foreground);\n                padding: 0.5rem 1rem;\n                border-radius: 0;\n                white-space: nowrap;\n              \"\n              class=\"btn\"\n            >\n              Go Home\n            </div>\n          </a>\n          <a\n            href=\"https://better-auth.com/docs/reference/errors/${encodeURIComponent(code)}?askai=${encodeURIComponent(`What does the error code ${code} mean?`)}\"\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            style=\"\n              text-decoration: none;\n            \"\n          >\n            <div\n              style=\"\n                border: 2px solid var(--border);\n                background: transparent;\n                color: var(--foreground);\n                padding: 0.5rem 1rem;\n                border-radius: 0;\n                white-space: nowrap;\n              \"\n              class=\"btn\"\n            >\n              Ask AI\n            </div>\n          </a>\n        </div>\n      </div>\n    </div>\n  </body>\n</html>`;\n};\n\nexport const error = createAuthEndpoint(\n\t\"/error\",\n\t{\n\t\tmethod: \"GET\",\n\t\tmetadata: {\n\t\t\t...HIDE_METADATA,\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Displays an error page\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"text/html\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\tdescription: \"The HTML content of the error page\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (c) => {\n\t\tconst url = new URL(c.request?.url || \"\");\n\t\tconst unsanitizedCode = url.searchParams.get(\"error\") || \"UNKNOWN\";\n\t\tconst unsanitizedDescription =\n\t\t\turl.searchParams.get(\"error_description\") || null;\n\n\t\tconst isValid = /^[\\'A-Za-z0-9_-]+$/.test(unsanitizedCode || \"\");\n\t\tconst safeCode = isValid ? unsanitizedCode : \"UNKNOWN\";\n\t\tconst safeDescription = unsanitizedDescription\n\t\t\t? sanitize(unsanitizedDescription)\n\t\t\t: null;\n\n\t\tconst queryParams = new URLSearchParams();\n\t\tqueryParams.set(\"error\", safeCode);\n\t\tif (unsanitizedDescription) {\n\t\t\tqueryParams.set(\"error_description\", unsanitizedDescription);\n\t\t}\n\n\t\tconst options = c.context.options;\n\t\tconst errorURL = options.onAPIError?.errorURL;\n\n\t\tif (errorURL) {\n\t\t\treturn new Response(null, {\n\t\t\t\tstatus: 302,\n\t\t\t\theaders: {\n\t\t\t\t\tLocation: `${errorURL}${errorURL.includes(\"?\") ? \"&\" : \"?\"}${queryParams.toString()}`,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\tif (isProduction && !options.onAPIError?.customizeDefaultErrorPage) {\n\t\t\treturn new Response(null, {\n\t\t\t\tstatus: 302,\n\t\t\t\theaders: {\n\t\t\t\t\tLocation: `/?${queryParams.toString()}`,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn new Response(html(c.context.options, safeCode, safeDescription), {\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"text/html\",\n\t\t\t},\n\t\t});\n\t},\n);\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2654, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/ok.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/ok.ts"],"sourcesContent":["import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { HIDE_METADATA } from \"../../utils/hide-metadata\";\n\nexport const ok = createAuthEndpoint(\n\t\"/ok\",\n\t{\n\t\tmethod: \"GET\",\n\t\tmetadata: {\n\t\t\t...HIDE_METADATA,\n\t\t\topenapi: {\n\t\t\t\tdescription: \"Check if the API is working\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"API is working\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tok: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Indicates if the API is working\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"ok\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\treturn ctx.json({\n\t\t\tok: true,\n\t\t});\n\t},\n);\n"],"names":[],"mappings":";;;;;;;;;AAGA,MAAa,SAAK,yLAAA,EACjB,OACA;IACC,QAAQ;IACR,UAAU;QACT,GAAG,uLAAA;QACH,SAAS;YACR,aAAa;YACb,WAAW;gBACV,OAAO;oBACN,aAAa;oBACb,SAAS;wBACR,oBAAoB;4BACnB,QAAQ;gCACP,MAAM;gCACN,YAAY;oCACX,IAAI;wCACH,MAAM;wCACN,aAAa;qCACb;gCAAA,CACD;gCACD,UAAU;oCAAC;iCAAK;6BAChB;wBAAA,CACD;oBAAA,CACD;iBACD;YAAA,CACD;SACD;KACD;CACD,EACD,OAAO,QAAQ;IACd,OAAO,IAAI,IAAA,CAAK;QACf,IAAI;IAAA,CACJ,CAAC;EAEH"}},
    {"offset": {"line": 2703, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/password.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/password.ts"],"sourcesContent":["import type { AuthContext } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { generateId } from \"../../utils\";\nimport { getDate } from \"../../utils/date\";\nimport { validatePassword } from \"../../utils/password\";\nimport { originCheck } from \"../middlewares\";\nimport { sensitiveSessionMiddleware } from \"./session\";\n\nfunction redirectError(\n\tctx: AuthContext,\n\tcallbackURL: string | undefined,\n\tquery?: Record<string, string> | undefined,\n): string {\n\tconst url = callbackURL\n\t\t? new URL(callbackURL, ctx.baseURL)\n\t\t: new URL(`${ctx.baseURL}/error`);\n\tif (query)\n\t\tObject.entries(query).forEach(([k, v]) => url.searchParams.set(k, v));\n\treturn url.href;\n}\n\nfunction redirectCallback(\n\tctx: AuthContext,\n\tcallbackURL: string,\n\tquery?: Record<string, string> | undefined,\n): string {\n\tconst url = new URL(callbackURL, ctx.baseURL);\n\tif (query)\n\t\tObject.entries(query).forEach(([k, v]) => url.searchParams.set(k, v));\n\treturn url.href;\n}\n\nexport const requestPasswordReset = createAuthEndpoint(\n\t\"/request-password-reset\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\t/**\n\t\t\t * The email address of the user to send a password reset email to.\n\t\t\t */\n\t\t\temail: z.email().meta({\n\t\t\t\tdescription:\n\t\t\t\t\t\"The email address of the user to send a password reset email to\",\n\t\t\t}),\n\t\t\t/**\n\t\t\t * The URL to redirect the user to reset their password.\n\t\t\t * If the token isn't valid or expired, it'll be redirected with a query parameter `?\n\t\t\t * error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?\n\t\t\t * token=VALID_TOKEN\n\t\t\t */\n\t\t\tredirectTo: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"The URL to redirect the user to reset their password. If the token isn't valid or expired, it'll be redirected with a query parameter `?error=INVALID_TOKEN`. If the token is valid, it'll be redirected with a query parameter `?token=VALID_TOKEN\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"requestPasswordReset\",\n\t\t\t\tdescription: \"Send a password reset email to the user\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tif (!ctx.context.options.emailAndPassword?.sendResetPassword) {\n\t\t\tctx.context.logger.error(\n\t\t\t\t\"Reset password isn't enabled.Please pass an emailAndPassword.sendResetPassword function in your auth config!\",\n\t\t\t);\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Reset password isn't enabled\",\n\t\t\t});\n\t\t}\n\t\tconst { email, redirectTo } = ctx.body;\n\n\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email, {\n\t\t\tincludeAccounts: true,\n\t\t});\n\t\tif (!user) {\n\t\t\t/**\n\t\t\t * We simulate the verification token generation and the database lookup\n\t\t\t * to mitigate timing attacks.\n\t\t\t */\n\t\t\tgenerateId(24);\n\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t\"dummy-verification-token\",\n\t\t\t);\n\t\t\tctx.context.logger.error(\"Reset Password: User not found\", { email });\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t\tmessage:\n\t\t\t\t\t\"If this email exists in our system, check your email for the reset link\",\n\t\t\t});\n\t\t}\n\t\tconst defaultExpiresIn = 60 * 60 * 1;\n\t\tconst expiresAt = getDate(\n\t\t\tctx.context.options.emailAndPassword.resetPasswordTokenExpiresIn ||\n\t\t\t\tdefaultExpiresIn,\n\t\t\t\"sec\",\n\t\t);\n\t\tconst verificationToken = generateId(24);\n\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\tvalue: user.user.id,\n\t\t\tidentifier: `reset-password:${verificationToken}`,\n\t\t\texpiresAt,\n\t\t});\n\t\tconst callbackURL = redirectTo ? encodeURIComponent(redirectTo) : \"\";\n\t\tconst url = `${ctx.context.baseURL}/reset-password/${verificationToken}?callbackURL=${callbackURL}`;\n\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\tctx.context.options.emailAndPassword.sendResetPassword(\n\t\t\t\t{\n\t\t\t\t\tuser: user.user,\n\t\t\t\t\turl,\n\t\t\t\t\ttoken: verificationToken,\n\t\t\t\t},\n\t\t\t\tctx.request,\n\t\t\t),\n\t\t);\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t\tmessage:\n\t\t\t\t\"If this email exists in our system, check your email for the reset link\",\n\t\t});\n\t},\n);\n\nexport const requestPasswordResetCallback = createAuthEndpoint(\n\t\"/reset-password/:token\",\n\t{\n\t\tmethod: \"GET\",\n\t\toperationId: \"forgetPasswordCallback\",\n\t\tquery: z.object({\n\t\t\tcallbackURL: z.string().meta({\n\t\t\t\tdescription: \"The URL to redirect the user to reset their password\",\n\t\t\t}),\n\t\t}),\n\t\tuse: [originCheck((ctx) => ctx.query.callbackURL)],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"resetPasswordCallback\",\n\t\t\t\tdescription: \"Redirects the user to the callback URL with the token\",\n\t\t\t\tparameters: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"token\",\n\t\t\t\t\t\tin: \"path\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tdescription: \"The token to reset the password\",\n\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname: \"callbackURL\",\n\t\t\t\t\t\tin: \"query\",\n\t\t\t\t\t\trequired: true,\n\t\t\t\t\t\tdescription: \"The URL to redirect the user to reset their password\",\n\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst { token } = ctx.params;\n\t\tconst { callbackURL } = ctx.query;\n\t\tif (!token || !callbackURL) {\n\t\t\tthrow ctx.redirect(\n\t\t\t\tredirectError(ctx.context, callbackURL, { error: \"INVALID_TOKEN\" }),\n\t\t\t);\n\t\t}\n\t\tconst verification =\n\t\t\tawait ctx.context.internalAdapter.findVerificationValue(\n\t\t\t\t`reset-password:${token}`,\n\t\t\t);\n\t\tif (!verification || verification.expiresAt < new Date()) {\n\t\t\tthrow ctx.redirect(\n\t\t\t\tredirectError(ctx.context, callbackURL, { error: \"INVALID_TOKEN\" }),\n\t\t\t);\n\t\t}\n\n\t\tthrow ctx.redirect(redirectCallback(ctx.context, callbackURL, { token }));\n\t},\n);\n\nexport const resetPassword = createAuthEndpoint(\n\t\"/reset-password\",\n\t{\n\t\tmethod: \"POST\",\n\t\toperationId: \"resetPassword\",\n\t\tquery: z\n\t\t\t.object({\n\t\t\t\ttoken: z.string().optional(),\n\t\t\t})\n\t\t\t.optional(),\n\t\tbody: z.object({\n\t\t\tnewPassword: z.string().meta({\n\t\t\t\tdescription: \"The new password to set\",\n\t\t\t}),\n\t\t\ttoken: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The token to reset the password\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"resetPassword\",\n\t\t\t\tdescription: \"Reset the password for a user\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst token = ctx.body.token || ctx.query?.token;\n\t\tif (!token) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_TOKEN,\n\t\t\t});\n\t\t}\n\n\t\tconst { newPassword } = ctx.body;\n\n\t\tconst minLength = ctx.context.password?.config.minPasswordLength;\n\t\tconst maxLength = ctx.context.password?.config.maxPasswordLength;\n\t\tif (newPassword.length < minLength) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t});\n\t\t}\n\t\tif (newPassword.length > maxLength) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t});\n\t\t}\n\n\t\tconst id = `reset-password:${token}`;\n\n\t\tconst verification =\n\t\t\tawait ctx.context.internalAdapter.findVerificationValue(id);\n\t\tif (!verification || verification.expiresAt < new Date()) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_TOKEN,\n\t\t\t});\n\t\t}\n\t\tconst userId = verification.value;\n\t\tconst hashedPassword = await ctx.context.password.hash(newPassword);\n\t\tconst accounts = await ctx.context.internalAdapter.findAccounts(userId);\n\t\tconst account = accounts.find((ac) => ac.providerId === \"credential\");\n\t\tif (!account) {\n\t\t\tawait ctx.context.internalAdapter.createAccount({\n\t\t\t\tuserId,\n\t\t\t\tproviderId: \"credential\",\n\t\t\t\tpassword: hashedPassword,\n\t\t\t\taccountId: userId,\n\t\t\t});\n\t\t} else {\n\t\t\tawait ctx.context.internalAdapter.updatePassword(userId, hashedPassword);\n\t\t}\n\t\tawait ctx.context.internalAdapter.deleteVerificationValue(verification.id);\n\n\t\tif (ctx.context.options.emailAndPassword?.onPasswordReset) {\n\t\t\tconst user = await ctx.context.internalAdapter.findUserById(userId);\n\t\t\tif (user) {\n\t\t\t\tawait ctx.context.options.emailAndPassword.onPasswordReset(\n\t\t\t\t\t{\n\t\t\t\t\t\tuser,\n\t\t\t\t\t},\n\t\t\t\t\tctx.request,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\tif (ctx.context.options.emailAndPassword?.revokeSessionsOnPasswordReset) {\n\t\t\tawait ctx.context.internalAdapter.deleteSessions(userId);\n\t\t}\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n\nexport const verifyPassword = createAuthEndpoint(\n\t\"/verify-password\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\t/**\n\t\t\t * The password to verify\n\t\t\t */\n\t\t\tpassword: z.string().meta({\n\t\t\t\tdescription: \"The password to verify\",\n\t\t\t}),\n\t\t}),\n\t\tmetadata: {\n\t\t\tscope: \"server\",\n\t\t\topenapi: {\n\t\t\t\toperationId: \"verifyPassword\",\n\t\t\t\tdescription: \"Verify the current user's password\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tuse: [sensitiveSessionMiddleware],\n\t},\n\tasync (ctx) => {\n\t\tconst { password } = ctx.body;\n\t\tconst session = ctx.context.session;\n\n\t\tconst isValid = await validatePassword(ctx, {\n\t\t\tpassword,\n\t\t\tuserId: session.user.id,\n\t\t});\n\n\t\tif (!isValid) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_PASSWORD,\n\t\t\t});\n\t\t}\n\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAWA,SAAS,cACR,GAAA,EACA,WAAA,EACA,KAAA,EACS;IACT,MAAM,MAAM,cACT,IAAI,IAAI,aAAa,IAAI,OAAA,CAAQ,GACjC,IAAI,IAAI,GAAG,IAAI,OAAA,CAAQ,MAAA,CAAA,CAAQ;IAClC,IAAI,MACH,CAAA,OAAO,OAAA,CAAQ,MAAM,CAAC,OAAA,CAAA,CAAS,CAAC,GAAG,EAAA,GAAO,IAAI,YAAA,CAAa,GAAA,CAAI,GAAG,EAAE,CAAC;IACtE,OAAO,IAAI,IAAA;;AAGZ,SAAS,iBACR,GAAA,EACA,WAAA,EACA,KAAA,EACS;IACT,MAAM,MAAM,IAAI,IAAI,aAAa,IAAI,OAAA,CAAQ;IAC7C,IAAI,MACH,CAAA,OAAO,OAAA,CAAQ,MAAM,CAAC,OAAA,CAAA,CAAS,CAAC,GAAG,EAAA,GAAO,IAAI,YAAA,CAAa,GAAA,CAAI,GAAG,EAAE,CAAC;IACtE,OAAO,IAAI,IAAA;;AAGZ,MAAa,2BAAuB,yLAAA,EACnC,2BACA;IACC,QAAQ;IACR,MAAM,EAAE,yJAAA,CAAO;QAId,OAAO,EAAE,wJAAA,EAAO,CAAC,IAAA,CAAK;YACrB,aACC;QAAA,CACD,CAAC;QAOF,YAAY,EACV,yJAAA,EAAQ,CACR,IAAA,CAAK;YACL,aACC;QAAA,CACD,CAAC,CACD,QAAA,EAAU;KACZ,CAAC;IACF,UAAU;QACT,SAAS;YACR,aAAa;YACb,aAAa;YACb,WAAW;gBACV,OAAO;oBACN,aAAa;oBACb,SAAS;wBACR,oBAAoB;4BACnB,QAAQ;gCACP,MAAM;gCACN,YAAY;oCACX,QAAQ;wCACP,MAAM;oCAAA,CACN;oCACD,SAAS;wCACR,MAAM;oCAAA,CACN;iCACD;6BACD;wBAAA,CACD;oBAAA,CACD;iBACD;YAAA,CACD;SACD;IAAA,CACD;CACD,EACD,OAAO,QAAQ;IACd,IAAI,CAAC,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,EAAkB,mBAAmB;QAC7D,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAClB,+GACA;QACD,MAAM,IAAI,8JAAA,CAAS,eAAe;YACjC,SAAS;QAAA,CACT,CAAC;;IAEH,MAAM,EAAE,KAAA,EAAO,UAAA,EAAA,GAAe,IAAI,IAAA;IAElC,MAAM,OAAO,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,eAAA,CAAgB,OAAO;QACrE,iBAAiB;IAAA,CACjB,CAAC;IACF,IAAI,CAAC,MAAM;;;;KAKV,IAAA,gLAAA,EAAW,GAAG;QACd,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,qBAAA,CACjC,2BACA;QACD,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,kCAAkC;YAAE;QAAA,CAAO,CAAC;QACrE,OAAO,IAAI,IAAA,CAAK;YACf,QAAQ;YACR,SACC;SACD,CAAC;;IAGH,MAAM,gBAAY,qKAAA,EACjB,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,CAAiB,2BAAA,IAFb,OAAU,GAIlC,MACA;IACD,MAAM,wBAAoB,gLAAA,EAAW,GAAG;IACxC,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,uBAAA,CAAwB;QACzD,OAAO,KAAK,IAAA,CAAK,EAAA;QACjB,YAAY,CAAA,eAAA,EAAkB,mBAAA;QAC9B;KACA,CAAC;IACF,MAAM,cAAc,aAAa,mBAAmB,WAAW,GAAG;IAClE,MAAM,MAAM,GAAG,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,EAAkB,kBAAkB,aAAA,EAAe,aAAA;IACtF,MAAM,IAAI,OAAA,CAAQ,sBAAA,CACjB,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,CAAiB,iBAAA,CACpC;QACC,MAAM,KAAK,IAAA;QACX;QACA,OAAO;KACP,EACD,IAAI,OAAA,CACJ,CACD;IACD,OAAO,IAAI,IAAA,CAAK;QACf,QAAQ;QACR,SACC;KACD,CAAC;EAEH;AAED,MAAa,mCAA+B,yLAAA,EAC3C,0BACA;IACC,QAAQ;IACR,aAAa;IACb,OAAO,EAAE,yJAAA,CAAO;QACf,aAAa,EAAE,yJAAA,EAAQ,CAAC,IAAA,CAAK;YAC5B,aAAa;QAAA,CACb,CAAC;IAAA,CACF,CAAC;IACF,KAAK;YAAC,iMAAA,EAAA,CAAa,MAAQ,IAAI,KAAA,CAAM,WAAA,CAAY;KAAC;IAClD,UAAU;QACT,SAAS;YACR,aAAa;YACb,aAAa;YACb,YAAY;gBACX;oBACC,MAAM;oBACN,IAAI;oBACJ,UAAU;oBACV,aAAa;oBACb,QAAQ;wBACP,MAAM;oBAAA,CACN;iBACD;gBACD;oBACC,MAAM;oBACN,IAAI;oBACJ,UAAU;oBACV,aAAa;oBACb,QAAQ;wBACP,MAAM;oBAAA,CACN;iBACD;aACD;YACD,WAAW;gBACV,OAAO;oBACN,aAAa;oBACb,SAAS;wBACR,oBAAoB;4BACnB,QAAQ;gCACP,MAAM;gCACN,YAAY;oCACX,OAAO;wCACN,MAAM;oCAAA,CACN;gCAAA,CACD;6BACD;wBAAA,CACD;oBAAA,CACD;iBACD;YAAA,CACD;SACD;IAAA,CACD;CACD,EACD,OAAO,QAAQ;IACd,MAAM,EAAE,KAAA,EAAA,GAAU,IAAI,MAAA;IACtB,MAAM,EAAE,WAAA,EAAA,GAAgB,IAAI,KAAA;IAC5B,IAAI,CAAC,SAAS,CAAC,YACd,CAAA,MAAM,IAAI,QAAA,CACT,cAAc,IAAI,OAAA,EAAS,aAAa;QAAE,OAAO;IAAA,CAAiB,CAAC,CACnE;IAEF,MAAM,eACL,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,qBAAA,CACjC,CAAA,eAAA,EAAkB,OAAA,CAClB;IACF,IAAI,CAAC,gBAAgB,aAAa,SAAA,GAAA,aAAA,GAAY,IAAI,MAAM,CACvD,CAAA,MAAM,IAAI,QAAA,CACT,cAAc,IAAI,OAAA,EAAS,aAAa;QAAE,OAAO;IAAA,CAAiB,CAAC,CACnE;IAGF,MAAM,IAAI,QAAA,CAAS,iBAAiB,IAAI,OAAA,EAAS,aAAa;QAAE;IAAA,CAAO,CAAC,CAAC;EAE1E;AAED,MAAa,oBAAgB,yLAAA,EAC5B,mBACA;IACC,QAAQ;IACR,aAAa;IACb,OAAO,EACL,yJAAA,CAAO;QACP,OAAO,EAAE,yJAAA,EAAQ,CAAC,QAAA,EAAU;IAAA,CAC5B,CAAC,CACD,QAAA,EAAU;IACZ,MAAM,EAAE,yJAAA,CAAO;QACd,aAAa,EAAE,yJAAA,EAAQ,CAAC,IAAA,CAAK;YAC5B,aAAa;QAAA,CACb,CAAC;QACF,OAAO,EACL,yJAAA,EAAQ,CACR,IAAA,CAAK;YACL,aAAa;QAAA,CACb,CAAC,CACD,QAAA,EAAU;KACZ,CAAC;IACF,UAAU;QACT,SAAS;YACR,aAAa;YACb,aAAa;YACb,WAAW;gBACV,OAAO;oBACN,aAAa;oBACb,SAAS;wBACR,oBAAoB;4BACnB,QAAQ;gCACP,MAAM;gCACN,YAAY;oCACX,QAAQ;wCACP,MAAM;oCAAA,CACN;gCAAA,CACD;6BACD;wBAAA,CACD;oBAAA,CACD;iBACD;YAAA,CACD;SACD;IAAA,CACD;CACD,EACD,OAAO,QAAQ;IACd,MAAM,QAAQ,IAAI,IAAA,CAAK,KAAA,IAAS,IAAI,KAAA,EAAO;IAC3C,IAAI,CAAC,MACJ,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;QACjC,SAAS,yLAAA,CAAiB,aAAA;IAAA,CAC1B,CAAC;IAGH,MAAM,EAAE,WAAA,EAAA,GAAgB,IAAI,IAAA;IAE5B,MAAM,YAAY,IAAI,OAAA,CAAQ,QAAA,EAAU,OAAO;IAC/C,MAAM,YAAY,IAAI,OAAA,CAAQ,QAAA,EAAU,OAAO;IAC/C,IAAI,YAAY,MAAA,GAAS,UACxB,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;QACjC,SAAS,yLAAA,CAAiB,kBAAA;IAAA,CAC1B,CAAC;IAEH,IAAI,YAAY,MAAA,GAAS,UACxB,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;QACjC,SAAS,yLAAA,CAAiB,iBAAA;IAAA,CAC1B,CAAC;IAGH,MAAM,KAAK,CAAA,eAAA,EAAkB,OAAA;IAE7B,MAAM,eACL,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,qBAAA,CAAsB,GAAG;IAC5D,IAAI,CAAC,gBAAgB,aAAa,SAAA,GAAA,aAAA,GAAY,IAAI,MAAM,CACvD,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;QACjC,SAAS,yLAAA,CAAiB,aAAA;IAAA,CAC1B,CAAC;IAEH,MAAM,SAAS,aAAa,KAAA;IAC5B,MAAM,iBAAiB,MAAM,IAAI,OAAA,CAAQ,QAAA,CAAS,IAAA,CAAK,YAAY;IAGnE,IAAI,CAAA,CAFa,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,YAAA,CAAa,OAAO,EAC9C,IAAA,CAAA,CAAM,KAAO,GAAG,UAAA,KAAe,aAAa,CAEpE,CAAA,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,aAAA,CAAc;QAC/C;QACA,YAAY;QACZ,UAAU;QACV,WAAW;KACX,CAAC;SAEF,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,cAAA,CAAe,QAAQ,eAAe;IAEzE,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,uBAAA,CAAwB,aAAa,EAAA,CAAG;IAE1E,IAAI,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,EAAkB,iBAAiB;QAC1D,MAAM,OAAO,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,YAAA,CAAa,OAAO;QACnE,IAAI,KACH,CAAA,MAAM,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,CAAiB,eAAA,CAC1C;YACC;QAAA,CACA,EACD,IAAI,OAAA,CACJ;;IAGH,IAAI,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,EAAkB,8BACzC,CAAA,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,cAAA,CAAe,OAAO;IAEzD,OAAO,IAAI,IAAA,CAAK;QACf,QAAQ;IAAA,CACR,CAAC;EAEH;AAED,MAAa,qBAAiB,yLAAA,EAC7B,oBACA;IACC,QAAQ;IACR,MAAM,EAAE,yJAAA,CAAO;QAId,UAAU,EAAE,yJAAA,EAAQ,CAAC,IAAA,CAAK;YACzB,aAAa;QAAA,CACb,CAAC;IAAA,CACF,CAAC;IACF,UAAU;QACT,OAAO;QACP,SAAS;YACR,aAAa;YACb,aAAa;YACb,WAAW;gBACV,OAAO;oBACN,aAAa;oBACb,SAAS;wBACR,oBAAoB;4BACnB,QAAQ;gCACP,MAAM;gCACN,YAAY;oCACX,QAAQ;wCACP,MAAM;oCAAA,CACN;gCAAA,CACD;6BACD;wBAAA,CACD;oBAAA,CACD;iBACD;YAAA,CACD;SACD;KACD;IACD,KAAK;QAAC,mMAAA;KAA2B;CACjC,EACD,OAAO,QAAQ;IACd,MAAM,EAAE,QAAA,EAAA,GAAa,IAAI,IAAA;IACzB,MAAM,UAAU,IAAI,OAAA,CAAQ,OAAA;IAO5B,IAAI,CALY,UAAM,kLAAA,EAAiB,KAAK;QAC3C;QACA,QAAQ,QAAQ,IAAA,CAAK,EAAA;KACrB,CAAC,CAGD,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;QACjC,SAAS,yLAAA,CAAiB,gBAAA;IAAA,CAC1B,CAAC;IAGH,OAAO,IAAI,IAAA,CAAK;QACf,QAAQ;IAAA,CACR,CAAC;EAEH"}},
    {"offset": {"line": 3025, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/sign-in.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/sign-in.ts"],"sourcesContent":["import type { BetterAuthOptions } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { SocialProviderListEnum } from \"@better-auth/core/social-providers\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { parseUserOutput } from \"../../db/schema\";\nimport { handleOAuthUserInfo } from \"../../oauth2/link-account\";\nimport type { InferUser } from \"../../types\";\nimport { generateState } from \"../../utils\";\nimport { formCsrfMiddleware } from \"../middlewares/origin-check\";\nimport { createEmailVerificationToken } from \"./email-verification\";\n\nconst socialSignInBodySchema = z.object({\n\t/**\n\t * Callback URL to redirect to after the user\n\t * has signed in.\n\t */\n\tcallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"Callback URL to redirect to after the user has signed in\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * callback url to redirect if the user is newly registered.\n\t *\n\t * useful if you have different routes for existing users and new users\n\t */\n\tnewUserCallbackURL: z.string().optional(),\n\t/**\n\t * Callback url to redirect to if an error happens\n\t *\n\t * If it's initiated from the client sdk this defaults to\n\t * the current url.\n\t */\n\terrorCallbackURL: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"Callback URL to redirect to if an error happens\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * OAuth2 provider to use`\n\t */\n\tprovider: SocialProviderListEnum,\n\t/**\n\t * Disable automatic redirection to the provider\n\t *\n\t * This is useful if you want to handle the redirection\n\t * yourself like in a popup or a different tab.\n\t */\n\tdisableRedirect: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Disable automatic redirection to the provider. Useful for handling the redirection yourself\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * ID token from the provider\n\t *\n\t * This is used to sign in the user\n\t * if the user is already signed in with the\n\t * provider in the frontend.\n\t *\n\t * Only applicable if the provider supports\n\t * it. Currently only `apple` and `google` is\n\t * supported out of the box.\n\t */\n\tidToken: z.optional(\n\t\tz.object({\n\t\t\t/**\n\t\t\t * ID token from the provider\n\t\t\t */\n\t\t\ttoken: z.string().meta({\n\t\t\t\tdescription: \"ID token from the provider\",\n\t\t\t}),\n\t\t\t/**\n\t\t\t * The nonce used to generate the token\n\t\t\t */\n\t\t\tnonce: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"Nonce used to generate the token\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * Access token from the provider\n\t\t\t */\n\t\t\taccessToken: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"Access token from the provider\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * Refresh token from the provider\n\t\t\t */\n\t\t\trefreshToken: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"Refresh token from the provider\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * Expiry date of the token\n\t\t\t */\n\t\t\texpiresAt: z\n\t\t\t\t.number()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"Expiry date of the token\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t),\n\tscopes: z\n\t\t.array(z.string())\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Array of scopes to request from the provider. This will override the default scopes passed.\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * Explicitly request sign-up\n\t *\n\t * Should be used to allow sign up when\n\t * disableImplicitSignUp for this provider is\n\t * true\n\t */\n\trequestSignUp: z\n\t\t.boolean()\n\t\t.meta({\n\t\t\tdescription:\n\t\t\t\t\"Explicitly request sign-up. Useful when disableImplicitSignUp is true for this provider\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * The login hint to use for the authorization code request\n\t */\n\tloginHint: z\n\t\t.string()\n\t\t.meta({\n\t\t\tdescription: \"The login hint to use for the authorization code request\",\n\t\t})\n\t\t.optional(),\n\t/**\n\t * Additional data to be passed through the OAuth flow\n\t */\n\tadditionalData: z.record(z.string(), z.any()).optional().meta({\n\t\tdescription: \"Additional data to be passed through the OAuth flow\",\n\t}),\n});\n\nexport const signInSocial = <O extends BetterAuthOptions>() =>\n\tcreateAuthEndpoint(\n\t\t\"/sign-in/social\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\toperationId: \"socialSignIn\",\n\t\t\tbody: socialSignInBodySchema,\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as z.infer<typeof socialSignInBodySchema>,\n\t\t\t\t\treturned: {} as {\n\t\t\t\t\t\tredirect: boolean;\n\t\t\t\t\t\ttoken?: string | undefined;\n\t\t\t\t\t\turl?: string | undefined;\n\t\t\t\t\t\tuser?: InferUser<O> | undefined;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\tdescription: \"Sign in with a social provider\",\n\t\t\t\t\toperationId: \"socialSignIn\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Success - Returns either session details or redirect URL\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t// todo: we need support for multiple schema\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"Session response when idToken is provided\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\turl: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tredirect: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [false],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"redirect\", \"token\", \"user\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (\n\t\t\tc,\n\t\t): Promise<\n\t\t\t| { redirect: boolean; url: string }\n\t\t\t| { redirect: boolean; token: string; url: undefined; user: InferUser<O> }\n\t\t> => {\n\t\t\tconst provider = c.context.socialProviders.find(\n\t\t\t\t(p) => p.id === c.body.provider,\n\t\t\t);\n\t\t\tif (!provider) {\n\t\t\t\tc.context.logger.error(\n\t\t\t\t\t\"Provider not found. Make sure to add the provider in your auth config\",\n\t\t\t\t\t{\n\t\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.PROVIDER_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (c.body.idToken) {\n\t\t\t\tif (!provider.verifyIdToken) {\n\t\t\t\t\tc.context.logger.error(\n\t\t\t\t\t\t\"Provider does not support id token verification\",\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t\t\t},\n\t\t\t\t\t);\n\t\t\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.ID_TOKEN_NOT_SUPPORTED,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst { token, nonce } = c.body.idToken;\n\t\t\t\tconst valid = await provider.verifyIdToken(token, nonce);\n\t\t\t\tif (!valid) {\n\t\t\t\t\tc.context.logger.error(\"Invalid id token\", {\n\t\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t\t});\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_TOKEN,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst userInfo = await provider.getUserInfo({\n\t\t\t\t\tidToken: token,\n\t\t\t\t\taccessToken: c.body.idToken.accessToken,\n\t\t\t\t\trefreshToken: c.body.idToken.refreshToken,\n\t\t\t\t});\n\t\t\t\tif (!userInfo || !userInfo?.user) {\n\t\t\t\t\tc.context.logger.error(\"Failed to get user info\", {\n\t\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t\t});\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_GET_USER_INFO,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (!userInfo.user.email) {\n\t\t\t\t\tc.context.logger.error(\"User email not found\", {\n\t\t\t\t\t\tprovider: c.body.provider,\n\t\t\t\t\t});\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_EMAIL_NOT_FOUND,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst data = await handleOAuthUserInfo(c, {\n\t\t\t\t\tuserInfo: {\n\t\t\t\t\t\t...userInfo.user,\n\t\t\t\t\t\temail: userInfo.user.email,\n\t\t\t\t\t\tid: String(userInfo.user.id),\n\t\t\t\t\t\tname: userInfo.user.name || \"\",\n\t\t\t\t\t\timage: userInfo.user.image,\n\t\t\t\t\t\temailVerified: userInfo.user.emailVerified || false,\n\t\t\t\t\t},\n\t\t\t\t\taccount: {\n\t\t\t\t\t\tproviderId: provider.id,\n\t\t\t\t\t\taccountId: String(userInfo.user.id),\n\t\t\t\t\t\taccessToken: c.body.idToken.accessToken,\n\t\t\t\t\t},\n\t\t\t\t\tcallbackURL: c.body.callbackURL,\n\t\t\t\t\tdisableSignUp:\n\t\t\t\t\t\t(provider.disableImplicitSignUp && !c.body.requestSignUp) ||\n\t\t\t\t\t\tprovider.disableSignUp,\n\t\t\t\t});\n\t\t\t\tif (data.error) {\n\t\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\t\tmessage: data.error,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tawait setSessionCookie(c, data.data!);\n\t\t\t\treturn c.json({\n\t\t\t\t\tredirect: false,\n\t\t\t\t\ttoken: data.data!.session.token,\n\t\t\t\t\turl: undefined,\n\t\t\t\t\tuser: parseUserOutput(\n\t\t\t\t\t\tc.context.options,\n\t\t\t\t\t\tdata.data!.user,\n\t\t\t\t\t) as InferUser<O>,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst { codeVerifier, state } = await generateState(\n\t\t\t\tc,\n\t\t\t\tundefined,\n\t\t\t\tc.body.additionalData,\n\t\t\t);\n\t\t\tconst url = await provider.createAuthorizationURL({\n\t\t\t\tstate,\n\t\t\t\tcodeVerifier,\n\t\t\t\tredirectURI: `${c.context.baseURL}/callback/${provider.id}`,\n\t\t\t\tscopes: c.body.scopes,\n\t\t\t\tloginHint: c.body.loginHint,\n\t\t\t});\n\n\t\t\tif (!c.body.disableRedirect) {\n\t\t\t\tc.setHeader(\"Location\", url.toString());\n\t\t\t}\n\n\t\t\treturn c.json({\n\t\t\t\turl: url.toString(),\n\t\t\t\tredirect: !c.body.disableRedirect,\n\t\t\t});\n\t\t},\n\t);\n\nexport const signInEmail = <O extends BetterAuthOptions>() =>\n\tcreateAuthEndpoint(\n\t\t\"/sign-in/email\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\toperationId: \"signInEmail\",\n\t\t\tuse: [formCsrfMiddleware],\n\t\t\tbody: z.object({\n\t\t\t\t/**\n\t\t\t\t * Email of the user\n\t\t\t\t */\n\t\t\t\temail: z.string().meta({\n\t\t\t\t\tdescription: \"Email of the user\",\n\t\t\t\t}),\n\t\t\t\t/**\n\t\t\t\t * Password of the user\n\t\t\t\t */\n\t\t\t\tpassword: z.string().meta({\n\t\t\t\t\tdescription: \"Password of the user\",\n\t\t\t\t}),\n\t\t\t\t/**\n\t\t\t\t * Callback URL to use as a redirect for email\n\t\t\t\t * verification and for possible redirects\n\t\t\t\t */\n\t\t\t\tcallbackURL: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.meta({\n\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\"Callback URL to use as a redirect for email verification\",\n\t\t\t\t\t})\n\t\t\t\t\t.optional(),\n\t\t\t\t/**\n\t\t\t\t * If this is false, the session will not be remembered\n\t\t\t\t * @default true\n\t\t\t\t */\n\t\t\t\trememberMe: z\n\t\t\t\t\t.boolean()\n\t\t\t\t\t.meta({\n\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\"If this is false, the session will not be remembered. Default is `true`.\",\n\t\t\t\t\t})\n\t\t\t\t\t.default(true)\n\t\t\t\t\t.optional(),\n\t\t\t}),\n\t\t\tmetadata: {\n\t\t\t\tallowedMediaTypes: [\n\t\t\t\t\t\"application/x-www-form-urlencoded\",\n\t\t\t\t\t\"application/json\",\n\t\t\t\t],\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\temail: string;\n\t\t\t\t\t\tpassword: string;\n\t\t\t\t\t\tcallbackURL?: string | undefined;\n\t\t\t\t\t\trememberMe?: boolean | undefined;\n\t\t\t\t\t},\n\t\t\t\t\treturned: {} as {\n\t\t\t\t\t\tredirect: boolean;\n\t\t\t\t\t\ttoken: string;\n\t\t\t\t\t\turl?: string | undefined;\n\t\t\t\t\t\tuser: InferUser<O>;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"signInEmail\",\n\t\t\t\t\tdescription: \"Sign in with email and password\",\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Success - Returns either session details or redirect URL\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\t// todo: we need support for multiple schema\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"Session response when idToken is provided\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tredirect: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\tenum: [false],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Session token\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\turl: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"redirect\", \"token\", \"user\"],\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (\n\t\t\tctx,\n\t\t): Promise<{\n\t\t\tredirect: boolean;\n\t\t\ttoken: string;\n\t\t\turl?: string | undefined;\n\t\t\tuser: InferUser<O>;\n\t\t}> => {\n\t\t\tif (!ctx.context.options?.emailAndPassword?.enabled) {\n\t\t\t\tctx.context.logger.error(\n\t\t\t\t\t\"Email and password is not enabled. Make sure to enable it in the options on you `auth.ts` file. Check `https://better-auth.com/docs/authentication/email-password` for more!\",\n\t\t\t\t);\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"Email and password is not enabled\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst { email, password } = ctx.body;\n\t\t\tconst isValidEmail = z.email().safeParse(email);\n\t\t\tif (!isValidEmail.success) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.internalAdapter.findUserByEmail(email, {\n\t\t\t\tincludeAccounts: true,\n\t\t\t});\n\n\t\t\tif (!user) {\n\t\t\t\t// Hash password to prevent timing attacks from revealing valid email addresses\n\t\t\t\t// By hashing passwords for invalid emails, we ensure consistent response times\n\t\t\t\tawait ctx.context.password.hash(password);\n\t\t\t\tctx.context.logger.error(\"User not found\", { email });\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst credentialAccount = user.accounts.find(\n\t\t\t\t(a) => a.providerId === \"credential\",\n\t\t\t);\n\t\t\tif (!credentialAccount) {\n\t\t\t\tawait ctx.context.password.hash(password);\n\t\t\t\tctx.context.logger.error(\"Credential account not found\", { email });\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst currentPassword = credentialAccount?.password;\n\t\t\tif (!currentPassword) {\n\t\t\t\tawait ctx.context.password.hash(password);\n\t\t\t\tctx.context.logger.error(\"Password not found\", { email });\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst validPassword = await ctx.context.password.verify({\n\t\t\t\thash: currentPassword,\n\t\t\t\tpassword,\n\t\t\t});\n\t\t\tif (!validPassword) {\n\t\t\t\tctx.context.logger.error(\"Invalid password\");\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL_OR_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tctx.context.options?.emailAndPassword?.requireEmailVerification &&\n\t\t\t\t!user.user.emailVerified\n\t\t\t) {\n\t\t\t\tif (!ctx.context.options?.emailVerification?.sendVerificationEmail) {\n\t\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.EMAIL_NOT_VERIFIED,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (ctx.context.options?.emailVerification?.sendOnSignIn) {\n\t\t\t\t\tconst token = await createEmailVerificationToken(\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\tuser.user.email,\n\t\t\t\t\t\tundefined,\n\t\t\t\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t\t\t);\n\t\t\t\t\tconst callbackURL = ctx.body.callbackURL\n\t\t\t\t\t\t? encodeURIComponent(ctx.body.callbackURL)\n\t\t\t\t\t\t: encodeURIComponent(\"/\");\n\t\t\t\t\tconst url = `${ctx.context.baseURL}/verify-email?token=${token}&callbackURL=${callbackURL}`;\n\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tuser: user.user,\n\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\ttoken,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tthrow new APIError(\"FORBIDDEN\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.EMAIL_NOT_VERIFIED,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\tuser.user.id,\n\t\t\t\tctx.body.rememberMe === false,\n\t\t\t);\n\n\t\t\tif (!session) {\n\t\t\t\tctx.context.logger.error(\"Failed to create session\");\n\t\t\t\tthrow new APIError(\"UNAUTHORIZED\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tawait setSessionCookie(\n\t\t\t\tctx,\n\t\t\t\t{\n\t\t\t\t\tsession,\n\t\t\t\t\tuser: user.user,\n\t\t\t\t},\n\t\t\t\tctx.body.rememberMe === false,\n\t\t\t);\n\n\t\t\tif (ctx.body.callbackURL) {\n\t\t\t\tctx.setHeader(\"Location\", ctx.body.callbackURL);\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tredirect: !!ctx.body.callbackURL,\n\t\t\t\ttoken: session.token,\n\t\t\t\turl: ctx.body.callbackURL,\n\t\t\t\tuser: parseUserOutput(ctx.context.options, user.user) as InferUser<O>,\n\t\t\t});\n\t\t},\n\t);\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAcA,MAAM,yBAAyB,EAAE,yJAAA,CAAO;IAKvC,aAAa,EACX,yJAAA,EAAQ,CACR,IAAA,CAAK;QACL,aAAa;IAAA,CACb,CAAC,CACD,QAAA,EAAU;IAMZ,oBAAoB,EAAE,yJAAA,EAAQ,CAAC,QAAA,EAAU;IAOzC,kBAAkB,EAChB,yJAAA,EAAQ,CACR,IAAA,CAAK;QACL,aAAa;IAAA,CACb,CAAC,CACD,QAAA,EAAU;IAIZ,UAAU,6NAAA;IAOV,iBAAiB,EACf,0JAAA,EAAS,CACT,IAAA,CAAK;QACL,aACC;IAAA,CACD,CAAC,CACD,QAAA,EAAU;IAYZ,SAAS,EAAE,2JAAA,CACV,EAAE,yJAAA,CAAO;QAIR,OAAO,EAAE,yJAAA,EAAQ,CAAC,IAAA,CAAK;YACtB,aAAa;QAAA,CACb,CAAC;QAIF,OAAO,EACL,yJAAA,EAAQ,CACR,IAAA,CAAK;YACL,aAAa;QAAA,CACb,CAAC,CACD,QAAA,EAAU;QAIZ,aAAa,EACX,yJAAA,EAAQ,CACR,IAAA,CAAK;YACL,aAAa;QAAA,CACb,CAAC,CACD,QAAA,EAAU;QAIZ,cAAc,EACZ,yJAAA,EAAQ,CACR,IAAA,CAAK;YACL,aAAa;QAAA,CACb,CAAC,CACD,QAAA,EAAU;QAIZ,WAAW,EACT,yJAAA,EAAQ,CACR,IAAA,CAAK;YACL,aAAa;QAAA,CACb,CAAC,CACD,QAAA,EAAU;KACZ,CAAC,CACF;IACD,QAAQ,EACN,wJAAA,CAAM,EAAE,yJAAA,EAAQ,CAAC,CACjB,IAAA,CAAK;QACL,aACC;IAAA,CACD,CAAC,CACD,QAAA,EAAU;IAQZ,eAAe,EACb,0JAAA,EAAS,CACT,IAAA,CAAK;QACL,aACC;IAAA,CACD,CAAC,CACD,QAAA,EAAU;IAIZ,WAAW,EACT,yJAAA,EAAQ,CACR,IAAA,CAAK;QACL,aAAa;IAAA,CACb,CAAC,CACD,QAAA,EAAU;IAIZ,gBAAgB,EAAE,yJAAA,CAAO,EAAE,yJAAA,EAAQ,EAAE,EAAE,sJAAA,EAAK,CAAC,CAAC,QAAA,EAAU,CAAC,IAAA,CAAK;QAC7D,aAAa;IAAA,CACb,CAAC;CACF,CAAC;AAEF,MAAa,eAAA,QACZ,yLAAA,EACC,mBACA;QACC,QAAQ;QACR,aAAa;QACb,MAAM;QACN,UAAU;YACT,QAAQ;gBACP,MAAM,CAAA,CAAE;gBACR,UAAU,CAAA,CAAE;aAMZ;YACD,SAAS;gBACR,aAAa;gBACb,aAAa;gBACb,WAAW;oBACV,OAAO;wBACN,aACC;wBACD,SAAS;4BACR,oBAAoB;gCACnB,QAAQ;oCAEP,MAAM;oCACN,aAAa;oCACb,YAAY;wCACX,OAAO;4CACN,MAAM;wCAAA,CACN;wCACD,MAAM;4CACL,MAAM;4CACN,MAAM;yCACN;wCACD,KAAK;4CACJ,MAAM;wCAAA,CACN;wCACD,UAAU;4CACT,MAAM;4CACN,MAAM;gDAAC;6CAAM;yCACb;qCACD;oCACD,UAAU;wCAAC;wCAAY;wCAAS;qCAAO;iCACvC;4BAAA,CACD;wBAAA,CACD;qBACD;gBAAA,CACD;aACD;SACD;KACD,EACD,OACC,MAII;QACJ,MAAM,WAAW,EAAE,OAAA,CAAQ,eAAA,CAAgB,IAAA,CAAA,CACzC,IAAM,EAAE,EAAA,KAAO,EAAE,IAAA,CAAK,QAAA,CACvB;QACD,IAAI,CAAC,UAAU;YACd,EAAE,OAAA,CAAQ,MAAA,CAAO,KAAA,CAChB,yEACA;gBACC,UAAU,EAAE,IAAA,CAAK,QAAA;YAAA,CACjB,CACD;YACD,MAAM,IAAI,8JAAA,CAAS,aAAa;gBAC/B,SAAS,yLAAA,CAAiB,kBAAA;YAAA,CAC1B,CAAC;;QAGH,IAAI,EAAE,IAAA,CAAK,OAAA,EAAS;YACnB,IAAI,CAAC,SAAS,aAAA,EAAe;gBAC5B,EAAE,OAAA,CAAQ,MAAA,CAAO,KAAA,CAChB,mDACA;oBACC,UAAU,EAAE,IAAA,CAAK,QAAA;gBAAA,CACjB,CACD;gBACD,MAAM,IAAI,8JAAA,CAAS,aAAa;oBAC/B,SAAS,yLAAA,CAAiB,sBAAA;gBAAA,CAC1B,CAAC;;YAEH,MAAM,EAAE,KAAA,EAAO,KAAA,EAAA,GAAU,EAAE,IAAA,CAAK,OAAA;YAEhC,IAAI,CADU,MAAM,SAAS,aAAA,CAAc,OAAO,MAAM,EAC5C;gBACX,EAAE,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,oBAAoB;oBAC1C,UAAU,EAAE,IAAA,CAAK,QAAA;gBAAA,CACjB,CAAC;gBACF,MAAM,IAAI,8JAAA,CAAS,gBAAgB;oBAClC,SAAS,yLAAA,CAAiB,aAAA;gBAAA,CAC1B,CAAC;;YAEH,MAAM,WAAW,MAAM,SAAS,WAAA,CAAY;gBAC3C,SAAS;gBACT,aAAa,EAAE,IAAA,CAAK,OAAA,CAAQ,WAAA;gBAC5B,cAAc,EAAE,IAAA,CAAK,OAAA,CAAQ,YAAA;aAC7B,CAAC;YACF,IAAI,CAAC,YAAY,CAAC,UAAU,MAAM;gBACjC,EAAE,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,2BAA2B;oBACjD,UAAU,EAAE,IAAA,CAAK,QAAA;gBAAA,CACjB,CAAC;gBACF,MAAM,IAAI,8JAAA,CAAS,gBAAgB;oBAClC,SAAS,yLAAA,CAAiB,uBAAA;gBAAA,CAC1B,CAAC;;YAEH,IAAI,CAAC,SAAS,IAAA,CAAK,KAAA,EAAO;gBACzB,EAAE,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,wBAAwB;oBAC9C,UAAU,EAAE,IAAA,CAAK,QAAA;gBAAA,CACjB,CAAC;gBACF,MAAM,IAAI,8JAAA,CAAS,gBAAgB;oBAClC,SAAS,yLAAA,CAAiB,oBAAA;gBAAA,CAC1B,CAAC;;YAEH,MAAM,OAAO,UAAM,6LAAA,EAAoB,GAAG;gBACzC,UAAU;oBACT,GAAG,SAAS,IAAA;oBACZ,OAAO,SAAS,IAAA,CAAK,KAAA;oBACrB,IAAI,OAAO,SAAS,IAAA,CAAK,EAAA,CAAG;oBAC5B,MAAM,SAAS,IAAA,CAAK,IAAA,IAAQ;oBAC5B,OAAO,SAAS,IAAA,CAAK,KAAA;oBACrB,eAAe,SAAS,IAAA,CAAK,aAAA,IAAiB;iBAC9C;gBACD,SAAS;oBACR,YAAY,SAAS,EAAA;oBACrB,WAAW,OAAO,SAAS,IAAA,CAAK,EAAA,CAAG;oBACnC,aAAa,EAAE,IAAA,CAAK,OAAA,CAAQ,WAAA;iBAC5B;gBACD,aAAa,EAAE,IAAA,CAAK,WAAA;gBACpB,eACE,SAAS,qBAAA,IAAyB,CAAC,EAAE,IAAA,CAAK,aAAA,IAC3C,SAAS,aAAA;aACV,CAAC;YACF,IAAI,KAAK,KAAA,CACR,CAAA,MAAM,IAAI,8JAAA,CAAS,gBAAgB;gBAClC,SAAS,KAAK,KAAA;YAAA,CACd,CAAC;YAEH,UAAM,iMAAA,EAAiB,GAAG,KAAK,IAAA,CAAM;YACrC,OAAO,EAAE,IAAA,CAAK;gBACb,UAAU;gBACV,OAAO,KAAK,IAAA,CAAM,OAAA,CAAQ,KAAA;gBAC1B,KAAK,KAAA;gBACL,UAAM,4KAAA,EACL,EAAE,OAAA,CAAQ,OAAA,EACV,KAAK,IAAA,CAAM,IAAA,CACX;aACD,CAAC;;QAGH,MAAM,EAAE,YAAA,EAAc,KAAA,EAAA,GAAU,UAAM,6KAAA,EACrC,GACA,KAAA,GACA,EAAE,IAAA,CAAK,cAAA,CACP;QACD,MAAM,MAAM,MAAM,SAAS,sBAAA,CAAuB;YACjD;YACA;YACA,aAAa,GAAG,EAAE,OAAA,CAAQ,OAAA,CAAQ,UAAA,EAAY,SAAS,EAAA,EAAA;YACvD,QAAQ,EAAE,IAAA,CAAK,MAAA;YACf,WAAW,EAAE,IAAA,CAAK,SAAA;SAClB,CAAC;QAEF,IAAI,CAAC,EAAE,IAAA,CAAK,eAAA,CACX,CAAA,EAAE,SAAA,CAAU,YAAY,IAAI,QAAA,EAAU,CAAC;QAGxC,OAAO,EAAE,IAAA,CAAK;YACb,KAAK,IAAI,QAAA,EAAU;YACnB,UAAU,CAAC,EAAE,IAAA,CAAK,eAAA;SAClB,CAAC;MAEH;AAEF,MAAa,cAAA,QACZ,yLAAA,EACC,kBACA;QACC,QAAQ;QACR,aAAa;QACb,KAAK;YAAC,wMAAA;SAAmB;QACzB,MAAM,EAAE,yJAAA,CAAO;YAId,OAAO,EAAE,yJAAA,EAAQ,CAAC,IAAA,CAAK;gBACtB,aAAa;YAAA,CACb,CAAC;YAIF,UAAU,EAAE,yJAAA,EAAQ,CAAC,IAAA,CAAK;gBACzB,aAAa;YAAA,CACb,CAAC;YAKF,aAAa,EACX,yJAAA,EAAQ,CACR,IAAA,CAAK;gBACL,aACC;YAAA,CACD,CAAC,CACD,QAAA,EAAU;YAKZ,YAAY,EACV,0JAAA,EAAS,CACT,IAAA,CAAK;gBACL,aACC;YAAA,CACD,CAAC,CACD,OAAA,CAAQ,KAAK,CACb,QAAA,EAAU;SACZ,CAAC;QACF,UAAU;YACT,mBAAmB;gBAClB;gBACA;aACA;YACD,QAAQ;gBACP,MAAM,CAAA,CAAE;gBAMR,UAAU,CAAA,CAAE;aAMZ;YACD,SAAS;gBACR,aAAa;gBACb,aAAa;gBACb,WAAW;oBACV,OAAO;wBACN,aACC;wBACD,SAAS;4BACR,oBAAoB;gCACnB,QAAQ;oCAEP,MAAM;oCACN,aAAa;oCACb,YAAY;wCACX,UAAU;4CACT,MAAM;4CACN,MAAM;gDAAC;6CAAM;yCACb;wCACD,OAAO;4CACN,MAAM;4CACN,aAAa;yCACb;wCACD,KAAK;4CACJ,MAAM;4CACN,UAAU;yCACV;wCACD,MAAM;4CACL,MAAM;4CACN,MAAM;yCACN;qCACD;oCACD,UAAU;wCAAC;wCAAY;wCAAS;qCAAO;iCACvC;4BAAA,CACD;wBAAA,CACD;qBACD;gBAAA,CACD;aACD;SACD;KACD,EACD,OACC,QAMK;QACL,IAAI,CAAC,IAAI,OAAA,CAAQ,OAAA,EAAS,kBAAkB,SAAS;YACpD,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAClB,+KACA;YACD,MAAM,IAAI,8JAAA,CAAS,eAAe;gBACjC,SAAS;YAAA,CACT,CAAC;;QAEH,MAAM,EAAE,KAAA,EAAO,QAAA,EAAA,GAAa,IAAI,IAAA;QAEhC,IAAI,CADiB,EAAE,wJAAA,EAAO,CAAC,SAAA,CAAU,MAAM,CAC7B,OAAA,CACjB,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;YACjC,SAAS,yLAAA,CAAiB,aAAA;QAAA,CAC1B,CAAC;QAEH,MAAM,OAAO,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,eAAA,CAAgB,OAAO;YACrE,iBAAiB;QAAA,CACjB,CAAC;QAEF,IAAI,CAAC,MAAM;YAGV,MAAM,IAAI,OAAA,CAAQ,QAAA,CAAS,IAAA,CAAK,SAAS;YACzC,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,kBAAkB;gBAAE;YAAA,CAAO,CAAC;YACrD,MAAM,IAAI,8JAAA,CAAS,gBAAgB;gBAClC,SAAS,yLAAA,CAAiB,yBAAA;YAAA,CAC1B,CAAC;;QAGH,MAAM,oBAAoB,KAAK,QAAA,CAAS,IAAA,CAAA,CACtC,IAAM,EAAE,UAAA,KAAe,aACxB;QACD,IAAI,CAAC,mBAAmB;YACvB,MAAM,IAAI,OAAA,CAAQ,QAAA,CAAS,IAAA,CAAK,SAAS;YACzC,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,gCAAgC;gBAAE;YAAA,CAAO,CAAC;YACnE,MAAM,IAAI,8JAAA,CAAS,gBAAgB;gBAClC,SAAS,yLAAA,CAAiB,yBAAA;YAAA,CAC1B,CAAC;;QAEH,MAAM,kBAAkB,mBAAmB;QAC3C,IAAI,CAAC,iBAAiB;YACrB,MAAM,IAAI,OAAA,CAAQ,QAAA,CAAS,IAAA,CAAK,SAAS;YACzC,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,sBAAsB;gBAAE;YAAA,CAAO,CAAC;YACzD,MAAM,IAAI,8JAAA,CAAS,gBAAgB;gBAClC,SAAS,yLAAA,CAAiB,yBAAA;YAAA,CAC1B,CAAC;;QAMH,IAAI,CAJkB,MAAM,IAAI,OAAA,CAAQ,QAAA,CAAS,MAAA,CAAO;YACvD,MAAM;YACN;SACA,CAAC,EACkB;YACnB,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,mBAAmB;YAC5C,MAAM,IAAI,8JAAA,CAAS,gBAAgB;gBAClC,SAAS,yLAAA,CAAiB,yBAAA;YAAA,CAC1B,CAAC;;QAGH,IACC,IAAI,OAAA,CAAQ,OAAA,EAAS,kBAAkB,4BACvC,CAAC,KAAK,IAAA,CAAK,aAAA,EACV;YACD,IAAI,CAAC,IAAI,OAAA,CAAQ,OAAA,EAAS,mBAAmB,sBAC5C,CAAA,MAAM,IAAI,8JAAA,CAAS,aAAa;gBAC/B,SAAS,yLAAA,CAAiB,kBAAA;YAAA,CAC1B,CAAC;YAGH,IAAI,IAAI,OAAA,CAAQ,OAAA,EAAS,mBAAmB,cAAc;gBACzD,MAAM,QAAQ,UAAM,mNAAA,EACnB,IAAI,OAAA,CAAQ,MAAA,EACZ,KAAK,IAAA,CAAK,KAAA,EACV,KAAA,GACA,IAAI,OAAA,CAAQ,OAAA,CAAQ,iBAAA,EAAmB,UACvC;gBACD,MAAM,cAAc,IAAI,IAAA,CAAK,WAAA,GAC1B,mBAAmB,IAAI,IAAA,CAAK,WAAA,CAAY,GACxC,mBAAmB,IAAI;gBAC1B,MAAM,MAAM,GAAG,IAAI,OAAA,CAAQ,OAAA,CAAQ,oBAAA,EAAsB,MAAM,aAAA,EAAe,aAAA;gBAC9E,MAAM,IAAI,OAAA,CAAQ,sBAAA,CACjB,IAAI,OAAA,CAAQ,OAAA,CAAQ,iBAAA,CAAkB,qBAAA,CACrC;oBACC,MAAM,KAAK,IAAA;oBACX;oBACA;iBACA,EACD,IAAI,OAAA,CACJ,CACD;;YAGF,MAAM,IAAI,8JAAA,CAAS,aAAa;gBAC/B,SAAS,yLAAA,CAAiB,kBAAA;YAAA,CAC1B,CAAC;;QAGH,MAAM,UAAU,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,aAAA,CACjD,KAAK,IAAA,CAAK,EAAA,EACV,IAAI,IAAA,CAAK,UAAA,KAAe,MACxB;QAED,IAAI,CAAC,SAAS;YACb,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,2BAA2B;YACpD,MAAM,IAAI,8JAAA,CAAS,gBAAgB;gBAClC,SAAS,yLAAA,CAAiB,wBAAA;YAAA,CAC1B,CAAC;;QAGH,UAAM,iMAAA,EACL,KACA;YACC;YACA,MAAM,KAAK,IAAA;SACX,EACD,IAAI,IAAA,CAAK,UAAA,KAAe,MACxB;QAED,IAAI,IAAI,IAAA,CAAK,WAAA,CACZ,CAAA,IAAI,SAAA,CAAU,YAAY,IAAI,IAAA,CAAK,WAAA,CAAY;QAGhD,OAAO,IAAI,IAAA,CAAK;YACf,UAAU,CAAC,CAAC,IAAI,IAAA,CAAK,WAAA;YACrB,OAAO,QAAQ,KAAA;YACf,KAAK,IAAI,IAAA,CAAK,WAAA;YACd,UAAM,4KAAA,EAAgB,IAAI,OAAA,CAAQ,OAAA,EAAS,KAAK,IAAA,CAAK;SACrD,CAAC;MAEH"}},
    {"offset": {"line": 3408, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/sign-out.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/sign-out.ts"],"sourcesContent":["import { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { deleteSessionCookie } from \"../../cookies\";\n\nexport const signOut = createAuthEndpoint(\n\t\"/sign-out\",\n\t{\n\t\tmethod: \"POST\",\n\t\toperationId: \"signOut\",\n\t\trequireHeaders: true,\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"signOut\",\n\t\t\t\tdescription: \"Sign out the current user\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst sessionCookieToken = await ctx.getSignedCookie(\n\t\t\tctx.context.authCookies.sessionToken.name,\n\t\t\tctx.context.secret,\n\t\t);\n\t\tif (sessionCookieToken) {\n\t\t\ttry {\n\t\t\t\tawait ctx.context.internalAdapter.deleteSession(sessionCookieToken);\n\t\t\t} catch (e) {\n\t\t\t\tctx.context.logger.error(\"Failed to delete session from database\", e);\n\t\t\t}\n\t\t}\n\t\tdeleteSessionCookie(ctx);\n\t\treturn ctx.json({\n\t\t\tsuccess: true,\n\t\t});\n\t},\n);\n"],"names":[],"mappings":";;;;;;;;;AAGA,MAAa,cAAU,yLAAA,EACtB,aACA;IACC,QAAQ;IACR,aAAa;IACb,gBAAgB;IAChB,UAAU;QACT,SAAS;YACR,aAAa;YACb,aAAa;YACb,WAAW;gBACV,OAAO;oBACN,aAAa;oBACb,SAAS;wBACR,oBAAoB;4BACnB,QAAQ;gCACP,MAAM;gCACN,YAAY;oCACX,SAAS;wCACR,MAAM;oCAAA,CACN;gCAAA,CACD;6BACD;wBAAA,CACD;oBAAA,CACD;iBACD;YAAA,CACD;SACD;IAAA,CACD;CACD,EACD,OAAO,QAAQ;IACd,MAAM,qBAAqB,MAAM,IAAI,eAAA,CACpC,IAAI,OAAA,CAAQ,WAAA,CAAY,YAAA,CAAa,IAAA,EACrC,IAAI,OAAA,CAAQ,MAAA,CACZ;IACD,IAAI,mBACH,CAAA,IAAI;QACH,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,aAAA,CAAc,mBAAmB;aAC3D,GAAG;QACX,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,0CAA0C,EAAE;;IAGvE,IAAA,oMAAA,EAAoB,IAAI;IACxB,OAAO,IAAI,IAAA,CAAK;QACf,SAAS;IAAA,CACT,CAAC;EAEH"}},
    {"offset": {"line": 3462, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/sign-up.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/sign-up.ts"],"sourcesContent":["import type { BetterAuthOptions } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { runWithTransaction } from \"@better-auth/core/context\";\nimport { isDevelopment } from \"@better-auth/core/env\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { setSessionCookie } from \"../../cookies\";\nimport { parseUserInput } from \"../../db\";\nimport { parseUserOutput } from \"../../db/schema\";\nimport type { AdditionalUserFieldsInput, InferUser, User } from \"../../types\";\n\nimport { formCsrfMiddleware } from \"../middlewares/origin-check\";\nimport { createEmailVerificationToken } from \"./email-verification\";\n\nconst signUpEmailBodySchema = z\n\t.object({\n\t\tname: z.string(),\n\t\temail: z.email(),\n\t\tpassword: z.string().nonempty(),\n\t\timage: z.string().optional(),\n\t\tcallbackURL: z.string().optional(),\n\t\trememberMe: z.boolean().optional(),\n\t})\n\t.and(z.record(z.string(), z.any()));\n\nexport const signUpEmail = <O extends BetterAuthOptions>() =>\n\tcreateAuthEndpoint(\n\t\t\"/sign-up/email\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\toperationId: \"signUpWithEmailAndPassword\",\n\t\t\tuse: [formCsrfMiddleware],\n\t\t\tbody: signUpEmailBodySchema,\n\t\t\tmetadata: {\n\t\t\t\tallowedMediaTypes: [\n\t\t\t\t\t\"application/x-www-form-urlencoded\",\n\t\t\t\t\t\"application/json\",\n\t\t\t\t],\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as {\n\t\t\t\t\t\tname: string;\n\t\t\t\t\t\temail: string;\n\t\t\t\t\t\tpassword: string;\n\t\t\t\t\t\timage?: string | undefined;\n\t\t\t\t\t\tcallbackURL?: string | undefined;\n\t\t\t\t\t\trememberMe?: boolean | undefined;\n\t\t\t\t\t} & AdditionalUserFieldsInput<O>,\n\t\t\t\t\treturned: {} as {\n\t\t\t\t\t\ttoken: string | null;\n\t\t\t\t\t\tuser: InferUser<O>;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"signUpWithEmailAndPassword\",\n\t\t\t\t\tdescription: \"Sign up a user using email and password\",\n\t\t\t\t\trequestBody: {\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The name of the user\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The email of the user\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tpassword: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The password of the user\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The profile image URL of the user\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tcallbackURL: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"The URL to use for email verification callback\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trememberMe: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"If this is false, the session will not be remembered. Default is `true`.\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"name\", \"email\", \"password\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Successfully created user\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Authentication token for the session\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The unique identifier of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The email address of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The name of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The profile image URL of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\temailVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the email has been verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"When the user was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"When the user was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"emailVerified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\trequired: [\"user\"], // token is optional\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"422\": {\n\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\"Unprocessable Entity. User already exists or failed to create user.\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\treturn runWithTransaction(ctx.context.adapter, async () => {\n\t\t\t\tif (\n\t\t\t\t\t!ctx.context.options.emailAndPassword?.enabled ||\n\t\t\t\t\tctx.context.options.emailAndPassword?.disableSignUp\n\t\t\t\t) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: \"Email and password sign up is not enabled\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst body = ctx.body as any as User & {\n\t\t\t\t\tpassword: string;\n\t\t\t\t\tcallbackURL?: string | undefined;\n\t\t\t\t\trememberMe?: boolean | undefined;\n\t\t\t\t} & {\n\t\t\t\t\t[key: string]: any;\n\t\t\t\t};\n\t\t\t\tconst {\n\t\t\t\t\tname,\n\t\t\t\t\temail,\n\t\t\t\t\tpassword,\n\t\t\t\t\timage,\n\t\t\t\t\tcallbackURL: _callbackURL,\n\t\t\t\t\trememberMe,\n\t\t\t\t\t...rest\n\t\t\t\t} = body;\n\t\t\t\tconst isValidEmail = z.email().safeParse(email);\n\n\t\t\t\tif (!isValidEmail.success) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_EMAIL,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (!password || typeof password !== \"string\") {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_PASSWORD,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst minPasswordLength = ctx.context.password.config.minPasswordLength;\n\t\t\t\tif (password.length < minPasswordLength) {\n\t\t\t\t\tctx.context.logger.error(\"Password is too short\");\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst maxPasswordLength = ctx.context.password.config.maxPasswordLength;\n\t\t\t\tif (password.length > maxPasswordLength) {\n\t\t\t\t\tctx.context.logger.error(\"Password is too long\");\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tconst dbUser = await ctx.context.internalAdapter.findUserByEmail(email);\n\t\t\t\tif (dbUser?.user) {\n\t\t\t\t\tctx.context.logger.info(\n\t\t\t\t\t\t`Sign-up attempt for existing email: ${email}`,\n\t\t\t\t\t);\n\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\t/**\n\t\t\t\t * Hash the password\n\t\t\t\t *\n\t\t\t\t * This is done prior to creating the user\n\t\t\t\t * to ensure that any plugin that\n\t\t\t\t * may break the hashing should break\n\t\t\t\t * before the user is created.\n\t\t\t\t */\n\t\t\t\tconst hash = await ctx.context.password.hash(password);\n\t\t\t\tlet createdUser: User;\n\t\t\t\ttry {\n\t\t\t\t\tconst data = parseUserInput(ctx.context.options, rest, \"create\");\n\t\t\t\t\tcreatedUser = await ctx.context.internalAdapter.createUser({\n\t\t\t\t\t\temail: email.toLowerCase(),\n\t\t\t\t\t\tname,\n\t\t\t\t\t\timage,\n\t\t\t\t\t\t...data,\n\t\t\t\t\t\temailVerified: false,\n\t\t\t\t\t});\n\t\t\t\t\tif (!createdUser) {\n\t\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (isDevelopment()) {\n\t\t\t\t\t\tctx.context.logger.error(\"Failed to create user\", e);\n\t\t\t\t\t}\n\t\t\t\t\tif (e instanceof APIError) {\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t}\n\t\t\t\t\tctx.context.logger?.error(\"Failed to create user\", e);\n\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (!createdUser) {\n\t\t\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_USER,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tawait ctx.context.internalAdapter.linkAccount({\n\t\t\t\t\tuserId: createdUser.id,\n\t\t\t\t\tproviderId: \"credential\",\n\t\t\t\t\taccountId: createdUser.id,\n\t\t\t\t\tpassword: hash,\n\t\t\t\t});\n\t\t\t\tconst shouldSendVerificationEmail =\n\t\t\t\t\tctx.context.options.emailVerification?.sendOnSignUp ??\n\t\t\t\t\tctx.context.options.emailAndPassword.requireEmailVerification;\n\t\t\t\tif (shouldSendVerificationEmail) {\n\t\t\t\t\tconst token = await createEmailVerificationToken(\n\t\t\t\t\t\tctx.context.secret,\n\t\t\t\t\t\tcreatedUser.email,\n\t\t\t\t\t\tundefined,\n\t\t\t\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t\t\t);\n\t\t\t\t\tconst callbackURL = body.callbackURL\n\t\t\t\t\t\t? encodeURIComponent(body.callbackURL)\n\t\t\t\t\t\t: encodeURIComponent(\"/\");\n\t\t\t\t\tconst url = `${ctx.context.baseURL}/verify-email?token=${token}&callbackURL=${callbackURL}`;\n\n\t\t\t\t\tif (ctx.context.options.emailVerification?.sendVerificationEmail) {\n\t\t\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\t\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tuser: createdUser,\n\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t\ttoken,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tctx.request,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\tctx.context.options.emailAndPassword.autoSignIn === false ||\n\t\t\t\t\tctx.context.options.emailAndPassword.requireEmailVerification\n\t\t\t\t) {\n\t\t\t\t\treturn ctx.json({\n\t\t\t\t\t\ttoken: null,\n\t\t\t\t\t\tuser: parseUserOutput(\n\t\t\t\t\t\t\tctx.context.options,\n\t\t\t\t\t\t\tcreatedUser,\n\t\t\t\t\t\t) as InferUser<O>,\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst session = await ctx.context.internalAdapter.createSession(\n\t\t\t\t\tcreatedUser.id,\n\t\t\t\t\trememberMe === false,\n\t\t\t\t);\n\t\t\t\tif (!session) {\n\t\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_CREATE_SESSION,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tawait setSessionCookie(\n\t\t\t\t\tctx,\n\t\t\t\t\t{\n\t\t\t\t\t\tsession,\n\t\t\t\t\t\tuser: createdUser,\n\t\t\t\t\t},\n\t\t\t\t\trememberMe === false,\n\t\t\t\t);\n\t\t\t\treturn ctx.json({\n\t\t\t\t\ttoken: session.token,\n\t\t\t\t\tuser: parseUserOutput(\n\t\t\t\t\t\tctx.context.options,\n\t\t\t\t\t\tcreatedUser,\n\t\t\t\t\t) as InferUser<O>,\n\t\t\t\t});\n\t\t\t});\n\t\t},\n\t);\n"],"names":["createdUser: User"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAeA,MAAM,wBAAwB,EAC5B,yJAAA,CAAO;IACP,MAAM,EAAE,yJAAA,EAAQ;IAChB,OAAO,EAAE,wJAAA,EAAO;IAChB,UAAU,EAAE,yJAAA,EAAQ,CAAC,QAAA,EAAU;IAC/B,OAAO,EAAE,yJAAA,EAAQ,CAAC,QAAA,EAAU;IAC5B,aAAa,EAAE,yJAAA,EAAQ,CAAC,QAAA,EAAU;IAClC,YAAY,EAAE,0JAAA,EAAS,CAAC,QAAA,EAAU;CAClC,CAAC,CACD,GAAA,CAAI,EAAE,yJAAA,CAAO,EAAE,yJAAA,EAAQ,EAAE,EAAE,sJAAA,EAAK,CAAC,CAAC;AAEpC,MAAa,cAAA,QACZ,yLAAA,EACC,kBACA;QACC,QAAQ;QACR,aAAa;QACb,KAAK;YAAC,wMAAA;SAAmB;QACzB,MAAM;QACN,UAAU;YACT,mBAAmB;gBAClB;gBACA;aACA;YACD,QAAQ;gBACP,MAAM,CAAA,CAAE;gBAQR,UAAU,CAAA,CAAE;aAIZ;YACD,SAAS;gBACR,aAAa;gBACb,aAAa;gBACb,aAAa;oBACZ,SAAS;wBACR,oBAAoB;4BACnB,QAAQ;gCACP,MAAM;gCACN,YAAY;oCACX,MAAM;wCACL,MAAM;wCACN,aAAa;qCACb;oCACD,OAAO;wCACN,MAAM;wCACN,aAAa;qCACb;oCACD,UAAU;wCACT,MAAM;wCACN,aAAa;qCACb;oCACD,OAAO;wCACN,MAAM;wCACN,aAAa;qCACb;oCACD,aAAa;wCACZ,MAAM;wCACN,aACC;qCACD;oCACD,YAAY;wCACX,MAAM;wCACN,aACC;qCACD;iCACD;gCACD,UAAU;oCAAC;oCAAQ;oCAAS;iCAAW;6BACvC;wBAAA,CACD;oBAAA,CACD;gBAAA,CACD;gBACD,WAAW;oBACV,OAAO;wBACN,aAAa;wBACb,SAAS;4BACR,oBAAoB;gCACnB,QAAQ;oCACP,MAAM;oCACN,YAAY;wCACX,OAAO;4CACN,MAAM;4CACN,UAAU;4CACV,aAAa;yCACb;wCACD,MAAM;4CACL,MAAM;4CACN,YAAY;gDACX,IAAI;oDACH,MAAM;oDACN,aAAa;iDACb;gDACD,OAAO;oDACN,MAAM;oDACN,QAAQ;oDACR,aAAa;iDACb;gDACD,MAAM;oDACL,MAAM;oDACN,aAAa;iDACb;gDACD,OAAO;oDACN,MAAM;oDACN,QAAQ;oDACR,UAAU;oDACV,aAAa;iDACb;gDACD,eAAe;oDACd,MAAM;oDACN,aAAa;iDACb;gDACD,WAAW;oDACV,MAAM;oDACN,QAAQ;oDACR,aAAa;iDACb;gDACD,WAAW;oDACV,MAAM;oDACN,QAAQ;oDACR,aAAa;iDACb;6CACD;4CACD,UAAU;gDACT;gDACA;gDACA;gDACA;gDACA;gDACA;6CACA;yCACD;qCACD;oCACD,UAAU;wCAAC;qCAAO;iCAClB;4BAAA,CACD;wBAAA,CACD;qBACD;oBACD,OAAO;wBACN,aACC;wBACD,SAAS;4BACR,oBAAoB;gCACnB,QAAQ;oCACP,MAAM;oCACN,YAAY;wCACX,SAAS;4CACR,MAAM;wCAAA,CACN;oCAAA,CACD;iCACD;4BAAA,CACD;wBAAA,CACD;qBACD;iBACD;aACD;SACD;KACD,EACD,OAAO,QAAQ;QACd,WAAO,mMAAA,EAAmB,IAAI,OAAA,CAAQ,OAAA,EAAS,YAAY;YAC1D,IACC,CAAC,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,EAAkB,WACvC,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,EAAkB,cAEtC,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;gBACjC,SAAS;YAAA,CACT,CAAC;YAEH,MAAM,OAAO,IAAI,IAAA;YAOjB,MAAM,EACL,IAAA,EACA,KAAA,EACA,QAAA,EACA,KAAA,EACA,aAAa,YAAA,EACb,UAAA,EACA,GAAG,MAAA,GACA;YAGJ,IAAI,CAFiB,EAAE,wJAAA,EAAO,CAAC,SAAA,CAAU,MAAM,CAE7B,OAAA,CACjB,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;gBACjC,SAAS,yLAAA,CAAiB,aAAA;YAAA,CAC1B,CAAC;YAGH,IAAI,CAAC,YAAY,OAAO,aAAa,SACpC,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;gBACjC,SAAS,yLAAA,CAAiB,gBAAA;YAAA,CAC1B,CAAC;YAGH,MAAM,oBAAoB,IAAI,OAAA,CAAQ,QAAA,CAAS,MAAA,CAAO,iBAAA;YACtD,IAAI,SAAS,MAAA,GAAS,mBAAmB;gBACxC,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,wBAAwB;gBACjD,MAAM,IAAI,8JAAA,CAAS,eAAe;oBACjC,SAAS,yLAAA,CAAiB,kBAAA;gBAAA,CAC1B,CAAC;;YAGH,MAAM,oBAAoB,IAAI,OAAA,CAAQ,QAAA,CAAS,MAAA,CAAO,iBAAA;YACtD,IAAI,SAAS,MAAA,GAAS,mBAAmB;gBACxC,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,uBAAuB;gBAChD,MAAM,IAAI,8JAAA,CAAS,eAAe;oBACjC,SAAS,yLAAA,CAAiB,iBAAA;gBAAA,CAC1B,CAAC;;YAGH,IAAA,CADe,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,eAAA,CAAgB,MAAM,GAC3D,MAAM;gBACjB,IAAI,OAAA,CAAQ,MAAA,CAAO,IAAA,CAClB,CAAA,oCAAA,EAAuC,OAAA,CACvC;gBACD,MAAM,IAAI,8JAAA,CAAS,wBAAwB;oBAC1C,SAAS,yLAAA,CAAiB,qCAAA;gBAAA,CAC1B,CAAC;;;;;;;;;KAUH,MAAM,OAAO,MAAM,IAAI,OAAA,CAAQ,QAAA,CAAS,IAAA,CAAK,SAAS;YACtD,IAAIA;YACJ,IAAI;gBACH,MAAM,WAAO,2KAAA,EAAe,IAAI,OAAA,CAAQ,OAAA,EAAS,MAAM,SAAS;gBAChE,cAAc,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,UAAA,CAAW;oBAC1D,OAAO,MAAM,WAAA,EAAa;oBAC1B;oBACA;oBACA,GAAG,IAAA;oBACH,eAAe;iBACf,CAAC;gBACF,IAAI,CAAC,YACJ,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;oBACjC,SAAS,yLAAA,CAAiB,qBAAA;gBAAA,CAC1B,CAAC;qBAEK,GAAG;gBACX,QAAI,0LAAA,EAAe,CAClB,EAAA,IAAI,OAAA,CAAQ,MAAA,CAAO,KAAA,CAAM,yBAAyB,EAAE;gBAErD,IAAI,aAAa,8JAAA,CAChB,CAAA,MAAM;gBAEP,IAAI,OAAA,CAAQ,MAAA,EAAQ,MAAM,yBAAyB,EAAE;gBACrD,MAAM,IAAI,8JAAA,CAAS,wBAAwB;oBAC1C,SAAS,yLAAA,CAAiB,qBAAA;gBAAA,CAC1B,CAAC;;YAEH,IAAI,CAAC,YACJ,CAAA,MAAM,IAAI,8JAAA,CAAS,wBAAwB;gBAC1C,SAAS,yLAAA,CAAiB,qBAAA;YAAA,CAC1B,CAAC;YAEH,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,WAAA,CAAY;gBAC7C,QAAQ,YAAY,EAAA;gBACpB,YAAY;gBACZ,WAAW,YAAY,EAAA;gBACvB,UAAU;aACV,CAAC;YAIF,IAFC,IAAI,OAAA,CAAQ,OAAA,CAAQ,iBAAA,EAAmB,gBACvC,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,CAAiB,wBAAA,EACL;gBAChC,MAAM,QAAQ,UAAM,mNAAA,EACnB,IAAI,OAAA,CAAQ,MAAA,EACZ,YAAY,KAAA,EACZ,KAAA,GACA,IAAI,OAAA,CAAQ,OAAA,CAAQ,iBAAA,EAAmB,UACvC;gBACD,MAAM,cAAc,KAAK,WAAA,GACtB,mBAAmB,KAAK,WAAA,CAAY,GACpC,mBAAmB,IAAI;gBAC1B,MAAM,MAAM,GAAG,IAAI,OAAA,CAAQ,OAAA,CAAQ,oBAAA,EAAsB,MAAM,aAAA,EAAe,aAAA;gBAE9E,IAAI,IAAI,OAAA,CAAQ,OAAA,CAAQ,iBAAA,EAAmB,sBAC1C,CAAA,MAAM,IAAI,OAAA,CAAQ,sBAAA,CACjB,IAAI,OAAA,CAAQ,OAAA,CAAQ,iBAAA,CAAkB,qBAAA,CACrC;oBACC,MAAM;oBACN;oBACA;iBACA,EACD,IAAI,OAAA,CACJ,CACD;;YAIH,IACC,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,CAAiB,UAAA,KAAe,SACpD,IAAI,OAAA,CAAQ,OAAA,CAAQ,gBAAA,CAAiB,wBAAA,CAErC,CAAA,OAAO,IAAI,IAAA,CAAK;gBACf,OAAO;gBACP,UAAM,4KAAA,EACL,IAAI,OAAA,CAAQ,OAAA,EACZ,YACA;aACD,CAAC;YAGH,MAAM,UAAU,MAAM,IAAI,OAAA,CAAQ,eAAA,CAAgB,aAAA,CACjD,YAAY,EAAA,EACZ,eAAe,MACf;YACD,IAAI,CAAC,QACJ,CAAA,MAAM,IAAI,8JAAA,CAAS,eAAe;gBACjC,SAAS,yLAAA,CAAiB,wBAAA;YAAA,CAC1B,CAAC;YAEH,UAAM,iMAAA,EACL,KACA;gBACC;gBACA,MAAM;aACN,EACD,eAAe,MACf;YACD,OAAO,IAAI,IAAA,CAAK;gBACf,OAAO,QAAQ,KAAA;gBACf,UAAM,4KAAA,EACL,IAAI,OAAA,CAAQ,OAAA,EACZ,YACA;aACD,CAAC;UACD;MAEH"}},
    {"offset": {"line": 3750, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/routes/update-user.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/routes/update-user.ts"],"sourcesContent":["import type { BetterAuthOptions } from \"@better-auth/core\";\nimport { createAuthEndpoint } from \"@better-auth/core/api\";\nimport { BASE_ERROR_CODES } from \"@better-auth/core/error\";\nimport { APIError } from \"better-call\";\nimport * as z from \"zod\";\nimport { deleteSessionCookie, setSessionCookie } from \"../../cookies\";\nimport { generateRandomString } from \"../../crypto\";\nimport { parseUserInput, parseUserOutput } from \"../../db/schema\";\nimport type { AdditionalUserFieldsInput } from \"../../types\";\nimport { originCheck } from \"../middlewares\";\nimport { createEmailVerificationToken } from \"./email-verification\";\nimport {\n\tgetSessionFromCtx,\n\tsensitiveSessionMiddleware,\n\tsessionMiddleware,\n} from \"./session\";\n\nconst updateUserBodySchema = z.record(\n\tz.string().meta({\n\t\tdescription: \"Field name must be a string\",\n\t}),\n\tz.any(),\n);\n\nexport const updateUser = <O extends BetterAuthOptions>() =>\n\tcreateAuthEndpoint(\n\t\t\"/update-user\",\n\t\t{\n\t\t\tmethod: \"POST\",\n\t\t\toperationId: \"updateUser\",\n\t\t\tbody: updateUserBodySchema,\n\t\t\tuse: [sessionMiddleware],\n\t\t\tmetadata: {\n\t\t\t\t$Infer: {\n\t\t\t\t\tbody: {} as Partial<AdditionalUserFieldsInput<O>> & {\n\t\t\t\t\t\tname?: string | undefined;\n\t\t\t\t\t\timage?: string | undefined | null;\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\topenapi: {\n\t\t\t\t\toperationId: \"updateUser\",\n\t\t\t\t\tdescription: \"Update the current user\",\n\t\t\t\t\trequestBody: {\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The name of the user\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"The image of the user\",\n\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tresponses: {\n\t\t\t\t\t\t\"200\": {\n\t\t\t\t\t\t\tdescription: \"Success\",\n\t\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\tasync (ctx) => {\n\t\t\tconst body = ctx.body as {\n\t\t\t\tname?: string | undefined;\n\t\t\t\timage?: string | undefined;\n\t\t\t\t[key: string]: any;\n\t\t\t};\n\n\t\t\tif (typeof body !== \"object\" || Array.isArray(body)) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"Body must be an object\",\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (body.email) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.EMAIL_CAN_NOT_BE_UPDATED,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst { name, image, ...rest } = body;\n\t\t\tconst session = ctx.context.session;\n\t\t\tconst additionalFields = parseUserInput(\n\t\t\t\tctx.context.options,\n\t\t\t\trest,\n\t\t\t\t\"update\",\n\t\t\t);\n\t\t\tif (\n\t\t\t\timage === undefined &&\n\t\t\t\tname === undefined &&\n\t\t\t\tObject.keys(additionalFields).length === 0\n\t\t\t) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: \"No fields to update\",\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst user = await ctx.context.internalAdapter.updateUser(\n\t\t\t\tsession.user.id,\n\t\t\t\t{\n\t\t\t\t\tname,\n\t\t\t\t\timage,\n\t\t\t\t\t...additionalFields,\n\t\t\t\t},\n\t\t\t);\n\t\t\tconst updatedUser = user ?? {\n\t\t\t\t...session.user,\n\t\t\t\t...(name !== undefined && { name }),\n\t\t\t\t...(image !== undefined && { image }),\n\t\t\t\t...additionalFields,\n\t\t\t};\n\t\t\t/**\n\t\t\t * Update the session cookie with the new user data\n\t\t\t */\n\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\tsession: session.session,\n\t\t\t\tuser: updatedUser,\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t},\n\t);\n\nexport const changePassword = createAuthEndpoint(\n\t\"/change-password\",\n\t{\n\t\tmethod: \"POST\",\n\t\toperationId: \"changePassword\",\n\t\tbody: z.object({\n\t\t\t/**\n\t\t\t * The new password to set\n\t\t\t */\n\t\t\tnewPassword: z.string().meta({\n\t\t\t\tdescription: \"The new password to set\",\n\t\t\t}),\n\t\t\t/**\n\t\t\t * The current password of the user\n\t\t\t */\n\t\t\tcurrentPassword: z.string().meta({\n\t\t\t\tdescription: \"The current password is required\",\n\t\t\t}),\n\t\t\t/**\n\t\t\t * revoke all sessions that are not the\n\t\t\t * current one logged in by the user\n\t\t\t */\n\t\t\trevokeOtherSessions: z\n\t\t\t\t.boolean()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"Must be a boolean value\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tuse: [sensitiveSessionMiddleware],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"changePassword\",\n\t\t\t\tdescription: \"Change the password of the user\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Password successfully changed\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tnullable: true, // Only present if revokeOtherSessions is true\n\t\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\t\"New session token if other sessions were revoked\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\t\t\tid: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The unique identifier of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\temail: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The email address of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tname: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The name of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"uri\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"The profile image URL of the user\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\temailVerified: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"Whether the email has been verified\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tcreatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"When the user was created\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t\tupdatedAt: {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat: \"date-time\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tdescription: \"When the user was last updated\",\n\t\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\trequired: [\n\t\t\t\t\t\t\t\t\t\t\t\t\"id\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"email\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"name\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"emailVerified\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"createdAt\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"updatedAt\",\n\t\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"user\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tconst { newPassword, currentPassword, revokeOtherSessions } = ctx.body;\n\t\tconst session = ctx.context.session;\n\t\tconst minPasswordLength = ctx.context.password.config.minPasswordLength;\n\t\tif (newPassword.length < minPasswordLength) {\n\t\t\tctx.context.logger.error(\"Password is too short\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t});\n\t\t}\n\n\t\tconst maxPasswordLength = ctx.context.password.config.maxPasswordLength;\n\n\t\tif (newPassword.length > maxPasswordLength) {\n\t\t\tctx.context.logger.error(\"Password is too long\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t});\n\t\t}\n\n\t\tconst accounts = await ctx.context.internalAdapter.findAccounts(\n\t\t\tsession.user.id,\n\t\t);\n\t\tconst account = accounts.find(\n\t\t\t(account) => account.providerId === \"credential\" && account.password,\n\t\t);\n\t\tif (!account || !account.password) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.CREDENTIAL_ACCOUNT_NOT_FOUND,\n\t\t\t});\n\t\t}\n\t\tconst passwordHash = await ctx.context.password.hash(newPassword);\n\t\tconst verify = await ctx.context.password.verify({\n\t\t\thash: account.password,\n\t\t\tpassword: currentPassword,\n\t\t});\n\t\tif (!verify) {\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_PASSWORD,\n\t\t\t});\n\t\t}\n\t\tawait ctx.context.internalAdapter.updateAccount(account.id, {\n\t\t\tpassword: passwordHash,\n\t\t});\n\t\tlet token = null;\n\t\tif (revokeOtherSessions) {\n\t\t\tawait ctx.context.internalAdapter.deleteSessions(session.user.id);\n\t\t\tconst newSession = await ctx.context.internalAdapter.createSession(\n\t\t\t\tsession.user.id,\n\t\t\t);\n\t\t\tif (!newSession) {\n\t\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_GET_SESSION,\n\t\t\t\t});\n\t\t\t}\n\t\t\t// set the new session cookie\n\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\tsession: newSession,\n\t\t\t\tuser: session.user,\n\t\t\t});\n\t\t\ttoken = newSession.token;\n\t\t}\n\n\t\treturn ctx.json({\n\t\t\ttoken,\n\t\t\tuser: parseUserOutput(ctx.context.options, session.user),\n\t\t});\n\t},\n);\n\nexport const setPassword = createAuthEndpoint(\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\t/**\n\t\t\t * The new password to set\n\t\t\t */\n\t\t\tnewPassword: z.string().meta({\n\t\t\t\tdescription: \"The new password to set is required\",\n\t\t\t}),\n\t\t}),\n\t\tuse: [sensitiveSessionMiddleware],\n\t},\n\tasync (ctx) => {\n\t\tconst { newPassword } = ctx.body;\n\t\tconst session = ctx.context.session;\n\t\tconst minPasswordLength = ctx.context.password.config.minPasswordLength;\n\t\tif (newPassword.length < minPasswordLength) {\n\t\t\tctx.context.logger.error(\"Password is too short\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_SHORT,\n\t\t\t});\n\t\t}\n\n\t\tconst maxPasswordLength = ctx.context.password.config.maxPasswordLength;\n\n\t\tif (newPassword.length > maxPasswordLength) {\n\t\t\tctx.context.logger.error(\"Password is too long\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.PASSWORD_TOO_LONG,\n\t\t\t});\n\t\t}\n\n\t\tconst accounts = await ctx.context.internalAdapter.findAccounts(\n\t\t\tsession.user.id,\n\t\t);\n\t\tconst account = accounts.find(\n\t\t\t(account) => account.providerId === \"credential\" && account.password,\n\t\t);\n\t\tconst passwordHash = await ctx.context.password.hash(newPassword);\n\t\tif (!account) {\n\t\t\tawait ctx.context.internalAdapter.linkAccount({\n\t\t\t\tuserId: session.user.id,\n\t\t\t\tproviderId: \"credential\",\n\t\t\t\taccountId: session.user.id,\n\t\t\t\tpassword: passwordHash,\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t}\n\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\tmessage: \"user already has a password\",\n\t\t});\n\t},\n);\n\nexport const deleteUser = createAuthEndpoint(\n\t\"/delete-user\",\n\t{\n\t\tmethod: \"POST\",\n\t\tuse: [sensitiveSessionMiddleware],\n\t\tbody: z.object({\n\t\t\t/**\n\t\t\t * The callback URL to redirect to after the user is deleted\n\t\t\t * this is only used on delete user callback\n\t\t\t */\n\t\t\tcallbackURL: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"The callback URL to redirect to after the user is deleted\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * The password of the user. If the password isn't provided, session freshness\n\t\t\t * will be checked.\n\t\t\t */\n\t\t\tpassword: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"The password of the user is required to delete the user\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t\t/**\n\t\t\t * The token to delete the user. If the token is provided, the user will be deleted\n\t\t\t */\n\t\t\ttoken: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The token to delete the user is required\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"deleteUser\",\n\t\t\t\tdescription: \"Delete the user\",\n\t\t\t\trequestBody: {\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\tcallbackURL: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\"The callback URL to redirect to after the user is deleted\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tpassword: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\tdescription:\n\t\t\t\t\t\t\t\t\t\t\t\"The user's password. Required if session is not fresh\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttoken: {\n\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\tdescription: \"The deletion verification token\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"User deletion processed successfully\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Indicates if the operation was successful\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tenum: [\"User deleted\", \"Verification email sent\"],\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Status message of the deletion process\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"success\", \"message\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tif (!ctx.context.options.user?.deleteUser?.enabled) {\n\t\t\tctx.context.logger.error(\n\t\t\t\t\"Delete user is disabled. Enable it in the options\",\n\t\t\t);\n\t\t\tthrow new APIError(\"NOT_FOUND\");\n\t\t}\n\t\tconst session = ctx.context.session;\n\n\t\tif (ctx.body.password) {\n\t\t\tconst accounts = await ctx.context.internalAdapter.findAccounts(\n\t\t\t\tsession.user.id,\n\t\t\t);\n\t\t\tconst account = accounts.find(\n\t\t\t\t(account) => account.providerId === \"credential\" && account.password,\n\t\t\t);\n\t\t\tif (!account || !account.password) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.CREDENTIAL_ACCOUNT_NOT_FOUND,\n\t\t\t\t});\n\t\t\t}\n\t\t\tconst verify = await ctx.context.password.verify({\n\t\t\t\thash: account.password,\n\t\t\t\tpassword: ctx.body.password,\n\t\t\t});\n\t\t\tif (!verify) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_PASSWORD,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif (ctx.body.token) {\n\t\t\t//@ts-expect-error\n\t\t\tawait deleteUserCallback({\n\t\t\t\t...ctx,\n\t\t\t\tquery: {\n\t\t\t\t\ttoken: ctx.body.token,\n\t\t\t\t},\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: \"User deleted\",\n\t\t\t});\n\t\t}\n\n\t\tif (ctx.context.options.user.deleteUser?.sendDeleteAccountVerification) {\n\t\t\tconst token = generateRandomString(32, \"0-9\", \"a-z\");\n\t\t\tawait ctx.context.internalAdapter.createVerificationValue({\n\t\t\t\tvalue: session.user.id,\n\t\t\t\tidentifier: `delete-account-${token}`,\n\t\t\t\texpiresAt: new Date(\n\t\t\t\t\tDate.now() +\n\t\t\t\t\t\t(ctx.context.options.user.deleteUser?.deleteTokenExpiresIn ||\n\t\t\t\t\t\t\t60 * 60 * 24) *\n\t\t\t\t\t\t\t1000,\n\t\t\t\t),\n\t\t\t});\n\t\t\tconst url = `${\n\t\t\t\tctx.context.baseURL\n\t\t\t}/delete-user/callback?token=${token}&callbackURL=${\n\t\t\t\tctx.body.callbackURL || \"/\"\n\t\t\t}`;\n\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\tctx.context.options.user.deleteUser.sendDeleteAccountVerification(\n\t\t\t\t\t{\n\t\t\t\t\t\tuser: session.user,\n\t\t\t\t\t\turl,\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t},\n\t\t\t\t\tctx.request,\n\t\t\t\t),\n\t\t\t);\n\t\t\treturn ctx.json({\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: \"Verification email sent\",\n\t\t\t});\n\t\t}\n\n\t\tif (!ctx.body.password && ctx.context.sessionConfig.freshAge !== 0) {\n\t\t\tconst currentAge = new Date(session.session.createdAt).getTime();\n\t\t\tconst freshAge = ctx.context.sessionConfig.freshAge * 1000;\n\t\t\tconst now = Date.now();\n\t\t\tif (now - currentAge > freshAge * 1000) {\n\t\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: BASE_ERROR_CODES.SESSION_EXPIRED,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tconst beforeDelete = ctx.context.options.user.deleteUser?.beforeDelete;\n\t\tif (beforeDelete) {\n\t\t\tawait beforeDelete(session.user, ctx.request);\n\t\t}\n\t\tawait ctx.context.internalAdapter.deleteUser(session.user.id);\n\t\tawait ctx.context.internalAdapter.deleteSessions(session.user.id);\n\t\tdeleteSessionCookie(ctx);\n\t\tconst afterDelete = ctx.context.options.user.deleteUser?.afterDelete;\n\t\tif (afterDelete) {\n\t\t\tawait afterDelete(session.user, ctx.request);\n\t\t}\n\t\treturn ctx.json({\n\t\t\tsuccess: true,\n\t\t\tmessage: \"User deleted\",\n\t\t});\n\t},\n);\n\nexport const deleteUserCallback = createAuthEndpoint(\n\t\"/delete-user/callback\",\n\t{\n\t\tmethod: \"GET\",\n\t\tquery: z.object({\n\t\t\ttoken: z.string().meta({\n\t\t\t\tdescription: \"The token to verify the deletion request\",\n\t\t\t}),\n\t\t\tcallbackURL: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The URL to redirect to after deletion\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tuse: [originCheck((ctx) => ctx.query.callbackURL)],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\tdescription:\n\t\t\t\t\t\"Callback to complete user deletion with verification token\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"User successfully deleted\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tsuccess: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Indicates if the deletion was successful\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tenum: [\"User deleted\"],\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Confirmation message\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"success\", \"message\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tif (!ctx.context.options.user?.deleteUser?.enabled) {\n\t\t\tctx.context.logger.error(\n\t\t\t\t\"Delete user is disabled. Enable it in the options\",\n\t\t\t);\n\t\t\tthrow new APIError(\"NOT_FOUND\");\n\t\t}\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (!session) {\n\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.FAILED_TO_GET_USER_INFO,\n\t\t\t});\n\t\t}\n\t\tconst token = await ctx.context.internalAdapter.findVerificationValue(\n\t\t\t`delete-account-${ctx.query.token}`,\n\t\t);\n\t\tif (!token || token.expiresAt < new Date()) {\n\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_TOKEN,\n\t\t\t});\n\t\t}\n\t\tif (token.value !== session.user.id) {\n\t\t\tthrow new APIError(\"NOT_FOUND\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.INVALID_TOKEN,\n\t\t\t});\n\t\t}\n\t\tconst beforeDelete = ctx.context.options.user.deleteUser?.beforeDelete;\n\t\tif (beforeDelete) {\n\t\t\tawait beforeDelete(session.user, ctx.request);\n\t\t}\n\t\tawait ctx.context.internalAdapter.deleteUser(session.user.id);\n\t\tawait ctx.context.internalAdapter.deleteSessions(session.user.id);\n\t\tawait ctx.context.internalAdapter.deleteAccounts(session.user.id);\n\t\tawait ctx.context.internalAdapter.deleteVerificationValue(token.id);\n\n\t\tdeleteSessionCookie(ctx);\n\n\t\tconst afterDelete = ctx.context.options.user.deleteUser?.afterDelete;\n\t\tif (afterDelete) {\n\t\t\tawait afterDelete(session.user, ctx.request);\n\t\t}\n\t\tif (ctx.query.callbackURL) {\n\t\t\tthrow ctx.redirect(ctx.query.callbackURL || \"/\");\n\t\t}\n\t\treturn ctx.json({\n\t\t\tsuccess: true,\n\t\t\tmessage: \"User deleted\",\n\t\t});\n\t},\n);\n\nexport const changeEmail = createAuthEndpoint(\n\t\"/change-email\",\n\t{\n\t\tmethod: \"POST\",\n\t\tbody: z.object({\n\t\t\tnewEmail: z.email().meta({\n\t\t\t\tdescription:\n\t\t\t\t\t\"The new email address to set must be a valid email address\",\n\t\t\t}),\n\t\t\tcallbackURL: z\n\t\t\t\t.string()\n\t\t\t\t.meta({\n\t\t\t\t\tdescription: \"The URL to redirect to after email verification\",\n\t\t\t\t})\n\t\t\t\t.optional(),\n\t\t}),\n\t\tuse: [sensitiveSessionMiddleware],\n\t\tmetadata: {\n\t\t\topenapi: {\n\t\t\t\toperationId: \"changeEmail\",\n\t\t\t\tresponses: {\n\t\t\t\t\t\"200\": {\n\t\t\t\t\t\tdescription: \"Email change request processed successfully\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\t\t\t$ref: \"#/components/schemas/User\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tstatus: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"boolean\",\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Indicates if the request was successful\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t\tenum: [\"Email updated\", \"Verification email sent\"],\n\t\t\t\t\t\t\t\t\t\t\tdescription: \"Status message of the email change process\",\n\t\t\t\t\t\t\t\t\t\t\tnullable: true,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\trequired: [\"status\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t\"422\": {\n\t\t\t\t\t\tdescription: \"Unprocessable Entity. Email already exists\",\n\t\t\t\t\t\tcontent: {\n\t\t\t\t\t\t\t\"application/json\": {\n\t\t\t\t\t\t\t\tschema: {\n\t\t\t\t\t\t\t\t\ttype: \"object\",\n\t\t\t\t\t\t\t\t\tproperties: {\n\t\t\t\t\t\t\t\t\t\tmessage: {\n\t\t\t\t\t\t\t\t\t\t\ttype: \"string\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t},\n\tasync (ctx) => {\n\t\tif (!ctx.context.options.user?.changeEmail?.enabled) {\n\t\t\tctx.context.logger.error(\"Change email is disabled.\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Change email is disabled\",\n\t\t\t});\n\t\t}\n\n\t\tconst newEmail = ctx.body.newEmail.toLowerCase();\n\n\t\tif (newEmail === ctx.context.session.user.email) {\n\t\t\tctx.context.logger.error(\"Email is the same\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Email is the same\",\n\t\t\t});\n\t\t}\n\t\tconst existingUser =\n\t\t\tawait ctx.context.internalAdapter.findUserByEmail(newEmail);\n\t\tif (existingUser) {\n\t\t\tctx.context.logger.error(\"Email already exists\");\n\t\t\tthrow new APIError(\"UNPROCESSABLE_ENTITY\", {\n\t\t\t\tmessage: BASE_ERROR_CODES.USER_ALREADY_EXISTS_USE_ANOTHER_EMAIL,\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * If the email is not verified, we can update the email if the option is enabled\n\t\t */\n\t\tif (\n\t\t\tctx.context.session.user.emailVerified !== true &&\n\t\t\tctx.context.options.user.changeEmail.updateEmailWithoutVerification\n\t\t) {\n\t\t\tawait ctx.context.internalAdapter.updateUserByEmail(\n\t\t\t\tctx.context.session.user.email,\n\t\t\t\t{\n\t\t\t\t\temail: newEmail,\n\t\t\t\t},\n\t\t\t);\n\t\t\tawait setSessionCookie(ctx, {\n\t\t\t\tsession: ctx.context.session.session,\n\t\t\t\tuser: {\n\t\t\t\t\t...ctx.context.session.user,\n\t\t\t\t\temail: newEmail,\n\t\t\t\t},\n\t\t\t});\n\t\t\tif (ctx.context.options.emailVerification?.sendVerificationEmail) {\n\t\t\t\tconst token = await createEmailVerificationToken(\n\t\t\t\t\tctx.context.secret,\n\t\t\t\t\tnewEmail,\n\t\t\t\t\tundefined,\n\t\t\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t\t);\n\t\t\t\tconst url = `${\n\t\t\t\t\tctx.context.baseURL\n\t\t\t\t}/verify-email?token=${token}&callbackURL=${\n\t\t\t\t\tctx.body.callbackURL || \"/\"\n\t\t\t\t}`;\n\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t...ctx.context.session.user,\n\t\t\t\t\t\t\t\temail: newEmail,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\ttoken,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tctx.request,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * If the email is verified, we need to send a verification email\n\t\t */\n\t\tconst sendConfirmationToOldEmail =\n\t\t\tctx.context.session.user.emailVerified &&\n\t\t\t(ctx.context.options.user.changeEmail.sendChangeEmailConfirmation ||\n\t\t\t\tctx.context.options.user.changeEmail.sendChangeEmailVerification);\n\n\t\tif (sendConfirmationToOldEmail) {\n\t\t\tconst token = await createEmailVerificationToken(\n\t\t\t\tctx.context.secret,\n\t\t\t\tctx.context.session.user.email,\n\t\t\t\tnewEmail,\n\t\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t\t{\n\t\t\t\t\trequestType: \"change-email-confirmation\",\n\t\t\t\t},\n\t\t\t);\n\t\t\tconst url = `${\n\t\t\t\tctx.context.baseURL\n\t\t\t}/verify-email?token=${token}&callbackURL=${ctx.body.callbackURL || \"/\"}`;\n\t\t\tconst sendFn =\n\t\t\t\tctx.context.options.user.changeEmail.sendChangeEmailConfirmation ||\n\t\t\t\tctx.context.options.user.changeEmail.sendChangeEmailVerification;\n\t\t\tif (sendFn) {\n\t\t\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\t\t\tsendFn(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tuser: ctx.context.session.user,\n\t\t\t\t\t\t\tnewEmail: newEmail,\n\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\ttoken,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tctx.request,\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t}\n\t\t\treturn ctx.json({\n\t\t\t\tstatus: true,\n\t\t\t});\n\t\t}\n\n\t\tif (!ctx.context.options.emailVerification?.sendVerificationEmail) {\n\t\t\tctx.context.logger.error(\"Verification email isn't enabled.\");\n\t\t\tthrow new APIError(\"BAD_REQUEST\", {\n\t\t\t\tmessage: \"Verification email isn't enabled\",\n\t\t\t});\n\t\t}\n\n\t\tconst token = await createEmailVerificationToken(\n\t\t\tctx.context.secret,\n\t\t\tctx.context.session.user.email,\n\t\t\tnewEmail,\n\t\t\tctx.context.options.emailVerification?.expiresIn,\n\t\t\t{\n\t\t\t\trequestType: \"change-email-verification\",\n\t\t\t},\n\t\t);\n\t\tconst url = `${\n\t\t\tctx.context.baseURL\n\t\t}/verify-email?token=${token}&callbackURL=${ctx.body.callbackURL || \"/\"}`;\n\t\tawait ctx.context.runInBackgroundOrAwait(\n\t\t\tctx.context.options.emailVerification.sendVerificationEmail(\n\t\t\t\t{\n\t\t\t\t\tuser: {\n\t\t\t\t\t\t...ctx.context.session.user,\n\t\t\t\t\t\temail: newEmail,\n\t\t\t\t\t},\n\t\t\t\t\turl,\n\t\t\t\t\ttoken,\n\t\t\t\t},\n\t\t\t\tctx.request,\n\t\t\t),\n\t\t);\n\t\treturn ctx.json({\n\t\t\tstatus: true,\n\t\t});\n\t},\n);\n"],"names":["account","token","url"],"mappings":"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"}},
    {"offset": {"line": 4450, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/dist/api/routes/index.mjs"],"sourcesContent":["import { freshSessionMiddleware, getSession, getSessionFromCtx, listSessions, requestOnlySessionMiddleware, revokeOtherSessions, revokeSession, revokeSessions, sensitiveSessionMiddleware, sessionMiddleware } from \"./session.mjs\";\nimport { accountInfo, getAccessToken, linkSocialAccount, listUserAccounts, refreshToken, unlinkAccount } from \"./account.mjs\";\nimport { callbackOAuth } from \"./callback.mjs\";\nimport { createEmailVerificationToken, sendVerificationEmail, sendVerificationEmailFn, verifyEmail } from \"./email-verification.mjs\";\nimport { error } from \"./error.mjs\";\nimport { ok } from \"./ok.mjs\";\nimport { requestPasswordReset, requestPasswordResetCallback, resetPassword, verifyPassword } from \"./password.mjs\";\nimport { signInEmail, signInSocial } from \"./sign-in.mjs\";\nimport { signOut } from \"./sign-out.mjs\";\nimport { signUpEmail } from \"./sign-up.mjs\";\nimport { changeEmail, changePassword, deleteUser, deleteUserCallback, setPassword, updateUser } from \"./update-user.mjs\";\n\nexport {  };"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","ignoreList":[0]}},
    {"offset": {"line": 4478, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/to-auth-endpoints.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/to-auth-endpoints.ts"],"sourcesContent":["import type { AuthContext, HookEndpointContext } from \"@better-auth/core\";\nimport type { AuthEndpoint, AuthMiddleware } from \"@better-auth/core/api\";\nimport {\n\thasRequestState,\n\trunWithEndpointContext,\n\trunWithRequestState,\n} from \"@better-auth/core/context\";\nimport { shouldPublishLog } from \"@better-auth/core/env\";\nimport type {\n\tEndpointContext,\n\tEndpointOptions,\n\tInputContext,\n} from \"better-call\";\nimport { APIError, toResponse } from \"better-call\";\nimport { createDefu } from \"defu\";\n\ntype InternalContext = Partial<\n\tInputContext<string, any> & EndpointContext<string, any>\n> & {\n\tpath: string;\n\tasResponse?: boolean | undefined;\n\tcontext: AuthContext & {\n\t\tlogger: AuthContext[\"logger\"];\n\t\treturned?: unknown | undefined;\n\t\tresponseHeaders?: Headers | undefined;\n\t};\n};\n\nconst defuReplaceArrays = createDefu((obj, key, value) => {\n\tif (Array.isArray(obj[key]) && Array.isArray(value)) {\n\t\tobj[key] = value;\n\t\treturn true;\n\t}\n});\n\nconst hooksSourceWeakMap = new WeakMap<\n\tAuthMiddleware,\n\t`user` | `plugin:${string}`\n>();\n\ntype UserInputContext = Partial<\n\tInputContext<string, any> & EndpointContext<string, any>\n>;\n\nexport function toAuthEndpoints<\n\tconst E extends Record<\n\t\tstring,\n\t\tOmit<AuthEndpoint<string, EndpointOptions, any>, \"wrap\">\n\t>,\n>(endpoints: E, ctx: AuthContext | Promise<AuthContext>): E {\n\tconst api: Record<\n\t\tstring,\n\t\t((\n\t\t\tcontext: EndpointContext<string, any> & InputContext<string, any>,\n\t\t) => Promise<any>) & {\n\t\t\tpath?: string | undefined;\n\t\t\toptions?: EndpointOptions | undefined;\n\t\t}\n\t> = {};\n\n\tfor (const [key, endpoint] of Object.entries(endpoints)) {\n\t\tapi[key] = async (context?: UserInputContext) => {\n\t\t\tconst run = async () => {\n\t\t\t\tconst authContext = await ctx;\n\t\t\t\tlet internalContext: InternalContext = {\n\t\t\t\t\t...context,\n\t\t\t\t\tcontext: {\n\t\t\t\t\t\t...authContext,\n\t\t\t\t\t\treturned: undefined,\n\t\t\t\t\t\tresponseHeaders: undefined,\n\t\t\t\t\t\tsession: null,\n\t\t\t\t\t},\n\t\t\t\t\tpath: endpoint.path,\n\t\t\t\t\theaders: context?.headers ? new Headers(context?.headers) : undefined,\n\t\t\t\t};\n\t\t\t\treturn runWithEndpointContext(internalContext, async () => {\n\t\t\t\t\tconst { beforeHooks, afterHooks } = getHooks(authContext);\n\t\t\t\t\tconst before = await runBeforeHooks(internalContext, beforeHooks);\n\t\t\t\t\t/**\n\t\t\t\t\t * If `before.context` is returned, it should\n\t\t\t\t\t * get merged with the original context\n\t\t\t\t\t */\n\t\t\t\t\tif (\n\t\t\t\t\t\t\"context\" in before &&\n\t\t\t\t\t\tbefore.context &&\n\t\t\t\t\t\ttypeof before.context === \"object\"\n\t\t\t\t\t) {\n\t\t\t\t\t\tconst { headers, ...rest } = before.context as {\n\t\t\t\t\t\t\theaders: Headers;\n\t\t\t\t\t\t};\n\t\t\t\t\t\t/**\n\t\t\t\t\t\t * Headers should be merged differently\n\t\t\t\t\t\t * so the hook doesn't override the whole\n\t\t\t\t\t\t * header\n\t\t\t\t\t\t */\n\t\t\t\t\t\tif (headers) {\n\t\t\t\t\t\t\theaders.forEach((value, key) => {\n\t\t\t\t\t\t\t\t(internalContext.headers as Headers).set(key, value);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tinternalContext = defuReplaceArrays(rest, internalContext);\n\t\t\t\t\t} else if (before) {\n\t\t\t\t\t\t/* Return before hook response if it's anything other than a context return */\n\t\t\t\t\t\treturn context?.asResponse\n\t\t\t\t\t\t\t? toResponse(before, {\n\t\t\t\t\t\t\t\t\theaders: context?.headers,\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t: context?.returnHeaders\n\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\theaders: context?.headers,\n\t\t\t\t\t\t\t\t\t\tresponse: before,\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t: before;\n\t\t\t\t\t}\n\n\t\t\t\t\tinternalContext.asResponse = false;\n\t\t\t\t\tinternalContext.returnHeaders = true;\n\t\t\t\t\tinternalContext.returnStatus = true;\n\t\t\t\t\tconst result = (await runWithEndpointContext(internalContext, () =>\n\t\t\t\t\t\t(endpoint as any)(internalContext as any),\n\t\t\t\t\t).catch((e: any) => {\n\t\t\t\t\t\tif (e instanceof APIError) {\n\t\t\t\t\t\t\t/**\n\t\t\t\t\t\t\t * API Errors from response are caught\n\t\t\t\t\t\t\t * and returned to hooks\n\t\t\t\t\t\t\t */\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tresponse: e,\n\t\t\t\t\t\t\t\tstatus: e.statusCode,\n\t\t\t\t\t\t\t\theaders: e.headers ? new Headers(e.headers) : null,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthrow e;\n\t\t\t\t\t})) as {\n\t\t\t\t\t\theaders: Headers;\n\t\t\t\t\t\tresponse: any;\n\t\t\t\t\t\tstatus: number;\n\t\t\t\t\t};\n\n\t\t\t\t\t//if response object is returned we skip after hooks and post processing\n\t\t\t\t\tif (result && result instanceof Response) {\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t}\n\n\t\t\t\t\tinternalContext.context.returned = result.response;\n\t\t\t\t\tinternalContext.context.responseHeaders = result.headers;\n\n\t\t\t\t\tconst after = await runAfterHooks(internalContext, afterHooks);\n\n\t\t\t\t\tif (after.response) {\n\t\t\t\t\t\tresult.response = after.response;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tresult.response instanceof APIError &&\n\t\t\t\t\t\tshouldPublishLog(authContext.logger.level, \"debug\")\n\t\t\t\t\t) {\n\t\t\t\t\t\t// inherit stack from errorStack if debug mode is enabled\n\t\t\t\t\t\tresult.response.stack = result.response.errorStack;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result.response instanceof APIError && !context?.asResponse) {\n\t\t\t\t\t\tthrow result.response;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst response = context?.asResponse\n\t\t\t\t\t\t? toResponse(result.response, {\n\t\t\t\t\t\t\t\theaders: result.headers,\n\t\t\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t: context?.returnHeaders\n\t\t\t\t\t\t\t? context?.returnStatus\n\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\theaders: result.headers,\n\t\t\t\t\t\t\t\t\t\tresponse: result.response,\n\t\t\t\t\t\t\t\t\t\tstatus: result.status,\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\t\t\theaders: result.headers,\n\t\t\t\t\t\t\t\t\t\tresponse: result.response,\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t: context?.returnStatus\n\t\t\t\t\t\t\t\t? { response: result.response, status: result.status }\n\t\t\t\t\t\t\t\t: result.response;\n\t\t\t\t\treturn response;\n\t\t\t\t});\n\t\t\t};\n\t\t\tif (await hasRequestState()) {\n\t\t\t\treturn run();\n\t\t\t} else {\n\t\t\t\tconst store = new WeakMap();\n\t\t\t\treturn runWithRequestState(store, run);\n\t\t\t}\n\t\t};\n\t\tapi[key].path = endpoint.path;\n\t\tapi[key].options = endpoint.options;\n\t}\n\treturn api as unknown as E;\n}\n\nasync function runBeforeHooks(\n\tcontext: InternalContext,\n\thooks: {\n\t\tmatcher: (context: HookEndpointContext) => boolean;\n\t\thandler: AuthMiddleware;\n\t}[],\n) {\n\tlet modifiedContext: Partial<InternalContext> = {};\n\n\tfor (const hook of hooks) {\n\t\tlet matched = false;\n\t\ttry {\n\t\t\tmatched = hook.matcher(context);\n\t\t} catch (error) {\n\t\t\t// manually handle unexpected errors during hook matcher execution to prevent accidental exposure of internal details\n\t\t\t// Also provides debug information about which plugin the hook failed and error info\n\t\t\tconst hookSource = hooksSourceWeakMap.get(hook.handler) ?? \"unknown\";\n\t\t\tcontext.context.logger.error(\n\t\t\t\t`An error occurred during ${hookSource} hook matcher execution:`,\n\t\t\t\terror,\n\t\t\t);\n\t\t\tthrow new APIError(\"INTERNAL_SERVER_ERROR\", {\n\t\t\t\tmessage: `An error occurred during hook matcher execution. Check the logs for more details.`,\n\t\t\t});\n\t\t}\n\t\tif (matched) {\n\t\t\tconst result = await hook\n\t\t\t\t.handler({\n\t\t\t\t\t...context,\n\t\t\t\t\treturnHeaders: false,\n\t\t\t\t})\n\t\t\t\t.catch((e: unknown) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\te instanceof APIError &&\n\t\t\t\t\t\tshouldPublishLog(context.context.logger.level, \"debug\")\n\t\t\t\t\t) {\n\t\t\t\t\t\t// inherit stack from errorStack if debug mode is enabled\n\t\t\t\t\t\te.stack = e.errorStack;\n\t\t\t\t\t}\n\t\t\t\t\tthrow e;\n\t\t\t\t});\n\t\t\tif (result && typeof result === \"object\") {\n\t\t\t\tif (\"context\" in result && typeof result.context === \"object\") {\n\t\t\t\t\tconst { headers, ...rest } =\n\t\t\t\t\t\tresult.context as Partial<InternalContext>;\n\t\t\t\t\tif (headers instanceof Headers) {\n\t\t\t\t\t\tif (modifiedContext.headers) {\n\t\t\t\t\t\t\theaders.forEach((value, key) => {\n\t\t\t\t\t\t\t\tmodifiedContext.headers?.set(key, value);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tmodifiedContext.headers = headers;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmodifiedContext = defuReplaceArrays(rest, modifiedContext);\n\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t}\n\treturn { context: modifiedContext };\n}\n\nasync function runAfterHooks(\n\tcontext: InternalContext,\n\thooks: {\n\t\tmatcher: (context: HookEndpointContext) => boolean;\n\t\thandler: AuthMiddleware;\n\t}[],\n) {\n\tfor (const hook of hooks) {\n\t\tif (hook.matcher(context)) {\n\t\t\tconst result = (await hook.handler(context).catch((e) => {\n\t\t\t\tif (e instanceof APIError) {\n\t\t\t\t\tif (shouldPublishLog(context.context.logger.level, \"debug\")) {\n\t\t\t\t\t\t// inherit stack from errorStack if debug mode is enabled\n\t\t\t\t\t\te.stack = e.errorStack;\n\t\t\t\t\t}\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresponse: e,\n\t\t\t\t\t\theaders: e.headers ? new Headers(e.headers) : null,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tthrow e;\n\t\t\t})) as {\n\t\t\t\tresponse: any;\n\t\t\t\theaders: Headers;\n\t\t\t};\n\t\t\tif (result.headers) {\n\t\t\t\tresult.headers.forEach((value, key) => {\n\t\t\t\t\tif (!context.context.responseHeaders) {\n\t\t\t\t\t\tcontext.context.responseHeaders = new Headers({\n\t\t\t\t\t\t\t[key]: value,\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (key.toLowerCase() === \"set-cookie\") {\n\t\t\t\t\t\t\tcontext.context.responseHeaders.append(key, value);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcontext.context.responseHeaders.set(key, value);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (result.response) {\n\t\t\t\tcontext.context.returned = result.response;\n\t\t\t}\n\t\t}\n\t}\n\treturn {\n\t\tresponse: context.context.returned,\n\t\theaders: context.context.responseHeaders,\n\t};\n}\n\nfunction getHooks(authContext: AuthContext) {\n\tconst plugins = authContext.options.plugins || [];\n\tconst beforeHooks: {\n\t\tmatcher: (context: HookEndpointContext) => boolean;\n\t\thandler: AuthMiddleware;\n\t}[] = [];\n\tconst afterHooks: {\n\t\tmatcher: (context: HookEndpointContext) => boolean;\n\t\thandler: AuthMiddleware;\n\t}[] = [];\n\tconst beforeHookHandler = authContext.options.hooks?.before;\n\tif (beforeHookHandler) {\n\t\thooksSourceWeakMap.set(beforeHookHandler, \"user\");\n\t\tbeforeHooks.push({\n\t\t\tmatcher: () => true,\n\t\t\thandler: beforeHookHandler,\n\t\t});\n\t}\n\tconst afterHookHandler = authContext.options.hooks?.after;\n\tif (afterHookHandler) {\n\t\thooksSourceWeakMap.set(afterHookHandler, \"user\");\n\t\tafterHooks.push({\n\t\t\tmatcher: () => true,\n\t\t\thandler: afterHookHandler,\n\t\t});\n\t}\n\tconst pluginBeforeHooks = plugins\n\t\t.filter((plugin) => plugin.hooks?.before)\n\t\t.map((plugin) => plugin.hooks?.before!)\n\t\t.flat();\n\tconst pluginAfterHooks = plugins\n\t\t.filter((plugin) => plugin.hooks?.after)\n\t\t.map((plugin) => plugin.hooks?.after!)\n\t\t.flat();\n\n\t/**\n\t * Add plugin added hooks at last\n\t */\n\tif (pluginBeforeHooks.length) beforeHooks.push(...pluginBeforeHooks);\n\tif (pluginAfterHooks.length) afterHooks.push(...pluginAfterHooks);\n\n\treturn {\n\t\tbeforeHooks,\n\t\tafterHooks,\n\t};\n}\n"],"names":["api: Record<\n\t\tstring,\n\t\t((\n\t\t\tcontext: EndpointContext<string, any> & InputContext<string, any>,\n\t\t) => Promise<any>) & {\n\t\t\tpath?: string | undefined;\n\t\t\toptions?: EndpointOptions | undefined;\n\t\t}\n\t>","internalContext: InternalContext","key","modifiedContext: Partial<InternalContext>","beforeHooks: {\n\t\tmatcher: (context: HookEndpointContext) => boolean;\n\t\thandler: AuthMiddleware;\n\t}[]","afterHooks: {\n\t\tmatcher: (context: HookEndpointContext) => boolean;\n\t\thandler: AuthMiddleware;\n\t}[]"],"mappings":"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"}},
    {"offset": {"line": 4689, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/node_modules/better-auth/dist/api/index.mjs","sources":["file:///Users/ivanmuccini/Desktop/chatapp/chat/node_modules/better-auth/src/api/index.ts"],"sourcesContent":["import type {\n\tAuthContext,\n\tAwaitable,\n\tBetterAuthOptions,\n\tBetterAuthPlugin,\n} from \"@better-auth/core\";\nimport type { InternalLogger } from \"@better-auth/core/env\";\nimport { logger } from \"@better-auth/core/env\";\nimport { normalizePathname } from \"@better-auth/core/utils\";\nimport type { Endpoint, Middleware } from \"better-call\";\nimport { APIError, createRouter } from \"better-call\";\nimport type { UnionToIntersection } from \"../types/helper\";\nimport { originCheckMiddleware } from \"./middlewares\";\nimport { onRequestRateLimit } from \"./rate-limiter\";\nimport {\n\taccountInfo,\n\tcallbackOAuth,\n\tchangeEmail,\n\tchangePassword,\n\tdeleteUser,\n\tdeleteUserCallback,\n\terror,\n\tgetAccessToken,\n\tgetSession,\n\tlinkSocialAccount,\n\tlistSessions,\n\tlistUserAccounts,\n\tok,\n\trefreshToken,\n\trequestPasswordReset,\n\trequestPasswordResetCallback,\n\tresetPassword,\n\trevokeOtherSessions,\n\trevokeSession,\n\trevokeSessions,\n\tsendVerificationEmail,\n\tsetPassword,\n\tsignInEmail,\n\tsignInSocial,\n\tsignOut,\n\tsignUpEmail,\n\tunlinkAccount,\n\tupdateUser,\n\tverifyEmail,\n\tverifyPassword,\n} from \"./routes\";\nimport { toAuthEndpoints } from \"./to-auth-endpoints\";\n\nexport function checkEndpointConflicts(\n\toptions: BetterAuthOptions,\n\tlogger: InternalLogger,\n) {\n\tconst endpointRegistry = new Map<\n\t\tstring,\n\t\t{ pluginId: string; endpointKey: string; methods: string[] }[]\n\t>();\n\n\toptions.plugins?.forEach((plugin) => {\n\t\tif (plugin.endpoints) {\n\t\t\tfor (const [key, endpoint] of Object.entries(plugin.endpoints)) {\n\t\t\t\tif (\n\t\t\t\t\tendpoint &&\n\t\t\t\t\t\"path\" in endpoint &&\n\t\t\t\t\ttypeof endpoint.path === \"string\"\n\t\t\t\t) {\n\t\t\t\t\tconst path = endpoint.path;\n\t\t\t\t\tlet methods: string[] = [];\n\t\t\t\t\tif (endpoint.options && \"method\" in endpoint.options) {\n\t\t\t\t\t\tif (Array.isArray(endpoint.options.method)) {\n\t\t\t\t\t\t\tmethods = endpoint.options.method;\n\t\t\t\t\t\t} else if (typeof endpoint.options.method === \"string\") {\n\t\t\t\t\t\t\tmethods = [endpoint.options.method];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (methods.length === 0) {\n\t\t\t\t\t\tmethods = [\"*\"];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!endpointRegistry.has(path)) {\n\t\t\t\t\t\tendpointRegistry.set(path, []);\n\t\t\t\t\t}\n\t\t\t\t\tendpointRegistry.get(path)!.push({\n\t\t\t\t\t\tpluginId: plugin.id,\n\t\t\t\t\t\tendpointKey: key,\n\t\t\t\t\t\tmethods,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n\n\tconst conflicts: {\n\t\tpath: string;\n\t\tplugins: string[];\n\t\tconflictingMethods: string[];\n\t}[] = [];\n\tfor (const [path, entries] of endpointRegistry.entries()) {\n\t\tif (entries.length > 1) {\n\t\t\tconst methodMap = new Map<string, string[]>();\n\t\t\tlet hasConflict = false;\n\n\t\t\tfor (const entry of entries) {\n\t\t\t\tfor (const method of entry.methods) {\n\t\t\t\t\tif (!methodMap.has(method)) {\n\t\t\t\t\t\tmethodMap.set(method, []);\n\t\t\t\t\t}\n\t\t\t\t\tmethodMap.get(method)!.push(entry.pluginId);\n\n\t\t\t\t\tif (methodMap.get(method)!.length > 1) {\n\t\t\t\t\t\thasConflict = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (method === \"*\" && entries.length > 1) {\n\t\t\t\t\t\thasConflict = true;\n\t\t\t\t\t} else if (method !== \"*\" && methodMap.has(\"*\")) {\n\t\t\t\t\t\thasConflict = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (hasConflict) {\n\t\t\t\tconst uniquePlugins = [...new Set(entries.map((e) => e.pluginId))];\n\t\t\t\tconst conflictingMethods: string[] = [];\n\n\t\t\t\tfor (const [method, plugins] of methodMap.entries()) {\n\t\t\t\t\tif (\n\t\t\t\t\t\tplugins.length > 1 ||\n\t\t\t\t\t\t(method === \"*\" && entries.length > 1) ||\n\t\t\t\t\t\t(method !== \"*\" && methodMap.has(\"*\"))\n\t\t\t\t\t) {\n\t\t\t\t\t\tconflictingMethods.push(method);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconflicts.push({\n\t\t\t\t\tpath,\n\t\t\t\t\tplugins: uniquePlugins,\n\t\t\t\t\tconflictingMethods,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tif (conflicts.length > 0) {\n\t\tconst conflictMessages = conflicts\n\t\t\t.map(\n\t\t\t\t(conflict) =>\n\t\t\t\t\t`  - \"${conflict.path}\" [${conflict.conflictingMethods.join(\", \")}] used by plugins: ${conflict.plugins.join(\", \")}`,\n\t\t\t)\n\t\t\t.join(\"\\n\");\n\t\tlogger.error(\n\t\t\t`Endpoint path conflicts detected! Multiple plugins are trying to use the same endpoint paths with conflicting HTTP methods:\n${conflictMessages}\n\nTo resolve this, you can:\n\t1. Use only one of the conflicting plugins\n\t2. Configure the plugins to use different paths (if supported)\n\t3. Ensure plugins use different HTTP methods for the same path\n`,\n\t\t);\n\t}\n}\n\nexport function getEndpoints<Option extends BetterAuthOptions>(\n\tctx: Awaitable<AuthContext>,\n\toptions: Option,\n) {\n\tconst pluginEndpoints =\n\t\toptions.plugins?.reduce<Record<string, Endpoint>>((acc, plugin) => {\n\t\t\treturn {\n\t\t\t\t...acc,\n\t\t\t\t...plugin.endpoints,\n\t\t\t};\n\t\t}, {}) ?? {};\n\n\ttype PluginEndpoint = UnionToIntersection<\n\t\tOption[\"plugins\"] extends Array<infer T>\n\t\t\t? T extends BetterAuthPlugin\n\t\t\t\t? T extends {\n\t\t\t\t\t\tendpoints: infer E;\n\t\t\t\t\t}\n\t\t\t\t\t? E\n\t\t\t\t\t: {}\n\t\t\t\t: {}\n\t\t\t: {}\n\t>;\n\n\tconst middlewares =\n\t\toptions.plugins\n\t\t\t?.map((plugin) =>\n\t\t\t\tplugin.middlewares?.map((m) => {\n\t\t\t\t\tconst middleware = (async (context: any) => {\n\t\t\t\t\t\tconst authContext = await ctx;\n\t\t\t\t\t\treturn m.middleware({\n\t\t\t\t\t\t\t...context,\n\t\t\t\t\t\t\tcontext: {\n\t\t\t\t\t\t\t\t...authContext,\n\t\t\t\t\t\t\t\t...context.context,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}) as Middleware;\n\t\t\t\t\tmiddleware.options = m.middleware.options;\n\t\t\t\t\treturn {\n\t\t\t\t\t\tpath: m.path,\n\t\t\t\t\t\tmiddleware,\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.filter((plugin) => plugin !== undefined)\n\t\t\t.flat() || [];\n\n\tconst baseEndpoints = {\n\t\tsignInSocial: signInSocial<Option>(),\n\t\tcallbackOAuth,\n\t\tgetSession: getSession<Option>(),\n\t\tsignOut,\n\t\tsignUpEmail: signUpEmail<Option>(),\n\t\tsignInEmail: signInEmail<Option>(),\n\t\tresetPassword,\n\t\tverifyPassword,\n\t\tverifyEmail,\n\t\tsendVerificationEmail,\n\t\tchangeEmail,\n\t\tchangePassword,\n\t\tsetPassword,\n\t\tupdateUser: updateUser<Option>(),\n\t\tdeleteUser,\n\t\trequestPasswordReset,\n\t\trequestPasswordResetCallback,\n\t\tlistSessions: listSessions<Option>(),\n\t\trevokeSession,\n\t\trevokeSessions,\n\t\trevokeOtherSessions,\n\t\tlinkSocialAccount,\n\t\tlistUserAccounts,\n\t\tdeleteUserCallback,\n\t\tunlinkAccount,\n\t\trefreshToken,\n\t\tgetAccessToken,\n\t\taccountInfo,\n\t};\n\tconst endpoints = {\n\t\t...baseEndpoints,\n\t\t...pluginEndpoints,\n\t\tok,\n\t\terror,\n\t} as const;\n\tconst api = toAuthEndpoints(endpoints, ctx);\n\treturn {\n\t\tapi: api as typeof endpoints & PluginEndpoint,\n\t\tmiddlewares,\n\t};\n}\nexport const router = <Option extends BetterAuthOptions>(\n\tctx: AuthContext,\n\toptions: Option,\n) => {\n\tconst { api, middlewares } = getEndpoints(ctx, options);\n\tconst basePath = new URL(ctx.baseURL).pathname;\n\n\treturn createRouter(api, {\n\t\trouterContext: ctx,\n\t\topenapi: {\n\t\t\tdisabled: true,\n\t\t},\n\t\tbasePath,\n\t\trouterMiddleware: [\n\t\t\t{\n\t\t\t\tpath: \"/**\",\n\t\t\t\tmiddleware: originCheckMiddleware,\n\t\t\t},\n\t\t\t...middlewares,\n\t\t],\n\t\tallowedMediaTypes: [\"application/json\"],\n\t\tskipTrailingSlashes: options.advanced?.skipTrailingSlashes ?? false,\n\t\tasync onRequest(req) {\n\t\t\t//handle disabled paths\n\t\t\tconst disabledPaths = ctx.options.disabledPaths || [];\n\t\t\tconst normalizedPath = normalizePathname(req.url, basePath);\n\t\t\tif (disabledPaths.includes(normalizedPath)) {\n\t\t\t\treturn new Response(\"Not Found\", { status: 404 });\n\t\t\t}\n\n\t\t\tlet currentRequest = req;\n\t\t\tfor (const plugin of ctx.options.plugins || []) {\n\t\t\t\tif (plugin.onRequest) {\n\t\t\t\t\tconst response = await plugin.onRequest(currentRequest, ctx);\n\t\t\t\t\tif (response && \"response\" in response) {\n\t\t\t\t\t\treturn response.response;\n\t\t\t\t\t}\n\t\t\t\t\tif (response && \"request\" in response) {\n\t\t\t\t\t\tcurrentRequest = response.request;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst rateLimitResponse = await onRequestRateLimit(currentRequest, ctx);\n\t\t\tif (rateLimitResponse) {\n\t\t\t\treturn rateLimitResponse;\n\t\t\t}\n\n\t\t\treturn currentRequest;\n\t\t},\n\t\tasync onResponse(res) {\n\t\t\tfor (const plugin of ctx.options.plugins || []) {\n\t\t\t\tif (plugin.onResponse) {\n\t\t\t\t\tconst response = await plugin.onResponse(res, ctx);\n\t\t\t\t\tif (response) {\n\t\t\t\t\t\treturn response.response;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn res;\n\t\t},\n\t\tonError(e) {\n\t\t\tif (e instanceof APIError && e.status === \"FOUND\") {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (options.onAPIError?.throw) {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t\tif (options.onAPIError?.onError) {\n\t\t\t\toptions.onAPIError.onError(e, ctx);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst optLogLevel = options.logger?.level;\n\t\t\tconst log =\n\t\t\t\toptLogLevel === \"error\" ||\n\t\t\t\toptLogLevel === \"warn\" ||\n\t\t\t\toptLogLevel === \"debug\"\n\t\t\t\t\t? logger\n\t\t\t\t\t: undefined;\n\t\t\tif (options.logger?.disabled !== true) {\n\t\t\t\tif (\n\t\t\t\t\te &&\n\t\t\t\t\ttypeof e === \"object\" &&\n\t\t\t\t\t\"message\" in e &&\n\t\t\t\t\ttypeof e.message === \"string\"\n\t\t\t\t) {\n\t\t\t\t\tif (\n\t\t\t\t\t\te.message.includes(\"no column\") ||\n\t\t\t\t\t\te.message.includes(\"column\") ||\n\t\t\t\t\t\te.message.includes(\"relation\") ||\n\t\t\t\t\t\te.message.includes(\"table\") ||\n\t\t\t\t\t\te.message.includes(\"does not exist\")\n\t\t\t\t\t) {\n\t\t\t\t\t\tctx.logger?.error(e.message);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (e instanceof APIError) {\n\t\t\t\t\tif (e.status === \"INTERNAL_SERVER_ERROR\") {\n\t\t\t\t\t\tctx.logger.error(e.status, e);\n\t\t\t\t\t}\n\t\t\t\t\tlog?.error(e.message);\n\t\t\t\t} else {\n\t\t\t\t\tctx.logger?.error(\n\t\t\t\t\t\te && typeof e === \"object\" && \"name\" in e ? (e.name as string) : \"\",\n\t\t\t\t\t\te,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t});\n};\n\nexport {\n\ttype AuthEndpoint,\n\ttype AuthMiddleware,\n\tcreateAuthEndpoint,\n\tcreateAuthMiddleware,\n\toptionsMiddleware,\n} from \"@better-auth/core/api\";\nexport { APIError } from \"better-call\";\nexport { getIp } from \"../utils/get-request-ip\";\nexport * from \"./middlewares\";\nexport * from \"./routes\";\n"],"names":["methods: string[]","conflicts: {\n\t\tpath: string;\n\t\tplugins: string[];\n\t\tconflictingMethods: string[];\n\t}[]","conflictingMethods: string[]","APIError"],"mappings":"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"}}]
}