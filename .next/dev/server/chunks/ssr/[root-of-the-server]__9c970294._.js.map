{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 14, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n    prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,sMAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 27, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/services/tenantResolver.ts"],"sourcesContent":["import { cache } from 'react';\nimport { prisma } from '@/lib/db';\nimport { headers } from 'next/headers';\n\n/**\n * Resolves the Tenant ID (slug) based on:\n * 1. URL Parameter (nas_id)\n * 2. Request IP (VPN or Public)\n */\nexport const resolveTenant = cache(async (urlNasId?: string): Promise<string | null> => {\n    // 1. Priority: URL Parameter\n    if (urlNasId) {\n        const device = await prisma.nasDevice.findUnique({\n            where: { nasId: urlNasId },\n            include: { tenant: true }\n        });\n        if (device?.tenant?.slug) return device.tenant.slug;\n    }\n\n    // 2. Priority: Request IP\n    const headersList = await headers();\n    // Helper to get real IP (handles x-forwarded-for if behind proxy)\n    const forwardedFor = headersList.get('x-forwarded-for');\n    let remoteIp = forwardedFor ? forwardedFor.split(',')[0].trim() : null;\n\n    // Normalize IP: Remove IPv6 prefix for IPv4-mapped addresses (e.g. ::ffff:192.168.1.1)\n    if (remoteIp && remoteIp.startsWith('::ffff:')) {\n        remoteIp = remoteIp.replace('::ffff:', '');\n    }\n\n    // In dev, ip might be ::1 or 127.0.0.1, usually strictly ignored or mapped to localhost\n    if (!remoteIp) return null;\n\n    const deviceByIp = await prisma.nasDevice.findFirst({\n        where: {\n            OR: [\n                { vpnIp: remoteIp },\n                { publicIp: remoteIp }\n            ]\n        },\n        include: { tenant: true }\n    });\n\n    if (deviceByIp?.tenant?.slug) return deviceByIp.tenant.slug;\n\n    return null;\n});\n\n/**\n * Helper to check if a resolved tenant is valid and redirect/handle if not.\n * Can be used in layouts.\n */\nexport const getTenantOrNull = async (searchParams: { [key: string]: string | string[] | undefined }) => {\n    const nasId = typeof searchParams.nas_id === 'string' ? searchParams.nas_id : undefined;\n    const tenantSlug = await resolveTenant(nasId);\n    return tenantSlug;\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAOO,MAAM,gBAAgB,IAAA,8MAAK,EAAC,OAAO;IACtC,6BAA6B;IAC7B,IAAI,UAAU;QACV,MAAM,SAAS,MAAM,mHAAM,CAAC,SAAS,CAAC,UAAU,CAAC;YAC7C,OAAO;gBAAE,OAAO;YAAS;YACzB,SAAS;gBAAE,QAAQ;YAAK;QAC5B;QACA,IAAI,QAAQ,QAAQ,MAAM,OAAO,OAAO,MAAM,CAAC,IAAI;IACvD;IAEA,0BAA0B;IAC1B,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,kEAAkE;IAClE,MAAM,eAAe,YAAY,GAAG,CAAC;IACrC,IAAI,WAAW,eAAe,aAAa,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,KAAK;IAElE,uFAAuF;IACvF,IAAI,YAAY,SAAS,UAAU,CAAC,YAAY;QAC5C,WAAW,SAAS,OAAO,CAAC,WAAW;IAC3C;IAEA,wFAAwF;IACxF,IAAI,CAAC,UAAU,OAAO;IAEtB,MAAM,aAAa,MAAM,mHAAM,CAAC,SAAS,CAAC,SAAS,CAAC;QAChD,OAAO;YACH,IAAI;gBACA;oBAAE,OAAO;gBAAS;gBAClB;oBAAE,UAAU;gBAAS;aACxB;QACL;QACA,SAAS;YAAE,QAAQ;QAAK;IAC5B;IAEA,IAAI,YAAY,QAAQ,MAAM,OAAO,WAAW,MAAM,CAAC,IAAI;IAE3D,OAAO;AACX;AAMO,MAAM,kBAAkB,OAAO;IAClC,MAAM,QAAQ,OAAO,aAAa,MAAM,KAAK,WAAW,aAAa,MAAM,GAAG;IAC9E,MAAM,aAAa,MAAM,cAAc;IACvC,OAAO;AACX"}},
    {"offset": {"line": 90, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/app/page.tsx"],"sourcesContent":["import { redirect } from \"next/navigation\";\nimport { resolveTenant } from \"@/services/tenantResolver\";\nimport { headers } from \"next/headers\";\n\ninterface PageProps {\n    searchParams: Promise<{ [key: string]: string | string[] | undefined }>\n}\n\nexport default async function Home(props: PageProps) {\n    // Await searchParams in Next.js 15+\n    const sp = await props.searchParams;\n    const nasId = typeof sp.nas_id === 'string' ? sp.nas_id : undefined;\n\n    // Resolve Tenant via URL (nas_id) or IP\n    const tenantSlug = await resolveTenant(nasId);\n\n    if (tenantSlug) {\n        // Valid Tenant found -> Redirect to Chat Interface\n        redirect(`/${tenantSlug}`);\n    }\n\n    // For debugging: Get IP explicitly to show users\n    const headersList = await headers();\n    const forwardedFor = headersList.get('x-forwarded-for');\n    const remoteIp = forwardedFor ? forwardedFor.split(',')[0].trim() : \"Direct/Unknown\";\n\n    // Fallback: No Tenant Identified\n    console.log('[TenantResolver] Failed to resolve tenant.', { nasId, remoteIp });\n\n    return (\n        <div className=\"h-screen w-full flex items-center justify-center bg-gray-100 p-4\">\n            <div className=\"text-center p-8 bg-white rounded-lg shadow-lg max-w-md\">\n                <h1 className=\"text-2xl font-bold text-red-500 mb-4\">Accesso Negato</h1>\n                <p className=\"text-gray-700\">Impossibile identificare lo spazio chat.</p>\n                <p className=\"text-gray-500 text-sm mt-2\">Assicurati di essere connesso al Wi-Fi corretto (es. Treno WiFi).</p>\n            </div>\n        </div>\n    );\n}\n"],"names":[],"mappings":";;;;;AAAA;AAAA;AACA;AACA;;;;;AAMe,eAAe,KAAK,KAAgB;IAC/C,oCAAoC;IACpC,MAAM,KAAK,MAAM,MAAM,YAAY;IACnC,MAAM,QAAQ,OAAO,GAAG,MAAM,KAAK,WAAW,GAAG,MAAM,GAAG;IAE1D,wCAAwC;IACxC,MAAM,aAAa,MAAM,IAAA,2IAAa,EAAC;IAEvC,IAAI,YAAY;QACZ,mDAAmD;QACnD,IAAA,iMAAQ,EAAC,CAAC,CAAC,EAAE,YAAY;IAC7B;IAEA,iDAAiD;IACjD,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,MAAM,eAAe,YAAY,GAAG,CAAC;IACrC,MAAM,WAAW,eAAe,aAAa,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,KAAK;IAEpE,iCAAiC;IACjC,QAAQ,GAAG,CAAC,8CAA8C;QAAE;QAAO;IAAS;IAE5E,qBACI,8OAAC;QAAI,WAAU;kBACX,cAAA,8OAAC;YAAI,WAAU;;8BACX,8OAAC;oBAAG,WAAU;8BAAuC;;;;;;8BACrD,8OAAC;oBAAE,WAAU;8BAAgB;;;;;;8BAC7B,8OAAC;oBAAE,WAAU;8BAA6B;;;;;;;;;;;;;;;;;AAI1D"}}]
}