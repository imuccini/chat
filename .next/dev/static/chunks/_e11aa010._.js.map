{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/app/actions/sendMessage.ts"],"sourcesContent":["'use server'\n\nimport { auth } from \"@/lib/auth\"; // Better-auth\nimport { createMessage } from \"@/services/messageService\";\nimport { headers } from \"next/headers\";\nimport { revalidatePath } from \"next/cache\";\n\nexport async function sendMessageAction(formData: FormData) {\n    // 1. Authentication Check\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session || !session.user) {\n        return { success: false, error: \"Unauthorized\" };\n    }\n\n    // 2. Extract Data\n    const content = formData.get(\"content\") as string;\n    const tenantId = formData.get(\"tenantId\") as string;\n\n    if (!content || !tenantId) {\n        return { success: false, error: \"Missing content or tenantId\" };\n    }\n\n    try {\n        // 3. Create Message (Service Pattern)\n        await createMessage(content, session.user.id, tenantId);\n\n        // 4. Revalidate UI\n        revalidatePath(`/chat/${tenantId}`); // Assume this is the path\n        return { success: true };\n\n    } catch (error) {\n        console.error(\"Failed to send message:\", error);\n        return { success: false, error: \"Failed to send message\" };\n    }\n}\n"],"names":[],"mappings":";;;;;;;MAOsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,qDAAA"}},
    {"offset": {"line": 21, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/config.ts"],"sourcesContent":["import { Capacitor } from '@capacitor/core';\n\n// Detect if running natively (iOS or Android)\nconst isNative = Capacitor.isNativePlatform();\n\n// Use local IP for native (simulator/device) or empty string for web (proxy)\n// REPLACE '192.168.8.213' WITH YOUR COMPUTER'S LOCAL IP IF IT CHANGES\nexport const API_BASE_URL = isNative ? 'http://192.168.8.213:3000' : '';\n"],"names":[],"mappings":";;;;AAAA;;AAEA,8CAA8C;AAC9C,MAAM,WAAW,oKAAS,CAAC,gBAAgB;AAIpC,MAAM,eAAe,WAAW,8BAA8B"}},
    {"offset": {"line": 37, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/components/ChatInterface.tsx"],"sourcesContent":["'use client'\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport { io, Socket } from 'socket.io-client';\nimport { Tenant } from '@prisma/client';\nimport { User, Message } from '@/types';\nimport { sendMessageAction } from '@/app/actions/sendMessage';\nimport { API_BASE_URL } from '@/config';\n\n// Re-using parts of the original GlobalChat UI\n// Since we don't have the full original GlobalChat imports here, \n// I will implement a simplified version that renders the messages and input.\n\ninterface ChatInterfaceProps {\n    tenant: Tenant;\n    initialMessages: Message[];\n}\n\nexport default function ChatInterface({ tenant, initialMessages }: ChatInterfaceProps) {\n    const [messages, setMessages] = useState<Message[]>(initialMessages);\n    const [inputText, setInputText] = useState(\"\");\n    const [currentUser, setCurrentUser] = useState<User | null>(null);\n    const [socket, setSocket] = useState<Socket | null>(null);\n    const messagesEndRef = useRef<HTMLDivElement>(null);\n\n    // 1. Initialize User (Client-side simulation or fetch from Auth)\n    useEffect(() => {\n        // In a real app, you'd get this from useSession() (Better-auth)\n        // For now, let's look for session storage or generate a temp one\n        const savedUser = sessionStorage.getItem('chat_user');\n        if (savedUser) {\n            setCurrentUser(JSON.parse(savedUser));\n        } else {\n            // Temporary: redirect to a login/setup selection if strictly needed\n            // Or generate a random one for demo purpose\n        }\n    }, []);\n\n    // 2. Connect Socket\n    useEffect(() => {\n        if (!currentUser) return;\n\n        // Connect to the socket server (could be the same Next.js server if custom, or external)\n        // For now, using API_BASE_URL\n        const newSocket = io(API_BASE_URL || undefined, {\n            query: {\n                tenantSlug: tenant.slug,\n                userId: currentUser.id\n            }\n        });\n\n        setSocket(newSocket);\n\n        newSocket.on('connect', () => {\n            console.log(\"Socket connected\");\n            newSocket.emit('join', { user: currentUser, tenantSlug: tenant.slug });\n        });\n\n        newSocket.on('newMessage', (msg: Message) => {\n            setMessages(prev => {\n                if (prev.some(m => m.id === msg.id)) return prev;\n                return [...prev, msg];\n            });\n        });\n\n        return () => {\n            newSocket.disconnect();\n        }\n    }, [currentUser, tenant.slug]);\n\n    // 3. Scroll to bottom\n    useEffect(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n    }, [messages]);\n\n    // 4. Send Message (Hybrid: Server Action + Optimistic UI)\n    const handleSendMessage = async (e: React.FormEvent) => {\n        e.preventDefault();\n        if (!inputText.trim() || !currentUser) return;\n\n        const content = inputText.trim();\n        setInputText(\"\"); // Clear input immediately\n\n        // Optimistic Update\n        const tempId = Date.now().toString();\n        const optimisticMsg: Message = {\n            id: tempId,\n            text: content,\n            senderId: currentUser.id,\n            senderAlias: currentUser.alias,\n            senderGender: currentUser.gender,\n            timestamp: new Date().toISOString()\n        };\n        setMessages(prev => [...prev, optimisticMsg]);\n\n        // Call Server Action\n        const formData = new FormData();\n        formData.append(\"content\", content);\n        formData.append(\"tenantId\", tenant.id);\n\n        // Note: Server Action validates session implicitly\n        const result = await sendMessageAction(formData);\n\n        if (!result.success) {\n            console.error(\"Message failed:\", result.error);\n            // Rollback or show error\n        }\n    };\n\n    if (!currentUser) {\n        return <div className=\"p-10 text-center\">Loading User... (Or please login)</div>;\n    }\n\n    return (\n        <div className=\"flex flex-col w-full h-full max-w-3xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden\">\n            {/* Header */}\n            <header className=\"bg-emerald-600 text-white p-4 flex items-center justify-between shrink-0\">\n                <h1 className=\"font-bold text-lg\">{tenant.name}</h1>\n                <div className=\"text-xs opacity-80\">\n                    {messages.length} messages\n                </div>\n            </header>\n\n            {/* Message List */}\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50\">\n                {messages.map((msg) => {\n                    const isMe = msg.senderId === currentUser.id;\n                    return (\n                        <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>\n                            <div className={`max-w-[75%] rounded-lg p-3 ${isMe ? 'bg-emerald-500 text-white' : 'bg-white border border-gray-200 text-gray-800'\n                                }`}>\n                                {!isMe && <div className=\"text-xs font-bold mb-1 opacity-70\">{msg.senderAlias}</div>}\n                                <p className=\"text-sm dark:text-gray-100\">{msg.text}</p>\n                                <div className=\"text-[10px] opacity-50 text-right mt-1\">\n                                    {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                                </div>\n                            </div>\n                        </div>\n                    );\n                })}\n                <div ref={messagesEndRef} />\n            </div>\n\n            {/* Input Area */}\n            <form onSubmit={handleSendMessage} className=\"p-4 bg-white border-t border-gray-100 shrink-0\">\n                <div className=\"flex gap-2\">\n                    <input\n                        type=\"text\"\n                        value={inputText}\n                        onChange={e => setInputText(e.target.value)}\n                        placeholder=\"Scrivi un messaggio...\"\n                        className=\"flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                    />\n                    <button\n                        type=\"submit\"\n                        className=\"bg-emerald-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-emerald-700 transition\"\n                    >\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                            <path d=\"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z\" />\n                        </svg>\n                    </button>\n                </div>\n            </form>\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}}]
}