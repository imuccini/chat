{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/config.ts"],"sourcesContent":["import { Capacitor } from '@capacitor/core';\n\n// Detect if running natively (iOS or Android)\nconst isNative = Capacitor.isNativePlatform();\n\n// Use local IP for native (simulator/device) or empty string for web (proxy)\n// REPLACE '192.168.8.213' WITH YOUR COMPUTER'S LOCAL IP IF IT CHANGES\nexport const API_BASE_URL = isNative ? 'http://192.168.8.213:3000' : '';\n"],"names":[],"mappings":";;;;AAAA;;AAEA,8CAA8C;AAC9C,MAAM,WAAW,oKAAS,CAAC,gBAAgB;AAIpC,MAAM,eAAe,WAAW,8BAA8B"}},
    {"offset": {"line": 20, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivanmuccini/Apps/Antigravity/chat/chat/components/ChatInterface.tsx"],"sourcesContent":["'use client';\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport { io, Socket } from 'socket.io-client';\nimport { Tenant } from '@prisma/client';\nimport { User, Message } from '@/types';\nimport { sendMessageAction } from '@/app/actions/sendMessage';\nimport { API_BASE_URL } from '@/config';\n\ninterface ChatInterfaceProps {\n    tenant: Tenant;\n    initialMessages: Message[];\n}\n\nexport default function ChatInterface({ tenant, initialMessages }: ChatInterfaceProps) {\n    const [messages, setMessages] = useState<Message[]>(initialMessages);\n    const [inputText, setInputText] = useState(\"\");\n    const [currentUser, setCurrentUser] = useState<User | null>(null);\n    const [socket, setSocket] = useState<Socket | null>(null);\n    const messagesEndRef = useRef<HTMLDivElement>(null);\n\n    // Alias Setup State\n    const [alias, setAlias] = useState(\"\");\n    const [isSettingUp, setIsSettingUp] = useState(true);\n\n    // 1. Initialize User (Check localStorage for guest session)\n    useEffect(() => {\n        if (typeof window !== 'undefined') {\n            const savedUser = localStorage.getItem('chat_user');\n            if (savedUser) {\n                const user = JSON.parse(savedUser);\n                setCurrentUser(user);\n                setIsSettingUp(false);\n            } else {\n                setIsSettingUp(true);\n            }\n        }\n    }, []);\n\n    // 2. Connect Socket\n    useEffect(() => {\n        if (!currentUser) return;\n\n        // Connect to the socket server (Next.js custom server)\n        const newSocket = io(API_BASE_URL || undefined, {\n            query: {\n                tenantSlug: tenant.slug,\n                userId: currentUser.id\n            }\n        });\n\n        setSocket(newSocket);\n\n        newSocket.on('connect', () => {\n            console.log(\"Socket connected\");\n            newSocket.emit('join', { user: currentUser, tenantSlug: tenant.slug });\n        });\n\n        newSocket.on('newMessage', (msg: Message) => {\n            setMessages(prev => {\n                if (prev.some(m => m.id === msg.id)) return prev;\n                return [...prev, msg];\n            });\n        });\n\n        return () => {\n            newSocket.disconnect();\n        }\n    }, [currentUser, tenant.slug]);\n\n    // 3. Scroll to bottom\n    useEffect(() => {\n        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n    }, [messages]);\n\n    // Handle Alias Login\n    const handleJoin = (e: React.FormEvent) => {\n        e.preventDefault();\n        if (!alias.trim()) return;\n\n        const newUser: User = {\n            id: Date.now().toString(), // Helper ID for guest\n            alias: alias,\n            gender: 'other', // Default\n            joinedAt: Date.now()\n        };\n\n        if (typeof window !== 'undefined') {\n            localStorage.setItem('chat_user', JSON.stringify(newUser));\n        }\n        setCurrentUser(newUser);\n        setIsSettingUp(false);\n    };\n\n    // 4. Send Message (Hybrid: Server Action + Optimistic UI)\n    const handleSendMessage = async (e: React.FormEvent) => {\n        e.preventDefault();\n        if (!inputText.trim() || !currentUser) return;\n\n        const content = inputText.trim();\n        setInputText(\"\"); // Clear input immediately\n\n        // Optimistic Update\n        const tempId = Date.now().toString();\n        const optimisticMsg: Message = {\n            id: tempId,\n            text: content,\n            senderId: currentUser.id,\n            senderAlias: currentUser.alias,\n            senderGender: currentUser.gender,\n            timestamp: new Date().toISOString()\n        };\n        setMessages(prev => [...prev, optimisticMsg]);\n\n        // Emit via Socket directly for guest persistence (relies on server.js handling)\n        socket?.emit('sendMessage', {\n            ...optimisticMsg,\n            tenantSlug: tenant.slug\n        });\n    };\n\n\n    if (isSettingUp) {\n        return (\n            <div className=\"flex flex-col items-center justify-center min-h-screen bg-gray-50 px-4\">\n                <div className=\"w-full max-w-md bg-white p-8 rounded-lg shadow-md\">\n                    <h1 className=\"text-2xl font-bold mb-6 text-center text-emerald-700\">{tenant.name}</h1>\n                    <p className=\"mb-4 text-center text-gray-600\">Inserisci il tuo nome per entrare in chat</p>\n                    <form onSubmit={handleJoin} className=\"space-y-4\">\n                        <input\n                            type=\"text\"\n                            value={alias}\n                            onChange={(e) => setAlias(e.target.value)}\n                            placeholder=\"Il tuo nome...\"\n                            className=\"w-full px-4 py-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none\"\n                            autoFocus\n                        />\n                        <button\n                            type=\"submit\"\n                            className=\"w-full bg-emerald-600 text-white py-2 rounded hover:bg-emerald-700 transition font-bold\"\n                            disabled={!alias.trim()}\n                        >\n                            Entra in Chat\n                        </button>\n                    </form>\n                </div>\n            </div>\n        );\n    }\n\n    if (!currentUser) return null;\n\n    return (\n        <div className=\"flex flex-col w-full h-[100dvh] max-w-3xl mx-auto bg-white shadow-xl overflow-hidden\">\n            {/* Header */}\n            <header className=\"bg-emerald-600 text-white p-4 flex items-center justify-between shrink-0 shadow-sm z-10\">\n                <h1 className=\"font-bold text-lg truncate\">{tenant.name}</h1>\n                <div className=\"text-xs opacity-80 whitespace-nowrap ml-2\">\n                    {currentUser.alias}\n                </div>\n            </header>\n\n            {/* Message List */}\n            <div className=\"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50\">\n                {messages.map((msg) => {\n                    const isMe = msg.senderId === currentUser.id;\n                    return (\n                        <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>\n                            <div className={`max-w-[75%] rounded-2xl px-4 py-2 shadow-sm ${isMe\n                                ? 'bg-emerald-500 text-white rounded-tr-none'\n                                : 'bg-white border border-gray-100 text-gray-800 rounded-tl-none'\n                                }`}>\n                                {!isMe && <div className=\"text-[10px] font-bold mb-1 opacity-60 uppercase tracking-wide\">{msg.senderAlias}</div>}\n                                <p className=\"text-sm leading-relaxed whitespace-pre-wrap\">{msg.text}</p>\n                                <div className={`text-[9px] text-right mt-1 ${isMe ? 'text-emerald-100' : 'text-gray-400'}`}>\n                                    {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                                </div>\n                            </div>\n                        </div>\n                    );\n                })}\n                <div ref={messagesEndRef} />\n            </div>\n\n            {/* Input Area */}\n            <form onSubmit={handleSendMessage} className=\"p-3 bg-white border-t border-gray-100 shrink-0 mb-safe\">\n                <div className=\"flex gap-2 items-center\">\n                    <input\n                        type=\"text\"\n                        value={inputText}\n                        onChange={e => setInputText(e.target.value)}\n                        placeholder=\"Scrivi un messaggio...\"\n                        className=\"flex-1 px-4 py-3 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-gray-50\"\n                    />\n                    <button\n                        type=\"submit\"\n                        disabled={!inputText.trim()}\n                        className=\"bg-emerald-600 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-emerald-700 transition disabled:opacity-50 disabled:hover:bg-emerald-600 shadow-sm\"\n                    >\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 transform translate-x-0.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                            <path d=\"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z\" />\n                        </svg>\n                    </button>\n                </div>\n            </form>\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}}]
}