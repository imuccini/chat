import { readFileSync, writeFileSync, existsSync } from 'fs';
import { resolve } from 'path';

const gradleFile = resolve(process.cwd(), 'android/capacitor.settings.gradle');

if (!existsSync(gradleFile)) {
    console.log('âš ï¸  android/capacitor.settings.gradle not found. Skipping fix.');
    process.exit(0);
}

let content = readFileSync(gradleFile, 'utf8');

// The incorrect path generated by Capacitor CLI in monorepos for this plugin
const oldPath = "('../node_modules/@capacitor-community/sqlite/android')";
// The correct path pointing to root node_modules (../../node_modules)
// Note: We need to go up 3 levels from android/app/ (where gradle runs?) 
// actually capacitor.settings.gradle is in android/ 
// defaults are '../node_modules' (app root)
// root is '../../../node_modules' (app root -> apps -> web -> root)
const newPath = "('../../../node_modules/@capacitor-community/sqlite/android')";

if (content.includes(oldPath)) {
    console.log('ðŸ”§ Fixing @capacitor-community/sqlite path in android/capacitor.settings.gradle...');
    content = content.replace(oldPath, newPath);
    writeFileSync(gradleFile, content, 'utf8');
    console.log('âœ… Path corrected.');
} else {
    console.log('âœ… @capacitor-community/sqlite path appears correct or already fixed.');
}
